# Hollon-AI: Multi-Agent System SSOT (Single Source of Truth)

> 이 문서는 Hollon-AI 시스템의 개념적 설계를 정의합니다.
> 구체적인 구현(DB 스키마, TypeScript 코드 등)은 [blueprint.md](./blueprint.md)를 참조하세요.

---

## 1. 프로젝트 개요

### 1.1 비전

재귀적 멀티 에이전트 시스템. 회사 조직 구조처럼 동작하는 에이전트들이 계층적으로 협업하여 복잡한 작업을 수행한다.

### 1.2 핵심 개념

**Hollon(홀론)**: 전체이자 부분인 자율적 에이전트 단위
- 그 자체로 완전한 에이전트이면서 동시에 상위 시스템의 부분
- Arthur Koestler의 홀라키(Holarchy) 개념에서 영감
- 각 홀론은 Brain Provider(Claude Code 등)를 통해 실행됨

**Organization(조직)**: 홀론들의 최상위 컨테이너
- 워크스페이스 역할
- 리소스 제한 및 설정 관리
- 복수의 프로젝트 포함 가능

---

## 2. 시스템 아키텍처

### 2.1 전체 구조

```
┌─────────────────────────────────────────────────────────────┐
│                      Web UI (Next.js)                       │
│    - 조직도 시각화 (Argo CD 스타일)                          │
│    - 홀론 상태 모니터링                                      │
│    - 대화 인터페이스                                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Backend Server (Node.js)                 │
│    - 홀론 프로세스 관리                                      │
│    - 메시지 라우팅                                           │
│    - WebSocket 실시간 업데이트                               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   PostgreSQL (Data Layer)                   │
│    - 홀론 상태 및 메타데이터                                 │
│    - 대화 히스토리                                           │
│    - 메시지 큐 (LISTEN/NOTIFY)                               │
│    - 프로젝트/태스크 관리                                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                 Brain Providers (Holons)                    │
│    - 각 홀론 = 독립 프로세스 또는 API 호출                    │
│    - Claude Code, Gemini CLI, Claude API 등                  │
│    - DB 접근을 위한 API 엔드포인트 활용                       │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 디렉토리 구조

```
hollon-ai/
├── apps/
│   ├── web/                    # Next.js 웹 UI
│   └── server/                 # 백엔드 서버
├── packages/
│   ├── core/                   # 핵심 타입 및 유틸리티
│   ├── db/                     # 데이터베이스 스키마 공유
│   ├── shared/                 # 공유 로직
│   └── ui/                     # 공유 UI 컴포넌트
├── docker/
│   └── docker-compose.yml      # PostgreSQL + 앱 컨테이너
└── docs/
    ├── ssot.md                 # 개념적 설계 (이 문서)
    └── blueprint.md            # 구체적 구현 명세
```

---

## 3. 핵심 엔티티

### 3.1 데이터 모델 개요

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Organization                                    │
└─────────────────────────────────────────────────────────────────────────────┘
       │              │              │              │              │
       ▼              ▼              ▼              ▼              ▼
┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐
│   Role    │  │   Team    │  │  Project  │  │  Channel  │  │ Document  │
└───────────┘  └───────────┘  └───────────┘  └───────────┘  └───────────┘
       │              │              │              │              │
       ▼              ▼              ▼              ▼              │
┌───────────────────────────────────────────────────────────────┐ │
│                          Hollon                                │◄┘
│  (self-ref: parent_id for hierarchy)                          │
└───────────────────────────────────────────────────────────────┘
       │                             │
       ▼                             ▼
┌───────────┐                 ┌───────────┐
│  Message  │                 │   Task    │ (self-ref: parent_id)
└───────────┘                 └───────────┘
```

### 3.2 엔티티 설명

| 엔티티 | 설명 | 회사 비유 |
|--------|------|----------|
| **Organization** | 최상위 컨테이너. 비용/리소스 제한 관리 | 회사 |
| **Role** | 역할 템플릿 (시스템 프롬프트, 권한, 자율성 수준 정의) | 직무 기술서 |
| **Team** | 홀론들의 그룹. 계층 구조 지원 | 부서/팀 |
| **Hollon** | Role 기반 에이전트 인스턴스. 영구/임시 생명주기 | 직원 |
| **Project** | 목표 달성을 위한 작업 묶음 | 프로젝트 |
| **Task** | 재귀적 작업 단위 (Sub-task 지원) | Linear 이슈 |
| **Milestone** | 프로젝트의 중요 이정표 | 마일스톤 |
| **Cycle** | 시간 기반 작업 단위. 예산 추적 포함 | 스프린트 |
| **Channel** | 그룹 커뮤니케이션 공간. 스레드 지원 | Slack 채널 |
| **Document** | Markdown 기반 문서. 재귀적 폴더 구조. 버전 관리 | Wiki/Notion |
| **Message** | 홀론 간 1:1 커뮤니케이션 | DM |

### 3.3 Role (역할 템플릿)

Role은 홀론이 가질 수 있는 역할을 정의하는 템플릿:

- **시스템 프롬프트**: 역할 정의 및 행동 지침
- **권한(Capabilities)**: 허용된 능력 목록
- **의사결정 영역(Decision Domains)**: 최종 결정권을 가지는 영역
- **자율성 수준(Autonomy Level)**: low / medium / high
- **Brain Provider 설정**: 기본으로 사용할 AI 백엔드

**예시 역할:**
- CTO: 기술 전략 수립, 기술팀 총괄, 높은 자율성
- 백엔드 엔지니어: API 개발, DB 설계, 코드 리뷰
- 프로젝트 매니저: 일정 관리, 리소스 조율, 보고

### 3.4 Hollon (역할 인스턴스)

Hollon은 Role을 기반으로 생성된 실제 에이전트 인스턴스:

- **생명주기**: permanent(영구) 또는 temporary(임시)
- **상태**: idle / running / waiting / terminated / error
- **계층 구조**: parent_id를 통한 트리 구조
- **커스터마이징**: Role 설정을 개별 홀론에서 오버라이드 가능
- **Brain Provider 오버라이드**: 홀론별로 다른 AI 백엔드 지정 가능

---

## 4. Brain Provider 아키텍처

### 4.1 개념

홀론의 "두뇌"는 다양한 AI 백엔드를 지원하도록 추상화됩니다. CLI 도구와 API 모두 동일한 인터페이스로 사용 가능합니다.

```
┌─────────────────────────────────────────────────────────────────────┐
│                           Hollon                                     │
│                             │                                        │
│                    ┌────────┴────────┐                              │
│                    │  BrainProvider  │  ← 통합 추상화 계층           │
│                    └────────┬────────┘                              │
│         ┌──────────┬────────┼────────┬──────────┐                   │
│         ▼          ▼        ▼        ▼          ▼                   │
│   ┌──────────┐┌──────────┐┌──────────┐┌──────────┐┌──────────┐     │
│   │  Claude  ││  Gemini  ││  Cursor  ││  Claude  ││  Gemini  │     │
│   │   Code   ││   CLI    ││   CLI    ││   API    ││   API    │     │
│   └──────────┘└──────────┘└──────────┘└──────────┘└──────────┘     │
│   └────────── CLI 기반 (프로세스) ──────┘└─── API 기반 (HTTP) ───┘  │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 설계 원칙

- **통합 인터페이스**: 모든 Brain Provider는 동일한 `IBrainProvider` 인터페이스 구현
- **기본값**: Claude Code를 기본 Brain Provider로 사용
- **확장성**: 새로운 AI 백엔드 추가 시 인터페이스만 구현하면 됨
- **혼합 사용**: Organization / Role / Hollon 레벨에서 다른 Provider 지정 가능

### 4.3 지원 Provider

| Provider | 카테고리 | 코드실행 | 파일시스템 | 웹브라우징 | Context Window |
|----------|---------|---------|-----------|-----------|----------------|
| **claude-code** (기본) | CLI | ✅ | ✅ | ✅ | 200K |
| gemini-cli | CLI | ✅ | ✅ | ✅ | 1M |
| cursor-cli | CLI | ✅ | ✅ | ❌ | 128K |
| claude-api | API | ❌ | ❌ | ❌ | 200K |
| gemini-api | API | ❌ | ❌ | ❌ | 1M |
| openai-api | API | ❌ | ❌ | ❌ | 128K |

### 4.4 Provider 선택 우선순위

```
Hollon 설정 > Role 설정 > Organization 기본값 > Claude Code (시스템 기본)
```

---

## 5. 핵심 기능

### 5.1 작업 위임 및 분할

홀론은 받은 태스크를 분석하여 직접 수행하거나 서브 홀론에게 위임:

```
1. 홀론이 태스크 수신
   │
2. 복잡도 분석 (LLM 판단)
   ├── 예상 토큰 소모량
   ├── 필요한 도메인 지식
   ├── 예상 소요 시간
   └── 서브태스크 분할 가능성
   │
3. 분기 결정
   ├── 단순 작업 → 직접 수행
   ├── 복잡 작업 → 분할 제안 생성
   │
4. 중요 결정 시 사용자 승인 요청
   ├── 새 홀론 생성
   ├── 비용이 높은 작업
   └── 위험도 높은 작업
   │
5. 승인 후 실행
```

### 5.2 홀론 간 통신

PostgreSQL LISTEN/NOTIFY를 활용한 실시간 메시지 교환:

```
발신 홀론                       수신 홀론
    │                              │
    ├── API로 메시지 전송 ─────────┤
    │         │                    │
    │    DB INSERT 발생            │
    │         │                    │
    │    NOTIFY 트리거 실행        │
    │         │                    │
    │    Server가 LISTEN 중 ───────┤
    │         │                    │
    │    WebSocket으로 전달 ───────┤
    │                              │
    │ ◄─────── 응답 (역방향) ──────┤
```

### 5.3 Human-in-the-Loop

사용자 승인이 필요한 액션:

| 액션 | 승인 필요 조건 |
|------|----------------|
| 새 홀론 생성 | 항상 |
| 영구 홀론 삭제 | 항상 |
| 외부 API 호출 | 설정에 따라 |
| 파일 시스템 수정 | 허용 경로 외 접근 시 |
| 높은 비용 작업 | 임계값 초과 시 |

### 5.4 비용 통제

- **Organization 레벨**: 일일/월간 비용 한도
- **Team 레벨**: 사이클별 예산 할당
- **Hollon 레벨**: 서브 홀론 생성 예산
- **시간대별 제한**: 업무시간/야간/주말별 동시 홀론 수 제한

### 5.5 자기 개선 시스템

- **사이클 회고**: 매 사이클 종료 시 자동 회고 생성
- **개선 제안**: 메트릭 분석 기반 프롬프트/프로세스 개선 제안
- **A/B 테스트**: 프롬프트, 모델, 프로세스 실험
- **프롬프트 버전 관리**: 변경 이력 및 성과 스냅샷 저장

---

## 6. 성과 측정 (Metrics)

### 6.1 측정 대상

- **홀론**: 태스크 완료율, 평균 완료 시간, 품질 점수, 비용 효율성
- **팀**: 벨로시티, 팀 건강도, 협업 지수
- **프로젝트**: 진행률, 예산 사용률, 마일스톤 달성률
- **사이클**: 목표 달성률, 번다운 차트

### 6.2 기본 메트릭

| 메트릭 | 유형 | 적용 대상 | 목표 방향 |
|--------|------|----------|----------|
| 태스크 완료율 | ratio | 홀론, 팀, 프로젝트 | higher |
| 사이클 벨로시티 | gauge | 팀, 프로젝트 | - |
| 평균 태스크 완료 시간 | duration | 홀론, 팀 | lower |
| 태스크당 평균 비용 | gauge | 홀론, 팀 | lower |

---

## 7. 웹 UI 설계

### 7.1 주요 화면

**조직도 뷰 (메인)**
- Argo CD 스타일의 노드 그래프
- 각 홀론을 노드로 표시
- 상태에 따른 색상 구분 (녹색: 실행 중, 파란색: 대기, 회색: 유휴, 빨간색: 오류)
- 계층 구조 시각화

**홀론 상세 뷰**
- 현재 작업 내용
- 대화 히스토리
- 할당된 태스크
- 자식 홀론 목록
- 실시간 로그 스트림

**프로젝트 관리 뷰**
- 프로젝트 목록
- 칸반 보드 스타일 태스크 관리
- 진행 상황 대시보드

**대화 인터페이스**
- 특정 홀론과의 1:1 대화
- 여러 홀론이 포함된 그룹 대화
- 명령어 전송 기능

---

## 8. MVP 구현 계획

### Phase 1: 코어 인프라
- 모노레포 설정 (pnpm workspace)
- TypeScript 설정
- 핵심 인터페이스 구현 (`packages/core`)
- Docker Compose 설정 (PostgreSQL)
- Drizzle ORM 스키마 정의

### Phase 2: 홀론 프로세스 관리
- Brain Provider 인터페이스 구현
- Claude Code Provider 구현 (기본)
- 홀론 생명주기 관리
- DB 기반 메시지 시스템

### Phase 3: 백엔드 API
- REST API 구현
- WebSocket 서버
- PostgreSQL 실시간 이벤트 연동

### Phase 4: 웹 UI
- Next.js 앱 설정
- 조직도 컴포넌트 (React Flow 활용)
- 홀론 상세 뷰
- 대화 인터페이스

### Phase 5: 통합 및 테스트
- 전체 시스템 통합
- E2E 테스트
- 문서화

---

## 9. 기술 스택

| 영역 | 기술 |
|------|------|
| **프론트엔드** | Next.js 14, React 18, TypeScript |
| **상태 관리** | Zustand 또는 Jotai |
| **시각화** | React Flow (조직도), Tailwind CSS |
| **백엔드** | Node.js, Express/Fastify |
| **실시간** | WebSocket + PostgreSQL LISTEN/NOTIFY |
| **데이터베이스** | PostgreSQL 16 |
| **ORM** | Drizzle ORM |
| **에이전트** | Claude Code (기본), Gemini CLI, API 등 |
| **컨테이너** | Docker, Docker Compose |
| **빌드** | pnpm, Turborepo |

---

## 10. 리스크 및 고려사항

### 10.1 기술적 리스크

| 리스크 | 영향 | 대응 |
|--------|------|------|
| Brain Provider 프로세스 불안정 | 높음 | 재시작 메커니즘, 상태 DB 저장 |
| DB 연결 풀 고갈 | 중간 | 커넥션 풀링, 제한 설정 |
| API 비용 급증 | 높음 | 동시성 제한, 비용 모니터링 |

### 10.2 보안 고려사항

- 홀론별 파일 시스템 접근 제한
- 데이터베이스 접근 권한 분리 (홀론은 API 통해서만 접근)
- API 키 암호화 저장
- SQL Injection 방지 (ORM 사용)

---

## 11. 용어 정리

| 용어 | 정의 | 회사 비유 |
|------|------|----------|
| **Organization** | 최상위 컨테이너 | 회사 |
| **Role** | 역할 템플릿 (시스템 프롬프트, 권한 정의) | 직무 기술서 |
| **Team** | 홀론들의 그룹 | 부서/팀 |
| **Hollon** | Role 기반 에이전트 인스턴스 | 직원 |
| **Sub-Hollon** | 영구 홀론이 생성하는 임시 홀론 | 임시 외주 |
| **Project** | 목표 달성을 위한 작업 묶음 | 프로젝트 |
| **Milestone** | 프로젝트의 중요 이정표 | 마일스톤 |
| **Cycle** | 시간 기반 작업 단위 | 스프린트 |
| **Task** | 재귀적 작업 단위 | Linear 이슈 |
| **Channel** | 그룹 커뮤니케이션 공간 | Slack 채널 |
| **Document** | Markdown 기반 문서 | Wiki 페이지 |
| **Message** | 1:1 커뮤니케이션 | DM |
| **Brain Provider** | 홀론의 AI 두뇌 추상화 | 직원의 전문성 |
| **Decision Domain** | 역할의 의사결정 권한 범위 | 결정 권한 |
| **Autonomy Level** | 역할의 자율성 수준 | 권한 위임 수준 |
| **Metric** | 성과 측정 지표 | KPI |
| **Action Policy** | 액션별 처리 방식 (승인/보고/자율) | 결재 규정 |

---

## 문서 참조

- **구체적 구현 명세**: [blueprint.md](./blueprint.md) - DB 스키마, TypeScript 코드, API 정의

---

## 변경 이력

| 날짜 | 버전 | 변경 내용 |
|------|------|----------|
| 2024-12-03 | 0.1.0 | 초기 문서 작성 |
| 2024-12-03 | 0.2.0 | PostgreSQL 기반으로 변경 |
| 2024-12-03 | 0.3.0 | Role 개념 추가 |
| 2024-12-03 | 0.4.0 | Team, Channel, Document, 재귀적 Task 추가 |
| 2024-12-03 | 0.5.0 | Milestone/Cycle 추가, Document 파일시스템 스타일 변경 |
| 2024-12-03 | 0.6.0 | 성과 측정(Metrics) 시스템 추가 |
| 2024-12-03 | 0.7.0 | 자기 개선 시스템, 비용 통제, A/B 테스트 추가 |
| 2024-12-04 | 0.8.0 | Brain Provider 아키텍처 추가 |
| 2024-12-04 | 0.9.0 | 문서 분리: 개념(ssot.md) / 구현(blueprint.md) |
