# Plan: Backend Engineering: 시스템 프롬프트 코드 관리 시스템 구축

## Task Information
- **Task ID**: 88d26681-c235-42ac-a718-af3cdfe29e46
- **Type**: team_epic
- **Created**: 2026-01-08T16:43:00.107Z
- **Team**: Backend Engineering

## Objective

기존 시드 데이터에 하드코딩된 시스템 프롬프트를 코드 기반 템플릿 시스템으로 전환하여 유지보수성과 버전 관리를 향상시킵니다. Role별 프롬프트 템플릿을 코드로 정의하고, DB 저장 커스텀 프롬프트와 병합하는 시스템을 구축합니다.

### 핵심 목표
1. **코드 기반 프롬프트 관리**: 시스템 프롬프트를 TypeScript 코드로 정의하여 Git 버전 관리 및 코드 리뷰 가능
2. **계층적 병합 시스템**: 기본 템플릿(코드) + 커스텀 프롬프트(DB) 병합 로직
3. **중앙 집중식 관리**: PromptTemplateRegistry를 통한 템플릿 조회 및 캐싱
4. **하위 호환성 유지**: 기존 Role/Hollon 서비스와 매끄럽게 통합

## Analysis

### Current State

#### 1. 현재 시스템 프롬프트 관리 방식
- **위치**: `apps/server/src/database/seed.ts`
- **문제점**:
  - 11개 Role의 시스템 프롬프트가 문자열 리터럴로 하드코딩됨 (예: CTO, TechLead, BackendEngineer, etc.)
  - 프롬프트 변경 시 seed.ts 수정 후 재실행 필요
  - Git 이력 추적 어려움 (대형 seed 파일 내 일부분)
  - 변수 치환 로직 없음
  - 버전 관리 불가능
  - 중복 패턴 다수 존재

#### 2. 현재 Entity 구조
```typescript
// Role Entity
@Entity('roles')
export class Role {
  name: string;
  description: string;
  capabilities: string[];
  systemPrompt: string | null;  // 현재는 nullable
  availableForTemporaryHollon: boolean;
  organizationId: string;
}

// Hollon Entity
@Entity('hollons')
export class Hollon {
  name: string;
  roleId: string;
  systemPrompt: string | null;  // Role 기본값 오버라이드 가능
  brainProviderId: string;
  organizationId: string;
  teamId: string | null;
}
```

#### 3. 현재 서비스 구조
- **RoleService**: Role CRUD, systemPrompt는 DB에서 직접 조회
- **HollonService**: Hollon CRUD, systemPrompt 병합 로직 없음
- **시드 데이터**: 모든 Role에 대해 systemPrompt 직접 정의

### Codebase Impact

#### Files to Create

**핵심 모듈 구조** (`apps/server/src/modules/prompt-templates/`)
```
prompt-templates/
├── prompt-template.module.ts
├── interfaces/
│   └── prompt-template.interface.ts
├── templates/
│   ├── base/
│   │   └── base.template.ts
│   └── roles/
│       ├── cto.template.ts
│       ├── tech-lead.template.ts
│       ├── backend-engineer.template.ts
│       ├── junior-backend-engineer.template.ts
│       ├── ml-engineer.template.ts
│       ├── data-engineer.template.ts
│       ├── frontend-engineer.template.ts
│       ├── qa-engineer.template.ts
│       ├── planning-specialist.template.ts
│       ├── implementation-specialist.template.ts
│       ├── testing-specialist.template.ts
│       └── integration-specialist.template.ts
├── services/
│   ├── prompt-template-registry.service.ts
│   ├── prompt-merge.service.ts
│   ├── prompt-validation.service.ts
│   └── prompt-version.service.ts
├── dtos/
│   ├── create-prompt-template.dto.ts
│   ├── update-prompt-template.dto.ts
│   └── prompt-template-response.dto.ts
├── controllers/
│   └── prompt-template.controller.ts
└── __tests__/
    ├── prompt-template-registry.service.spec.ts
    ├── prompt-merge.service.spec.ts
    └── prompt-template.controller.spec.ts
```

**테스트 파일**
- `apps/server/src/modules/prompt-templates/__tests__/*.spec.ts`
- `apps/server/test/e2e/prompt-template-integration.e2e-spec.ts`

**문서**
- `docs/prompt-template-system.md`

#### Files to Modify

1. **apps/server/src/database/seed.ts**
   - 모든 Role의 systemPrompt 필드 제거 또는 null로 설정
   - 기본 프롬프트는 코드 템플릿에서 가져오도록 변경

2. **apps/server/src/modules/role/role.service.ts**
   - PromptMergeService 주입
   - systemPrompt 조회 시 템플릿 시스템 사용

3. **apps/server/src/modules/hollon/hollon.service.ts**
   - PromptMergeService 주입
   - Hollon 생성/업데이트 시 프롬프트 병합 로직 추가

4. **apps/server/src/modules/role/role.module.ts**
   - PromptTemplateModule import 추가

5. **apps/server/src/modules/hollon/hollon.module.ts**
   - PromptTemplateModule import 추가

6. **apps/server/src/app.module.ts**
   - PromptTemplateModule 등록

#### Dependencies Affected

**새 의존성 (없음)**
- 기존 NestJS, TypeORM, class-validator 사용

**영향받는 모듈**
- `RoleModule`: 프롬프트 조회 로직 변경
- `HollonModule`: 프롬프트 병합 로직 추가
- `BrainProviderModule`: 최종 프롬프트 사용 (변경 없음, 하위 호환)

### Technical Approach

#### 1. 아키텍처 설계

**계층 구조**
```
┌─────────────────────────────────────────┐
│  RoleService / HollonService            │
│  (기존 서비스 - 프롬프트 요청)           │
└────────────┬────────────────────────────┘
             │
             v
┌─────────────────────────────────────────┐
│  PromptMergeService                     │
│  (병합 로직 - 우선순위 처리)             │
└────────────┬────────────────────────────┘
             │
       ┌─────┴─────┐
       v           v
┌──────────┐  ┌──────────┐
│ Template │  │ Database │
│ Registry │  │ (Custom) │
└──────────┘  └──────────┘
```

**병합 우선순위**
1. Hollon.systemPrompt (개별 커스텀)
2. Role.systemPrompt (역할 커스텀)
3. Code Template (기본값)

#### 2. 인터페이스 설계

```typescript
// interfaces/prompt-template.interface.ts

export enum RoleType {
  CTO = 'CTO',
  TECH_LEAD = 'TechnicalLead',
  BACKEND_ENGINEER = 'BackendEngineer',
  JUNIOR_BACKEND_ENGINEER = 'JuniorBackendEngineer',
  ML_ENGINEER = 'MLEngineer',
  DATA_ENGINEER = 'DataEngineer',
  FRONTEND_ENGINEER = 'FrontendEngineer',
  QA_ENGINEER = 'QAEngineer',
  PLANNING_SPECIALIST = 'PlanningSpecialist',
  IMPLEMENTATION_SPECIALIST = 'ImplementationSpecialist',
  TESTING_SPECIALIST = 'TestingSpecialist',
  INTEGRATION_SPECIALIST = 'IntegrationSpecialist',
}

export interface IPromptVariable {
  key: string;
  description: string;
  defaultValue?: string;
  required: boolean;
}

export interface IPromptTemplate {
  roleType: RoleType;
  roleName: string;
  version: string;
  template: string;
  variables: IPromptVariable[];

  // 변수 치환 메서드
  render(variables: Record<string, string>): string;
}

export interface IPromptMergeOptions {
  hollonId?: string;
  roleId: string;
  customVariables?: Record<string, string>;
  preferDbValue?: boolean; // true: DB 우선, false: 템플릿 우선
}
```

#### 3. 템플릿 구조 예시

```typescript
// templates/roles/cto.template.ts

import { IPromptTemplate, RoleType } from '../../interfaces/prompt-template.interface';

export class CTOPromptTemplate implements IPromptTemplate {
  roleType = RoleType.CTO;
  roleName = 'CTO-Zeus';
  version = '1.0.0';

  variables = [
    {
      key: 'organizationName',
      description: '조직 이름',
      defaultValue: 'Hollon-AI',
      required: true,
    },
    {
      key: 'maxConcurrentTasks',
      description: '동시 처리 가능 태스크 수',
      defaultValue: '3',
      required: false,
    },
  ];

  template = `당신은 {{organizationName}}의 CTO입니다.

**Planning 워크플로우 (Phase 4.2):**
- Goal을 Team Epic으로 분해하면 각 Team Epic은 Planning 단계를 거침
- Planning에서 계획 문서가 자동 생성되고 PR로 제출되어 사람이 리뷰함
- 사람이 PR을 승인해야만 Team Epic이 Implementation Tasks로 분해됨

**지침:**
- Goal을 받으면 팀별 Team Epic으로 분해
- 각 팀의 매니저에게 Team Epic 할당
- 전체 아키텍처 방향성 결정
- 팀 간 조정 및 협업 촉진

**동시 처리 제한:** 최대 {{maxConcurrentTasks}}개 태스크`;

  render(variables: Record<string, string>): string {
    let result = this.template;

    // 변수 치환 로직
    for (const variable of this.variables) {
      const value = variables[variable.key] || variable.defaultValue || '';
      const regex = new RegExp(`{{${variable.key}}}`, 'g');
      result = result.replace(regex, value);
    }

    return result;
  }
}
```

#### 4. PromptMergeService 로직

```typescript
// services/prompt-merge.service.ts

@Injectable()
export class PromptMergeService {
  constructor(
    private readonly registry: PromptTemplateRegistry,
    private readonly roleRepo: Repository<Role>,
    private readonly hollonRepo: Repository<Hollon>,
  ) {}

  async getMergedPrompt(options: IPromptMergeOptions): Promise<string> {
    // 1. 코드 템플릿 조회
    const template = await this.registry.getTemplateByRole(options.roleId);

    // 2. DB 커스텀 프롬프트 조회
    const role = await this.roleRepo.findOne({ where: { id: options.roleId } });
    let customPrompt = role?.systemPrompt;

    // 3. Hollon 개별 커스텀 프롬프트 조회 (우선순위 최상위)
    if (options.hollonId) {
      const hollon = await this.hollonRepo.findOne({ where: { id: options.hollonId } });
      if (hollon?.systemPrompt) {
        customPrompt = hollon.systemPrompt;
      }
    }

    // 4. 병합 로직
    if (customPrompt && options.preferDbValue) {
      return customPrompt; // DB 값 우선
    }

    // 5. 변수 치환 후 반환
    const variables = options.customVariables || {};
    return template.render(variables);
  }
}
```

#### 5. Migration 전략

**단계적 마이그레이션 (Zero Downtime)**

1. **Phase 1: 템플릿 시스템 구축** (기존 시스템과 병행)
   - PromptTemplateModule 구현
   - 모든 Role 템플릿 작성
   - 단위 테스트 작성

2. **Phase 2: 병합 서비스 통합** (Feature Flag)
   - RoleService/HollonService 수정
   - 환경 변수로 활성화 제어: `USE_PROMPT_TEMPLATES=false` (기본값)
   - 통합 테스트 작성

3. **Phase 3: 점진적 활성화**
   - `USE_PROMPT_TEMPLATES=true` 설정
   - 프로덕션 모니터링
   - 문제 발생 시 즉시 롤백 가능

4. **Phase 4: 시드 데이터 정리**
   - seed.ts에서 systemPrompt 제거
   - DB 마이그레이션 없이 적용 (nullable 필드)

### Risks and Mitigations

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| **프롬프트 내용 불일치** | High | Medium | - 시드 데이터에서 추출한 원본과 템플릿 코드 1:1 비교 테스트<br>- E2E 테스트로 최종 프롬프트 검증<br>- 코드 리뷰 시 프롬프트 내용 확인 |
| **기존 Hollon 동작 변경** | High | Low | - 하위 호환성 유지 (DB 값 우선 옵션)<br>- Feature Flag로 단계적 적용<br>- 롤백 계획 수립 (환경 변수만 변경) |
| **성능 저하** | Medium | Low | - PromptTemplateRegistry에 메모리 캐싱<br>- 조회 로직 최적화 (단일 쿼리)<br>- 성능 벤치마크 테스트 |
| **변수 치환 오류** | Medium | Medium | - 변수 검증 로직 (PromptValidationService)<br>- 필수 변수 누락 감지<br>- 단위 테스트로 모든 변수 케이스 검증 |
| **버전 충돌** | Low | Low | - 시맨틱 버저닝 적용<br>- 버전 히스토리 기록 (PromptVersionService)<br>- 마이그레이션 가이드 문서화 |
| **팀 학습 곡선** | Low | Medium | - 상세한 문서 작성 (README, API 문서)<br>- 새 Role 추가 가이드<br>- 예제 템플릿 제공 |

## Decomposition

### Implementation Phases

이 Team Epic은 26개의 work items로 구성되어 있으며, 아래와 같이 5개의 주요 Phase로 분해됩니다:

---

### Phase 1: 기초 인프라 구축 (P1 - Critical Path)

**목표**: 템플릿 시스템의 핵심 구조 및 타입 정의

#### 1.1 프롬프트 템플릿 모듈 디렉토리 구조 설계 및 생성
- **Description**: `apps/server/src/modules/prompt-templates/` 디렉토리를 생성하고 templates/, services/, dtos/, interfaces/ 등의 하위 구조를 설계합니다.
- **Assignee**: Senior Backend Engineer (TypeScript, NestJS 숙련)
- **Files to Create**:
  - `apps/server/src/modules/prompt-templates/prompt-template.module.ts`
  - `apps/server/src/modules/prompt-templates/README.md`
  - Directory structure (templates/, services/, dtos/, interfaces/)
- **Acceptance Criteria**:
  - [ ] `apps/server/src/modules/prompt-templates/` 디렉토리가 생성됨
  - [ ] templates/, services/, dtos/, interfaces/ 하위 디렉토리 구조가 존재함
  - [ ] README.md에 모듈 구조와 사용 방법이 문서화됨
- **Estimated Effort**: 2-3 hours

#### 1.2 프롬프트 템플릿 인터페이스 및 타입 정의
- **Description**: IPromptTemplate, IRoleTemplate, IPromptVariable 등의 인터페이스를 정의합니다. Role 타입, 프롬프트 버전 관리, 변수 치환을 위한 타입 시스템을 구축합니다.
- **Assignee**: Senior Backend Engineer
- **Files to Create**:
  - `interfaces/prompt-template.interface.ts`
  - `interfaces/prompt-merge-options.interface.ts`
  - `interfaces/prompt-variable.interface.ts`
- **Dependencies**: 1.1 완료 후
- **Acceptance Criteria**:
  - [ ] interfaces/prompt-template.interface.ts 파일이 존재하고 모든 필요한 인터페이스가 정의됨
  - [ ] Role 타입이 enum 또는 union type으로 정의됨
  - [ ] 버전 관리를 위한 version 필드가 인터페이스에 포함됨
  - [ ] 변수 치환을 위한 타입 시스템이 구현됨
- **Estimated Effort**: 3-4 hours

#### 1.3 현재 시드 데이터에서 시스템 프롬프트 추출 및 분석
- **Description**: 기존 seed.ts 파일에서 Role별, Hollon별 systemPrompt를 추출하고 패턴을 분석합니다.
- **Assignee**: Junior Backend Engineer (문서화 담당)
- **Files to Create**:
  - `docs/prompt-template-system/prompt-analysis.md`
  - `docs/prompt-template-system/role-prompts-original.json` (백업)
- **Dependencies**: None (병렬 작업 가능)
- **Acceptance Criteria**:
  - [ ] 모든 systemPrompt가 추출되어 문서화됨
  - [ ] Role별 프롬프트 패턴이 분석되고 기록됨
  - [ ] 공통 변수와 Role 특화 변수가 식별됨
  - [ ] 분석 결과가 markdown 문서로 작성됨
- **Estimated Effort**: 4-5 hours

---

### Phase 2: Role 템플릿 구현 (P2 - Core Templates)

**목표**: 모든 Role의 프롬프트 템플릿을 코드로 구현

#### 2.1 CTO Role 기본 프롬프트 템플릿 구현
- **Description**: templates/roles/cto.template.ts 파일을 생성하고 CTO Role의 기본 시스템 프롬프트를 코드로 작성합니다.
- **Assignee**: Senior Backend Engineer
- **Files to Create**: `templates/roles/cto.template.ts`
- **Dependencies**: 1.2 완료 후
- **Acceptance Criteria**:
  - [ ] templates/roles/cto.template.ts 파일이 존재함
  - [ ] CTO 프롬프트가 IPromptTemplate 인터페이스를 구현함
  - [ ] 변수 치환이 정상 작동함
  - [ ] 기존 시드 데이터의 CTO 프롬프트와 내용이 일치함
- **Estimated Effort**: 2-3 hours

#### 2.2 TechLead Role 기본 프롬프트 템플릿 구현
- **Description**: templates/roles/tech-lead.template.ts 파일을 생성하고 TechLead Role의 기본 시스템 프롬프트를 코드로 작성합니다.
- **Assignee**: Senior Backend Engineer
- **Files to Create**: `templates/roles/tech-lead.template.ts`
- **Dependencies**: 2.1 완료 후 (패턴 참고)
- **Acceptance Criteria**:
  - [ ] templates/roles/tech-lead.template.ts 파일이 존재함
  - [ ] TechLead 프롬프트가 IPromptTemplate 인터페이스를 구현함
  - [ ] 변수 치환이 정상 작동함
  - [ ] 기존 시드 데이터의 TechLead 프롬프트와 내용이 일치함
- **Estimated Effort**: 2-3 hours

#### 2.3-2.6 나머지 Role 프롬프트 템플릿 구현
- **Roles**: AILead, InfraLead, BackendEngineer, JuniorBackendEngineer, MLEngineer, DataEngineer, FrontendEngineer, QAEngineer, PlanningSpecialist, ImplementationSpecialist, TestingSpecialist, IntegrationSpecialist
- **Assignee**: Backend Engineers (병렬 작업 가능)
- **Dependencies**: 2.1 완료 후 (패턴 확립)
- **Files to Create**: 각 Role별 template 파일 (총 10개)
- **Acceptance Criteria** (공통):
  - [ ] 모든 Role에 대한 템플릿 파일이 존재함
  - [ ] 각 템플릿이 IPromptTemplate 인터페이스를 구현함
  - [ ] 기존 시드 데이터의 프롬프트와 내용이 일치함
- **Estimated Effort**: 1.5-2 hours per role (총 15-20 hours, 병렬 작업 시 단축)

---

### Phase 3: 서비스 계층 구현 (P1 - Core Logic)

**목표**: 템플릿 조회, 병합, 검증 서비스 구축

#### 3.1 프롬프트 템플릿 레지스트리 서비스 구현
- **Description**: PromptTemplateRegistry 서비스를 구현하여 모든 Role 템플릿을 등록하고 조회할 수 있는 중앙 관리 시스템을 만듭니다.
- **Assignee**: Senior Backend Engineer
- **Files to Create**:
  - `services/prompt-template-registry.service.ts`
  - `services/prompt-template-registry.service.spec.ts`
- **Dependencies**: Phase 2 완료 후
- **Acceptance Criteria**:
  - [ ] services/prompt-template-registry.service.ts 파일이 존재함
  - [ ] @Injectable() 데코레이터가 적용됨
  - [ ] getTemplateByRole() 메서드가 구현됨
  - [ ] 템플릿 캐싱이 구현됨
  - [ ] 버전 관리 로직이 포함됨
- **Estimated Effort**: 4-5 hours

#### 3.2 프롬프트 병합 서비스 구현
- **Description**: PromptMergeService를 구현하여 코드 템플릿과 DB에 저장된 커스텀 프롬프트를 병합하는 로직을 작성합니다.
- **Assignee**: Senior Backend Engineer
- **Files to Create**:
  - `services/prompt-merge.service.ts`
  - `services/prompt-merge.service.spec.ts`
- **Dependencies**: 3.1 완료 후
- **Acceptance Criteria**:
  - [ ] services/prompt-merge.service.ts 파일이 존재함
  - [ ] mergePrompts() 메서드가 구현됨
  - [ ] DB 값과 코드 템플릿 병합이 정상 작동함
  - [ ] 변수 치환 로직이 구현됨
  - [ ] 우선순위 규칙이 적용됨
- **Estimated Effort**: 5-6 hours

#### 3.3 프롬프트 템플릿 DTO 정의
- **Description**: CreatePromptTemplateDto, UpdatePromptTemplateDto, PromptTemplateResponseDto 등의 DTO를 정의하고 class-validator로 유효성 검증 규칙을 추가합니다.
- **Assignee**: Junior Backend Engineer
- **Files to Create**:
  - `dtos/create-prompt-template.dto.ts`
  - `dtos/update-prompt-template.dto.ts`
  - `dtos/prompt-template-response.dto.ts`
  - `dtos/prompt-preview.dto.ts`
- **Dependencies**: 1.2 완료 후
- **Acceptance Criteria**:
  - [ ] dtos/ 디렉토리에 모든 필요한 DTO가 정의됨
  - [ ] class-validator 데코레이터가 적용됨
  - [ ] IsString, IsEnum, IsOptional 등의 검증 규칙이 구현됨
  - [ ] 각 DTO가 해당 인터페이스를 구현하거나 확장함
- **Estimated Effort**: 3-4 hours

#### 3.4 프롬프트 템플릿 컨트롤러 구현
- **Description**: PromptTemplateController를 구현하여 템플릿 조회 API를 제공합니다.
- **Assignee**: Backend Engineer
- **Files to Create**:
  - `controllers/prompt-template.controller.ts`
  - `controllers/prompt-template.controller.spec.ts`
- **Dependencies**: 3.2, 3.3 완료 후
- **Acceptance Criteria**:
  - [ ] controllers/prompt-template.controller.ts 파일이 존재함
  - [ ] @Controller('prompt-templates') 데코레이터가 적용됨
  - [ ] GET 엔드포인트들이 구현됨
  - [ ] DTO 유효성 검증이 작동함
  - [ ] 응답이 PromptTemplateResponseDto 형식을 따름
- **Estimated Effort**: 4-5 hours

#### 3.5 프롬프트 템플릿 모듈 통합 및 등록
- **Description**: PromptTemplateModule을 생성하고 모든 서비스, 컨트롤러를 등록합니다.
- **Assignee**: Senior Backend Engineer
- **Files to Modify**:
  - `prompt-template.module.ts`
  - `apps/server/src/app.module.ts`
- **Dependencies**: 3.1-3.4 완료 후
- **Acceptance Criteria**:
  - [ ] prompt-template.module.ts 파일이 존재함
  - [ ] @Module 데코레이터에 모든 providers와 controllers가 등록됨
  - [ ] AppModule에 PromptTemplateModule이 import됨
  - [ ] 애플리케이션이 정상 실행됨
- **Estimated Effort**: 2-3 hours

---

### Phase 4: 기존 서비스 통합 (P1 - Integration)

**목표**: Role/Hollon 서비스에 새 프롬프트 시스템 통합

#### 4.1 Role 서비스에서 프롬프트 템플릿 서비스 통합
- **Description**: 기존 Role 관련 서비스(RoleService 등)를 수정하여 PromptMergeService를 사용하도록 변경합니다.
- **Assignee**: Senior Backend Engineer
- **Files to Modify**:
  - `apps/server/src/modules/role/role.service.ts`
  - `apps/server/src/modules/role/role.module.ts`
- **Dependencies**: 3.5 완료 후
- **Acceptance Criteria**:
  - [ ] RoleService가 PromptMergeService를 주입받음
  - [ ] 시스템 프롬프트 조회 시 새 서비스를 사용함
  - [ ] 하드코딩된 프롬프트가 제거됨
  - [ ] 기존 기능이 정상 작동함
- **Estimated Effort**: 3-4 hours

#### 4.2 Hollon 서비스에서 프롬프트 템플릿 서비스 통합
- **Description**: HollonService를 수정하여 Hollon의 systemPrompt를 가져올 때 PromptMergeService를 사용하도록 변경합니다.
- **Assignee**: Senior Backend Engineer
- **Files to Modify**:
  - `apps/server/src/modules/hollon/hollon.service.ts`
  - `apps/server/src/modules/hollon/hollon.module.ts`
- **Dependencies**: 4.1 완료 후
- **Acceptance Criteria**:
  - [ ] HollonService가 PromptMergeService를 주입받음
  - [ ] Hollon 생성 시 새 서비스를 통해 프롬프트를 가져옴
  - [ ] 기존 기능이 정상 작동함
  - [ ] Hollon 업데이트 시에도 새 시스템이 적용됨
- **Estimated Effort**: 3-4 hours

#### 4.3 시드 데이터에서 systemPrompt 필드 제거
- **Description**: seed.ts 파일에서 systemPrompt 필드를 제거하거나 null로 설정합니다.
- **Assignee**: Backend Engineer
- **Files to Modify**: `apps/server/src/database/seed.ts`
- **Dependencies**: 4.1, 4.2 완료 후
- **Acceptance Criteria**:
  - [ ] seed.ts에서 systemPrompt 필드가 제거되거나 null로 설정됨
  - [ ] 시드 실행이 정상 작동함
  - [ ] 생성된 Role/Hollon이 코드 템플릿에서 프롬프트를 가져옴
  - [ ] DB 마이그레이션 없이 변경사항이 적용됨
- **Estimated Effort**: 2-3 hours

---

### Phase 5: 고급 기능 및 테스트 (P3/P4 - Enhancement)

**목표**: 버전 관리, 검증, 캐싱 등 고급 기능 추가

#### 5.1 프롬프트 버전 관리 시스템 구현
- **Description**: 프롬프트 템플릿의 버전을 관리하는 시스템을 구축합니다.
- **Assignee**: Senior Backend Engineer
- **Priority**: P3
- **Files to Create**:
  - `services/prompt-version.service.ts`
  - `services/prompt-version.service.spec.ts`
- **Acceptance Criteria**:
  - [ ] PromptVersionService가 구현됨
  - [ ] 버전 히스토리가 기록됨
  - [ ] 특정 버전으로 롤백 가능함
  - [ ] 버전별 조회 API가 작동함
- **Estimated Effort**: 5-6 hours

#### 5.2 프롬프트 템플릿 미리보기 기능 구현
- **Description**: 변수가 치환된 최종 프롬프트를 미리 볼 수 있는 기능을 구현합니다.
- **Assignee**: Backend Engineer
- **Priority**: P3
- **Files to Modify**: `controllers/prompt-template.controller.ts`
- **Acceptance Criteria**:
  - [ ] GET /prompt-templates/preview 엔드포인트가 구현됨
  - [ ] 변수 치환이 정확하게 작동함
  - [ ] Role과 변수를 파라미터로 받음
  - [ ] 최종 프롬프트가 응답으로 반환됨
- **Estimated Effort**: 2-3 hours

#### 5.3 프롬프트 템플릿 유효성 검증 로직 구현
- **Description**: 프롬프트 템플릿의 구조, 변수, 포맷을 검증하는 로직을 구현합니다.
- **Assignee**: Backend Engineer
- **Priority**: P3
- **Files to Create**:
  - `services/prompt-validation.service.ts`
  - `services/prompt-validation.service.spec.ts`
- **Acceptance Criteria**:
  - [ ] PromptValidationService가 구현됨
  - [ ] 필수 변수 누락 감지가 작동함
  - [ ] 잘못된 변수 참조가 감지됨
  - [ ] 검증 에러 메시지가 명확함
- **Estimated Effort**: 3-4 hours

#### 5.4 단위 테스트 - 프롬프트 템플릿 서비스
- **Description**: PromptTemplateRegistry, PromptMergeService의 단위 테스트를 작성합니다.
- **Assignee**: QA Engineer / Junior Backend Engineer
- **Priority**: P2
- **Files to Create/Modify**: `__tests__/*.spec.ts` (이미 생성됨, 테스트 케이스 추가)
- **Dependencies**: Phase 3 완료 후
- **Acceptance Criteria**:
  - [ ] *.spec.ts 파일이 존재함
  - [ ] 테스트 커버리지가 80% 이상임
  - [ ] 모든 핵심 로직이 테스트됨
  - [ ] 테스트가 통과함
- **Estimated Effort**: 6-8 hours

#### 5.5 단위 테스트 - 프롬프트 템플릿 컨트롤러
- **Description**: PromptTemplateController의 단위 테스트를 작성합니다.
- **Assignee**: QA Engineer / Junior Backend Engineer
- **Priority**: P2
- **Dependencies**: 3.4 완료 후
- **Acceptance Criteria**:
  - [ ] prompt-template.controller.spec.ts 파일이 존재함
  - [ ] 모든 엔드포인트가 테스트됨
  - [ ] DTO 검증 로직이 테스트됨
  - [ ] 테스트가 통과함
- **Estimated Effort**: 4-5 hours

#### 5.6 통합 테스트 - Role과 Hollon 프롬프트 통합
- **Description**: Role과 Hollon 서비스가 새 프롬프트 시스템과 정상적으로 통합되었는지 E2E 테스트를 작성합니다.
- **Assignee**: QA Engineer
- **Priority**: P2
- **Files to Create**: `apps/server/test/e2e/prompt-template-integration.e2e-spec.ts`
- **Dependencies**: Phase 4 완료 후
- **Acceptance Criteria**:
  - [ ] E2E 테스트 파일이 존재함
  - [ ] Role 생성 플로우가 테스트됨
  - [ ] Hollon 생성 플로우가 테스트됨
  - [ ] 프롬프트 병합이 정상 작동함
  - [ ] 테스트가 통과함
- **Estimated Effort**: 6-8 hours

#### 5.7 프롬프트 템플릿 관리 문서 작성
- **Description**: 프롬프트 템플릿 시스템의 사용 방법, 아키텍처, API 문서를 작성합니다.
- **Assignee**: Junior Backend Engineer / Technical Writer
- **Priority**: P3
- **Files to Create**: `docs/prompt-template-system.md`
- **Dependencies**: Phase 3, 4 완료 후
- **Acceptance Criteria**:
  - [ ] docs/prompt-template-system.md 파일이 존재함
  - [ ] 아키텍처 다이어그램이 포함됨
  - [ ] API 엔드포인트가 문서화됨
  - [ ] 새 Role 추가 가이드가 작성됨
  - [ ] 변수 사용 예시가 포함됨
- **Estimated Effort**: 6-8 hours

#### 5.8 성능 최적화 - 프롬프트 캐싱
- **Description**: 프롬프트 템플릿 조회 성능을 최적화하기 위해 캐싱 전략을 구현합니다.
- **Assignee**: Senior Backend Engineer
- **Priority**: P4
- **Files to Modify**: `services/prompt-template-registry.service.ts`
- **Dependencies**: 3.1 완료 후
- **Acceptance Criteria**:
  - [ ] 캐싱 로직이 구현됨
  - [ ] 캐시 무효화 전략이 정의됨
  - [ ] 조회 성능이 개선됨
  - [ ] 캐시 히트율이 모니터링됨
- **Estimated Effort**: 4-5 hours

#### 5.9 프롬프트 템플릿 변경 로깅 및 감사
- **Description**: 프롬프트 템플릿 변경 이력을 로깅하고 감사하는 시스템을 구현합니다.
- **Assignee**: Backend Engineer
- **Priority**: P4
- **Files to Create**:
  - `services/prompt-audit.service.ts`
  - Entity for audit logs (if needed)
- **Acceptance Criteria**:
  - [ ] 변경 이력이 DB에 저장됨
  - [ ] 사용자 정보가 기록됨
  - [ ] 변경 전후 내용이 저장됨
  - [ ] 감사 로그 조회 API가 구현됨
- **Estimated Effort**: 5-6 hours

#### 5.10 프로덕션 배포 및 모니터링 설정
- **Description**: 새 프롬프트 시스템을 프로덕션에 배포하고 모니터링을 설정합니다.
- **Assignee**: DevOps Engineer / Senior Backend Engineer
- **Priority**: P1 (최종 단계)
- **Files to Create/Modify**:
  - `.env.example` (환경 변수 추가)
  - CI/CD 설정 파일
  - 모니터링 대시보드 설정
- **Dependencies**: Phase 4 완료 후
- **Acceptance Criteria**:
  - [ ] 프로덕션 배포가 완료됨
  - [ ] 배포 후 검증이 수행됨
  - [ ] 로그 모니터링이 설정됨
  - [ ] 에러 알림이 작동함
  - [ ] 롤백 계획이 준비됨
- **Estimated Effort**: 4-6 hours

---

### Dependencies Graph

```
Phase 1 (기초)
├─ 1.1 디렉토리 구조 → 1.2 인터페이스
└─ 1.3 시드 분석 (독립)

Phase 2 (템플릿)
└─ 2.1 CTO → 2.2 TechLead → 2.3-2.6 나머지 Role (병렬)

Phase 3 (서비스)
├─ 3.1 Registry → 3.2 Merge
├─ 3.3 DTO (독립)
└─ 3.4 Controller → 3.5 Module 통합

Phase 4 (통합)
└─ 4.1 RoleService → 4.2 HollonService → 4.3 시드 정리

Phase 5 (고급/테스트)
├─ 5.1 버전 관리 (독립)
├─ 5.2 미리보기 (독립)
├─ 5.3 검증 (독립)
├─ 5.4 단위 테스트
├─ 5.5 컨트롤러 테스트
├─ 5.6 통합 테스트
├─ 5.7 문서 작성
├─ 5.8 캐싱 (독립)
├─ 5.9 감사 로그 (독립)
└─ 5.10 배포 (최종)
```

### Subtask Assignment Strategy

**Capability-based Matching**

| Task Type | Required Skills | Recommended Assignee |
|-----------|----------------|---------------------|
| 인프라 구축 (1.1, 1.2) | TypeScript, NestJS, Architecture | Senior Backend Engineer |
| 문서화 (1.3, 5.7) | Documentation, Analysis | Junior Backend Engineer |
| 템플릿 구현 (2.x) | TypeScript, Prompt Engineering | Backend Engineers (병렬) |
| 서비스 구현 (3.1, 3.2) | TypeScript, NestJS, DI | Senior Backend Engineer |
| DTO/Controller (3.3, 3.4) | TypeScript, NestJS, class-validator | Backend Engineer |
| 통합 작업 (4.x) | TypeScript, NestJS, Refactoring | Senior Backend Engineer |
| 테스트 작성 (5.4-5.6) | Jest, Testing, TDD | QA Engineer / Junior Backend Engineer |
| 고급 기능 (5.1-5.3, 5.8-5.9) | TypeScript, NestJS, Performance | Backend Engineers |
| 배포 (5.10) | DevOps, CI/CD, Monitoring | DevOps Engineer |

## Success Criteria

### Functional Requirements
- [ ] 모든 Role (11개)의 프롬프트 템플릿이 코드로 구현됨
- [ ] PromptMergeService가 DB 커스텀 프롬프트와 템플릿을 정상 병합함
- [ ] RoleService, HollonService가 새 시스템을 사용하여 프롬프트 조회
- [ ] 시드 데이터에서 systemPrompt 제거 완료
- [ ] 기존 Hollon들이 정상 작동함 (하위 호환성)

### Non-Functional Requirements
- [ ] 프롬프트 조회 성능이 기존 대비 저하되지 않음 (캐싱)
- [ ] 단위 테스트 커버리지 80% 이상
- [ ] E2E 테스트 통과 (Role/Hollon 생성 플로우)
- [ ] API 문서화 완료 (Swagger)
- [ ] 시스템 문서화 완료 (아키텍처, 사용 가이드)

### Quality Gates
- [ ] 모든 TypeScript 컴파일 에러 해결
- [ ] Lint 규칙 준수 (ESLint)
- [ ] 모든 테스트 통과 (npm test)
- [ ] 코드 리뷰 승인 (Senior Engineer)
- [ ] 프로덕션 배포 후 24시간 모니터링 완료

### Rollback Plan
- [ ] 환경 변수로 즉시 비활성화 가능 (`USE_PROMPT_TEMPLATES=false`)
- [ ] DB 변경사항 없음 (rollback migration 불필요)
- [ ] 이전 시드 데이터 백업 보관 (`.json` 파일)

---

## Implementation Timeline Estimate

| Phase | Estimated Effort | Critical Path |
|-------|------------------|---------------|
| Phase 1 | 9-12 hours | ✓ |
| Phase 2 | 20-25 hours | ✓ |
| Phase 3 | 20-25 hours | ✓ |
| Phase 4 | 8-11 hours | ✓ |
| Phase 5 | 40-50 hours | - |
| **Total** | **97-123 hours** | **57-73 hours (Critical)** |

**Notes:**
- Critical Path는 P1 작업만 포함 (Phase 1-4)
- Phase 5는 병렬 작업 가능 (P2-P4)
- 팀 크기 3-4명 가정 시: 약 2-3주 소요

---

## Appendix

### A. 변수 치환 예시

```typescript
// Input Template
template = "당신은 {{organizationName}}의 {{roleName}}입니다.";

// Variables
variables = {
  organizationName: "Hollon-AI",
  roleName: "CTO"
};

// Output
"당신은 Hollon-AI의 CTO입니다."
```

### B. API 엔드포인트 설계

```
GET    /prompt-templates/:roleId           # Role 템플릿 조회
GET    /prompt-templates/preview           # 변수 치환 미리보기
GET    /prompt-templates/versions/:roleId  # 버전 히스토리 조회
POST   /prompt-templates                   # 커스텀 템플릿 생성 (미래)
PATCH  /prompt-templates/:id               # 커스텀 템플릿 수정 (미래)
```

### C. 환경 변수

```bash
# .env
USE_PROMPT_TEMPLATES=true          # 템플릿 시스템 활성화
PROMPT_CACHE_TTL=3600              # 캐시 TTL (초)
PROMPT_VERSION_TRACKING=true       # 버전 추적 활성화
```

---

*Generated by: PlanningSpecialist*
*Date: 2026-01-08T16:43:00.107Z*
*Status: PENDING_REVIEW*
