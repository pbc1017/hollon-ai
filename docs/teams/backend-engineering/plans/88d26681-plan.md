# Plan: Backend Engineering: 시스템 프롬프트 코드 관리 시스템 구축

## Task Information
- **Task ID**: 88d26681-c235-42ac-a718-af3cdfe29e46
- **Type**: team_epic
- **Created**: 2026-01-08T16:14:00.099Z

## Objective

현재 시스템의 모든 Role 및 Hollon 시스템 프롬프트가 `apps/server/src/database/seed.ts` 파일에 하드코딩되어 있습니다. 이는 다음과 같은 문제점을 가지고 있습니다:

1. **유지보수 어려움**: 프롬프트 수정 시 seed 파일의 긴 문자열을 직접 편집해야 함
2. **버전 관리 부재**: 프롬프트 변경 이력 추적 불가
3. **재사용성 낮음**: 동일한 프롬프트 패턴을 여러 Role에서 중복 정의
4. **테스트 어려움**: 프롬프트 로직을 독립적으로 테스트 불가
5. **동적 변경 불가**: 런타임에 프롬프트를 수정하거나 커스터마이징 어려움

이 작업의 목표는 **시스템 프롬프트를 코드로 관리하는 독립적인 모듈**을 구축하는 것입니다:

- Role별 프롬프트 템플릿을 TypeScript 코드로 정의
- 템플릿 변수 치환 및 병합 로직 구현
- DB에 저장된 커스텀 프롬프트와 코드 템플릿 병합
- 버전 관리 및 이력 추적 시스템
- 기존 서비스와의 원활한 통합

## Analysis

### Current State

**1. Entity 구조**
- `Role` 엔티티 (`apps/server/src/modules/role/entities/role.entity.ts:28`)
  - `systemPrompt: string` (nullable, text column)
- `Hollon` 엔티티 (`apps/server/src/modules/hollon/entities/hollon.entity.ts:78`)
  - `systemPrompt: string` (nullable, text column)

**2. 현재 사용 패턴**
- seed.ts에 11개의 Role 정의, 각각 긴 systemPrompt 문자열 포함
- Role types: TechnicalLead, BackendEngineer, JuniorBackendEngineer, MLEngineer, DataEngineer, FrontendEngineer, QAEngineer, PlanningSpecialist, ImplementationSpecialist, TestingSpecialist, IntegrationSpecialist
- Hollon 생성 시 Role의 systemPrompt를 상속하거나 커스텀 프롬프트 설정
- 주요 사용처:
  - `apps/server/src/modules/orchestration/services/task-execution.service.ts:725`: `hollon.role?.systemPrompt || hollon.systemPrompt`
  - `apps/server/src/modules/orchestration/services/prompt-composer.service.ts:162,170`: Role/Hollon 컨텍스트에서 systemPrompt 추출
  - Brain Provider에 전달: `brain-provider.service.ts:58`, `claude-code.provider.ts:107`

**3. 프롬프트 구성 레이어**
현재 `PromptComposerService`는 다음 레이어로 프롬프트를 구성:
- Organization Layer
- Team Layer  
- Role Layer (systemPrompt 포함)
- Hollon Layer (개별 systemPrompt 포함)
- Task Layer

### Codebase Impact

#### Files to Create
```
apps/server/src/modules/prompt-templates/
├── prompt-template.module.ts                    # 모듈 정의
├── interfaces/
│   ├── prompt-template.interface.ts            # 인터페이스 및 타입 정의
│   └── template-variable.interface.ts          # 변수 치환 타입
├── templates/
│   ├── base/
│   │   └── base-role.template.ts               # 공통 베이스 템플릿
│   └── roles/
│       ├── cto.template.ts                     # CTO Role 템플릿
│       ├── tech-lead.template.ts               # TechLead 템플릿
│       ├── backend-engineer.template.ts        # BackendEngineer 템플릿
│       ├── junior-backend-engineer.template.ts # Junior 템플릿
│       ├── ml-engineer.template.ts             # MLEngineer 템플릿
│       ├── data-engineer.template.ts           # DataEngineer 템플릿
│       ├── frontend-engineer.template.ts       # FrontendEngineer 템플릿
│       ├── qa-engineer.template.ts             # QAEngineer 템플릿
│       ├── planning-specialist.template.ts     # Planning 템플릿
│       ├── implementation-specialist.template.ts # Implementation 템플릿
│       ├── testing-specialist.template.ts      # Testing 템플릿
│       └── integration-specialist.template.ts  # Integration 템플릿
├── services/
│   ├── prompt-template-registry.service.ts     # 템플릿 레지스트리
│   ├── prompt-merge.service.ts                 # 병합 서비스
│   ├── prompt-validation.service.ts            # 검증 서비스
│   └── prompt-version.service.ts               # 버전 관리 서비스
├── dto/
│   ├── create-prompt-template.dto.ts
│   ├── update-prompt-template.dto.ts
│   └── prompt-template-response.dto.ts
├── controllers/
│   └── prompt-template.controller.ts           # REST API
└── __tests__/
    ├── prompt-template-registry.service.spec.ts
    ├── prompt-merge.service.spec.ts
    ├── prompt-template.controller.spec.ts
    └── templates/
        ├── cto.template.spec.ts
        └── backend-engineer.template.spec.ts
```

#### Files to Modify
- `apps/server/src/modules/role/role.service.ts`
  - RoleService에 PromptMergeService 주입
  - systemPrompt 조회 로직 수정
- `apps/server/src/modules/hollon/hollon.service.ts`
  - HollonService에 PromptMergeService 주입
  - Hollon 생성/업데이트 시 프롬프트 처리 로직 변경
- `apps/server/src/modules/orchestration/services/prompt-composer.service.ts`
  - Role/Hollon의 systemPrompt를 PromptMergeService를 통해 가져오도록 수정
- `apps/server/src/app.module.ts`
  - PromptTemplateModule import 추가
- `apps/server/src/database/seed.ts`
  - Role 생성 시 systemPrompt 필드 제거 또는 null로 설정
  - Hollon 생성 시 systemPrompt 필드 제거 (기본 템플릿 사용)
  - 커스텀이 필요한 경우만 DB에 저장

#### Dependencies Affected
- **TypeORM**: DB 스키마는 변경 없음 (systemPrompt 컬럼 유지, nullable)
- **class-validator**: DTO 검증에 사용
- **NestJS DI**: 서비스 간 의존성 주입
- **기존 서비스들**: RoleService, HollonService, PromptComposerService 등

### Technical Approach

#### 1. 템플릿 시스템 아키텍처

**인터페이스 정의**
```typescript
// IPromptTemplate: 템플릿 기본 구조
interface IPromptTemplate {
  role: RoleType;
  version: string;
  template: string;
  variables: string[];
  render(context: TemplateContext): string;
}

// RoleType: 모든 Role을 union type으로 정의
type RoleType = 
  | 'TechnicalLead'
  | 'BackendEngineer' 
  | 'JuniorBackendEngineer'
  | 'MLEngineer'
  | 'DataEngineer'
  | 'FrontendEngineer'
  | 'QAEngineer'
  | 'PlanningSpecialist'
  | 'ImplementationSpecialist'
  | 'TestingSpecialist'
  | 'IntegrationSpecialist';

// TemplateContext: 변수 치환을 위한 컨텍스트
interface TemplateContext {
  organizationName?: string;
  teamName?: string;
  hollonName?: string;
  [key: string]: any;
}
```

**템플릿 클래스 구조**
```typescript
// 베이스 템플릿 클래스
abstract class BaseRoleTemplate implements IPromptTemplate {
  abstract role: RoleType;
  abstract version: string;
  abstract template: string;
  abstract variables: string[];
  
  render(context: TemplateContext): string {
    let result = this.template;
    for (const variable of this.variables) {
      const value = context[variable] || '';
      result = result.replace(new RegExp(`{{${variable}}}`, 'g'), value);
    }
    return result;
  }
}

// Role별 구체적인 템플릿
class CTOTemplate extends BaseRoleTemplate {
  role = 'TechnicalLead' as const;
  version = '1.0.0';
  variables = ['organizationName'];
  template = `당신은 {{organizationName}}의 CTO입니다...`;
}
```

#### 2. 템플릿 레지스트리 서비스

```typescript
@Injectable()
export class PromptTemplateRegistry {
  private templates: Map<RoleType, IPromptTemplate> = new Map();
  private cache: Map<string, string> = new Map();

  constructor() {
    this.registerTemplates();
  }

  private registerTemplates() {
    // 모든 템플릿 등록
    this.templates.set('TechnicalLead', new CTOTemplate());
    this.templates.set('BackendEngineer', new BackendEngineerTemplate());
    // ... 나머지 Role 템플릿 등록
  }

  getTemplate(role: RoleType): IPromptTemplate | null {
    return this.templates.get(role) || null;
  }

  renderTemplate(role: RoleType, context: TemplateContext): string {
    const cacheKey = `${role}:${JSON.stringify(context)}`;
    if (this.cache.has(cacheKey)) {
      return this.cache.get(cacheKey);
    }

    const template = this.getTemplate(role);
    if (!template) {
      throw new NotFoundException(`Template not found for role: ${role}`);
    }

    const rendered = template.render(context);
    this.cache.set(cacheKey, rendered);
    return rendered;
  }
}
```

#### 3. 프롬프트 병합 서비스

```typescript
@Injectable()
export class PromptMergeService {
  constructor(
    private readonly registry: PromptTemplateRegistry,
    private readonly roleRepo: Repository<Role>,
  ) {}

  async getMergedPrompt(
    role: Role,
    context: TemplateContext,
    options?: MergeOptions,
  ): Promise<string> {
    // 1. 코드 템플릿에서 기본 프롬프트 가져오기
    const basePrompt = this.registry.renderTemplate(
      role.name as RoleType,
      context,
    );

    // 2. DB에 커스텀 프롬프트가 있으면 병합
    if (role.systemPrompt) {
      return this.merge(basePrompt, role.systemPrompt, options);
    }

    return basePrompt;
  }

  private merge(
    basePrompt: string,
    customPrompt: string,
    options?: MergeOptions,
  ): string {
    const strategy = options?.strategy || 'append';
    
    switch (strategy) {
      case 'override':
        return customPrompt;
      case 'prepend':
        return `${customPrompt}\n\n${basePrompt}`;
      case 'append':
      default:
        return `${basePrompt}\n\n## Custom Instructions\n${customPrompt}`;
    }
  }
}

interface MergeOptions {
  strategy?: 'override' | 'prepend' | 'append';
}
```

#### 4. 기존 서비스 통합

**RoleService 수정**
```typescript
@Injectable()
export class RoleService {
  constructor(
    @InjectRepository(Role) private roleRepo: Repository<Role>,
    private promptMergeService: PromptMergeService, // 추가
  ) {}

  async getSystemPrompt(roleId: string, context?: TemplateContext): Promise<string> {
    const role = await this.findOne(roleId);
    return this.promptMergeService.getMergedPrompt(role, context || {});
  }
}
```

**PromptComposerService 수정**
```typescript
private async composeRoleLayer(context: RoleContext): Promise<string> {
  // 기존: context.systemPrompt 직접 사용
  // 변경: PromptMergeService를 통해 가져오기
  const systemPrompt = await this.promptMergeService.getMergedPrompt(
    context.role,
    {
      organizationName: context.organizationName,
      teamName: context.teamName,
    },
  );

  return `# Role: ${context.name}
${context.description}

## Role-Specific Guidelines:
${systemPrompt}

## Your Capabilities:
${context.capabilities.join(', ')}`;
}
```

#### 5. 마이그레이션 전략

**Phase 1: 모듈 구축 (병렬 운영)**
- 새 PromptTemplateModule 구축
- 기존 시스템은 그대로 유지
- 단위 테스트로 검증

**Phase 2: 통합 (Feature Flag)**
- RoleService, HollonService에 PromptMergeService 주입
- Feature flag로 신규/구 시스템 전환 가능하게 구현
- 통합 테스트 작성

**Phase 3: 마이그레이션**
- seed.ts에서 systemPrompt 제거
- 기본 템플릿으로 전환
- E2E 테스트로 전체 플로우 검증

**Phase 4: 정리**
- Feature flag 제거
- 구 시스템 제거
- 문서화 완료

### Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| 기존 시스템 동작 중단 | High | Feature flag로 점진적 전환, 롤백 가능하도록 구현 |
| 템플릿 변수 누락 | Medium | PromptValidationService로 렌더링 전 검증, 테스트 케이스 작성 |
| 성능 저하 (렌더링 오버헤드) | Low | 캐싱 전략 구현 (메모리 캐시), 벤치마크 테스트 |
| 기존 프롬프트와 동작 차이 | Medium | 템플릿 작성 시 seed.ts의 원본과 동일하게 구현, 비교 테스트 |
| DB 마이그레이션 실패 | Low | systemPrompt 컬럼은 유지 (nullable), 스키마 변경 없음 |
| 문서 부족으로 인한 사용성 저하 | Medium | 상세한 사용 가이드 작성, 예시 코드 제공 |

## Decomposition

### Work Items Breakdown

이 Team Epic은 26개의 Implementation Tasks로 구성되어 있으며, 다음과 같이 그룹화할 수 있습니다:

**Group 1: 기초 설계 및 인프라 (P1 - 선행 작업)**
- Task 1: 디렉토리 구조 설계 및 생성
- Task 2: 인터페이스 및 타입 정의
- Task 3: 시드 데이터 프롬프트 추출 및 분석

**Group 2: Role 템플릿 구현 (P2-P3 - 병렬 가능)**
- Task 4-8: 주요 Role 템플릿 구현 (CTO, TechLead, AILead, InfraLead, 기타)

**Group 3: 핵심 서비스 구현 (P1-P2)**
- Task 9: 템플릿 레지스트리 서비스
- Task 10: 프롬프트 병합 서비스
- Task 11: DTO 정의
- Task 12: 컨트롤러 구현
- Task 13: 모듈 통합

**Group 4: 기존 시스템 통합 (P1-P2 - 순차적)**
- Task 14: Role 서비스 통합
- Task 15: Hollon 서비스 통합
- Task 16: 시드 데이터 수정

**Group 5: 고급 기능 (P3-P4 - 추가 기능)**
- Task 17: 버전 관리 시스템
- Task 18: 미리보기 기능
- Task 19: 유효성 검증 로직
- Task 24: 성능 최적화 (캐싱)
- Task 25: 변경 로깅 및 감사

**Group 6: 테스트 (P2 - Group 3, 4 완료 후)**
- Task 20: 서비스 단위 테스트
- Task 21: 컨트롤러 단위 테스트
- Task 22: 통합 테스트

**Group 7: 문서화 및 배포 (P1, P3)**
- Task 23: 관리 문서 작성
- Task 26: 프로덕션 배포 및 모니터링

### Subtask Dependencies

```
Phase 1 (기초):
1 → 2 → 3 (순차적)

Phase 2 (템플릿):
3 → [4, 5, 6, 7, 8] (병렬)

Phase 3 (서비스):
2 → 9 (레지스트리)
2 → 11 (DTO)
[8, 9, 11] → 10 (병합)
[9, 10, 11] → 12 (컨트롤러)
[9, 10, 12] → 13 (모듈)

Phase 4 (통합):
13 → 14 (Role 통합)
13 → 15 (Hollon 통합)
[14, 15] → 16 (시드 수정)

Phase 5 (고급):
13 → [17, 18, 19] (병렬)
10 → 24 (캐싱)
13 → 25 (로깅)

Phase 6 (테스트):
[9, 10] → 20 (서비스 테스트)
12 → 21 (컨트롤러 테스트)
[14, 15, 16] → 22 (통합 테스트)

Phase 7 (문서/배포):
13 → 23 (문서)
[16, 22] → 26 (배포)
```

### Implementation Subtasks

#### Phase 1: 기초 설계 (3 tasks)

**1. 프롬프트 템플릿 모듈 디렉토리 구조 설계 및 생성**
- Priority: P1
- Assignee: Senior Backend Engineer
- Dependencies: None
- Description: 전체 모듈의 뼈대를 구성합니다. 디렉토리 구조를 생성하고 각 디렉토리의 역할을 README에 문서화합니다.
- Acceptance Criteria:
  - `apps/server/src/modules/prompt-templates/` 생성
  - 하위 디렉토리: `templates/`, `templates/roles/`, `services/`, `dtos/`, `interfaces/`, `controllers/`, `__tests__/` 생성
  - `README.md` 작성 (모듈 구조, 역할, 사용 방법)
- Estimated Effort: 1-2 hours

**2. 프롬프트 템플릿 인터페이스 및 타입 정의**
- Priority: P1
- Assignee: Senior Backend Engineer
- Dependencies: Task 1
- Description: TypeScript 인터페이스와 타입 시스템을 정의합니다. 모든 템플릿이 따를 계약을 명확히 합니다.
- Acceptance Criteria:
  - `interfaces/prompt-template.interface.ts` 생성
    - `IPromptTemplate` 인터페이스 정의
    - `RoleType` union type 정의 (11개 Role)
    - `TemplateContext` 인터페이스 정의
  - `interfaces/template-variable.interface.ts` 생성
    - 변수 치환 관련 타입 정의
  - 모든 인터페이스에 JSDoc 주석 추가
- Estimated Effort: 2-3 hours

**3. 현재 시드 데이터에서 시스템 프롬프트 추출 및 분석**
- Priority: P1
- Assignee: Junior Backend Engineer
- Dependencies: None (병렬 가능)
- Description: seed.ts에서 모든 Role의 systemPrompt를 추출하고 패턴을 분석합니다. 템플릿 작성의 기준이 됩니다.
- Acceptance Criteria:
  - `docs/prompt-analysis.md` 생성
  - 각 Role의 systemPrompt 추출
  - 공통 패턴 식별 (역할 설명, 임무, 기술 스택, 테스트 책임 등)
  - 변수로 치환 가능한 부분 식별
  - Role별 차이점 분석
- Estimated Effort: 2-3 hours

#### Phase 2: Role 템플릿 구현 (5 tasks)

**4. CTO Role 기본 프롬프트 템플릿 구현**
- Priority: P2
- Assignee: Senior Backend Engineer
- Dependencies: Task 2, 3
- Description: TechnicalLead (CTO) Role의 템플릿을 구현합니다. 첫 번째 템플릿이므로 베이스 클래스도 함께 작성합니다.
- Acceptance Criteria:
  - `templates/base/base-role.template.ts` 생성 (`BaseRoleTemplate` 클래스)
  - `templates/roles/tech-lead.template.ts` 생성
  - `IPromptTemplate` 구현
  - `render()` 메서드로 변수 치환 구현
  - 원본 seed.ts의 TechnicalLead 프롬프트와 내용 일치
  - 단위 테스트 작성
- Estimated Effort: 3-4 hours

**5. BackendEngineer 및 JuniorBackendEngineer Role 템플릿 구현**
- Priority: P2
- Assignee: Backend Engineer
- Dependencies: Task 4
- Description: 백엔드 엔지니어 Role 템플릿을 구현합니다.
- Acceptance Criteria:
  - `templates/roles/backend-engineer.template.ts` 생성
  - `templates/roles/junior-backend-engineer.template.ts` 생성
  - 원본 프롬프트와 일치
  - 단위 테스트 작성
- Estimated Effort: 2-3 hours

**6. MLEngineer 및 DataEngineer Role 템플릿 구현**
- Priority: P2
- Assignee: ML Engineer 또는 Backend Engineer
- Dependencies: Task 4
- Description: AI/데이터 관련 Role 템플릿을 구현합니다.
- Acceptance Criteria:
  - `templates/roles/ml-engineer.template.ts` 생성
  - `templates/roles/data-engineer.template.ts` 생성
  - 원본 프롬프트와 일치
  - 단위 테스트 작성
- Estimated Effort: 2-3 hours

**7. Specialized Role 템플릿 구현 (Planning, Implementation, Testing, Integration)**
- Priority: P2
- Assignee: Backend Engineer
- Dependencies: Task 4
- Description: 서브 홀론용 특화 Role 템플릿을 구현합니다.
- Acceptance Criteria:
  - `templates/roles/planning-specialist.template.ts` 생성
  - `templates/roles/implementation-specialist.template.ts` 생성
  - `templates/roles/testing-specialist.template.ts` 생성
  - `templates/roles/integration-specialist.template.ts` 생성
  - 원본 프롬프트와 일치
  - 단위 테스트 작성
- Estimated Effort: 3-4 hours

**8. 기타 Role 템플릿 구현 (Frontend, QA)**
- Priority: P3
- Assignee: Backend Engineer
- Dependencies: Task 4
- Description: 나머지 Role 템플릿을 구현합니다.
- Acceptance Criteria:
  - `templates/roles/frontend-engineer.template.ts` 생성
  - `templates/roles/qa-engineer.template.ts` 생성
  - 원본 프롬프트와 일치
  - 단위 테스트 작성
- Estimated Effort: 2 hours

#### Phase 3: 핵심 서비스 구현 (5 tasks)

**9. 프롬프트 템플릿 레지스트리 서비스 구현**
- Priority: P1
- Assignee: Senior Backend Engineer
- Dependencies: Task 2, Task 8
- Description: 모든 템플릿을 관리하는 중앙 레지스트리를 구현합니다.
- Acceptance Criteria:
  - `services/prompt-template-registry.service.ts` 생성
  - `@Injectable()` 데코레이터 적용
  - `registerTemplates()` 메서드로 모든 Role 템플릿 등록
  - `getTemplate(role: RoleType)` 메서드 구현
  - `renderTemplate(role, context)` 메서드 구현
  - 캐싱 로직 구현 (Map 기반)
  - 단위 테스트 작성
- Estimated Effort: 4-5 hours

**10. 프롬프트 병합 서비스 구현**
- Priority: P1
- Assignee: Senior Backend Engineer
- Dependencies: Task 9, Task 11
- Description: 코드 템플릿과 DB 커스텀 프롬프트를 병합하는 로직을 구현합니다.
- Acceptance Criteria:
  - `services/prompt-merge.service.ts` 생성
  - `getMergedPrompt(role, context, options)` 메서드 구현
  - 병합 전략: override, prepend, append 지원
  - 변수 치환 로직 구현
  - 단위 테스트 작성 (모든 병합 전략 테스트)
- Estimated Effort: 4-5 hours

**11. 프롬프트 템플릿 DTO 정의**
- Priority: P2
- Assignee: Backend Engineer
- Dependencies: Task 2
- Description: API 엔드포인트용 DTO를 정의합니다.
- Acceptance Criteria:
  - `dtos/create-prompt-template.dto.ts` 생성
  - `dtos/update-prompt-template.dto.ts` 생성
  - `dtos/prompt-template-response.dto.ts` 생성
  - class-validator 데코레이터 적용
  - `IsString`, `IsEnum`, `IsOptional` 등 검증 규칙
- Estimated Effort: 2 hours

**12. 프롬프트 템플릿 컨트롤러 구현**
- Priority: P2
- Assignee: Backend Engineer
- Dependencies: Task 9, Task 10, Task 11
- Description: 템플릿 조회 및 미리보기 API를 구현합니다.
- Acceptance Criteria:
  - `controllers/prompt-template.controller.ts` 생성
  - `@Controller('prompt-templates')` 데코레이터 적용
  - `GET /prompt-templates/:role` 엔드포인트 (템플릿 조회)
  - `POST /prompt-templates/preview` 엔드포인트 (미리보기)
  - DTO 유효성 검증 적용
  - 단위 테스트 작성
- Estimated Effort: 3-4 hours

**13. 프롬프트 템플릿 모듈 통합 및 등록**
- Priority: P1
- Assignee: Senior Backend Engineer
- Dependencies: Task 9, Task 10, Task 12
- Description: 모듈을 생성하고 AppModule에 통합합니다.
- Acceptance Criteria:
  - `prompt-template.module.ts` 생성
  - `@Module` 데코레이터에 providers, controllers 등록
  - `exports`에 주요 서비스 추가
  - `apps/server/src/app.module.ts`에 import 추가
  - 애플리케이션 정상 실행 확인
- Estimated Effort: 2 hours

#### Phase 4: 기존 시스템 통합 (3 tasks)

**14. Role 서비스에서 프롬프트 템플릿 서비스 통합**
- Priority: P1
- Assignee: Senior Backend Engineer
- Dependencies: Task 13
- Description: RoleService가 새 프롬프트 시스템을 사용하도록 수정합니다.
- Acceptance Criteria:
  - `role.service.ts`에 `PromptMergeService` 주입
  - `getSystemPrompt(roleId, context)` 메서드 추가
  - 기존 기능 정상 작동 확인
  - Feature flag 구현 (환경변수 기반)
- Estimated Effort: 3-4 hours

**15. Hollon 서비스에서 프롬프트 템플릿 서비스 통합**
- Priority: P1
- Assignee: Senior Backend Engineer
- Dependencies: Task 13
- Description: HollonService가 새 프롬프트 시스템을 사용하도록 수정합니다.
- Acceptance Criteria:
  - `hollon.service.ts`에 `PromptMergeService` 주입
  - Hollon 생성 시 프롬프트 처리 로직 수정
  - `createTemporary` 메서드 수정
  - 기존 기능 정상 작동 확인
- Estimated Effort: 3-4 hours

**16. 시드 데이터에서 systemPrompt 필드 제거**
- Priority: P2
- Assignee: Backend Engineer
- Dependencies: Task 14, Task 15
- Description: seed.ts를 수정하여 systemPrompt를 제거하고 코드 템플릿을 사용하도록 합니다.
- Acceptance Criteria:
  - `seed.ts`에서 모든 Role의 `systemPrompt` 필드 제거 또는 null로 설정
  - Hollon의 커스텀 `systemPrompt`도 제거 (기본 템플릿 사용)
  - `pnpm seed` 실행 성공
  - 생성된 Role/Hollon이 코드 템플릿에서 프롬프트를 가져오는지 확인
  - 롤백 계획 준비
- Estimated Effort: 2-3 hours

#### Phase 5: 고급 기능 (5 tasks)

**17. 프롬프트 버전 관리 시스템 구현**
- Priority: P3
- Assignee: Backend Engineer
- Dependencies: Task 13
- Description: 프롬프트 템플릿의 버전을 관리하는 시스템을 구축합니다.
- Acceptance Criteria:
  - `services/prompt-version.service.ts` 생성
  - 버전 히스토리 엔티티 설계 (선택적)
  - `getVersionHistory(role)` 메서드
  - `rollbackToVersion(role, version)` 메서드
  - API 엔드포인트 추가
- Estimated Effort: 5-6 hours

**18. 프롬프트 템플릿 미리보기 기능 구현**
- Priority: P3
- Assignee: Backend Engineer
- Dependencies: Task 10
- Description: 변수가 치환된 최종 프롬프트를 미리 볼 수 있는 기능을 구현합니다.
- Acceptance Criteria:
  - `POST /prompt-templates/preview` 엔드포인트 구현
  - Request body: `{ role, context }`
  - Response: 최종 렌더링된 프롬프트
  - 에러 처리 (존재하지 않는 Role, 잘못된 변수 등)
- Estimated Effort: 2-3 hours

**19. 프롬프트 템플릿 유효성 검증 로직 구현**
- Priority: P3
- Assignee: Backend Engineer
- Dependencies: Task 2
- Description: 템플릿의 구조와 변수를 검증하는 로직을 구현합니다.
- Acceptance Criteria:
  - `services/prompt-validation.service.ts` 생성
  - `validateTemplate(template)` 메서드
  - 필수 변수 누락 감지
  - 잘못된 변수 참조 감지
  - 검증 에러 메시지 명확하게 작성
  - 단위 테스트 작성
- Estimated Effort: 3-4 hours

**24. 성능 최적화 - 프롬프트 캐싱**
- Priority: P4
- Assignee: Senior Backend Engineer
- Dependencies: Task 10
- Description: 프롬프트 렌더링 성능을 최적화하기 위한 캐싱 전략을 구현합니다.
- Acceptance Criteria:
  - 메모리 캐시 구현 (Map 또는 Redis 선택)
  - 캐시 무효화 전략 정의
  - 캐시 키 생성 로직 (role + context hash)
  - 성능 벤치마크 테스트
  - 캐시 히트율 로깅
- Estimated Effort: 4-5 hours

**25. 프롬프트 템플릿 변경 로깅 및 감사**
- Priority: P4
- Assignee: Backend Engineer
- Dependencies: Task 13
- Description: 프롬프트 변경 이력을 추적하는 시스템을 구현합니다.
- Acceptance Criteria:
  - 변경 이력 엔티티 설계
  - 변경 시 자동 로깅 (interceptor 또는 decorator)
  - 사용자 정보 기록
  - 변경 전후 diff 저장
  - 감사 로그 조회 API
- Estimated Effort: 5-6 hours

#### Phase 6: 테스트 (3 tasks)

**20. 단위 테스트 - 프롬프트 템플릿 서비스**
- Priority: P2
- Assignee: Backend Engineer 또는 QA Engineer
- Dependencies: Task 9, Task 10
- Description: 핵심 서비스의 단위 테스트를 작성합니다.
- Acceptance Criteria:
  - `prompt-template-registry.service.spec.ts` 작성
  - `prompt-merge.service.spec.ts` 작성
  - 모든 주요 메서드 테스트
  - 엣지 케이스 테스트 (누락된 템플릿, 잘못된 변수 등)
  - 테스트 커버리지 80% 이상
  - 모든 테스트 통과
- Estimated Effort: 4-5 hours

**21. 단위 테스트 - 프롬프트 템플릿 컨트롤러**
- Priority: P2
- Assignee: Backend Engineer 또는 QA Engineer
- Dependencies: Task 12
- Description: 컨트롤러의 단위 테스트를 작성합니다.
- Acceptance Criteria:
  - `prompt-template.controller.spec.ts` 작성
  - 모든 엔드포인트 테스트
  - DTO 검증 로직 테스트
  - 에러 케이스 테스트
  - 모든 테스트 통과
- Estimated Effort: 3-4 hours

**22. 통합 테스트 - Role과 Hollon 프롬프트 통합**
- Priority: P2
- Assignee: Senior Backend Engineer
- Dependencies: Task 14, Task 15, Task 16
- Description: 전체 시스템이 새 프롬프트 시스템과 통합되었는지 E2E 테스트합니다.
- Acceptance Criteria:
  - `prompt-template.e2e.spec.ts` 작성
  - Role 생성 플로우 테스트
  - Hollon 생성 플로우 테스트
  - 프롬프트 병합이 정상 작동하는지 확인
  - Task 실행 시 올바른 프롬프트가 사용되는지 확인
  - 모든 테스트 통과
- Estimated Effort: 5-6 hours

#### Phase 7: 문서화 및 배포 (2 tasks)

**23. 프롬프트 템플릿 관리 문서 작성**
- Priority: P3
- Assignee: Junior Backend Engineer 또는 Technical Writer
- Dependencies: Task 13
- Description: 시스템 사용 방법을 문서화합니다.
- Acceptance Criteria:
  - `docs/prompt-template-system.md` 생성
  - 아키텍처 다이어그램 포함 (Mermaid)
  - API 엔드포인트 문서화
  - 새 Role 추가 가이드
  - 변수 사용 예시
  - 트러블슈팅 가이드
- Estimated Effort: 3-4 hours

**26. 프로덕션 배포 및 모니터링 설정**
- Priority: P1
- Assignee: DevOps Engineer 또는 Senior Backend Engineer
- Dependencies: Task 16, Task 22
- Description: 새 시스템을 프로덕션에 배포하고 모니터링을 설정합니다.
- Acceptance Criteria:
  - 배포 스크립트 작성
  - 배포 전 체크리스트 확인
  - 프로덕션 배포 수행
  - Smoke test 실행
  - 로그 모니터링 설정 (CloudWatch, Datadog 등)
  - 에러 알림 설정 (Slack, PagerDuty 등)
  - 롤백 계획 준비 및 테스트
- Estimated Effort: 4-5 hours

## Success Criteria

### 기능적 요구사항
- [ ] 모든 11개 Role의 프롬프트가 코드 템플릿으로 관리됨
- [ ] Role 생성 시 DB에 systemPrompt를 저장하지 않고도 프롬프트가 제공됨
- [ ] 커스텀 프롬프트를 DB에 저장하면 코드 템플릿과 병합되어 사용됨
- [ ] 변수 치환 기능이 정상 작동함 (organizationName, teamName 등)
- [ ] API를 통해 템플릿 조회 및 미리보기가 가능함
- [ ] 기존 시스템 동작에 영향이 없음 (하위 호환성)

### 비기능적 요구사항
- [ ] 단위 테스트 커버리지 80% 이상
- [ ] 통합 테스트로 전체 플로우 검증 완료
- [ ] 프롬프트 렌더링 성능이 기존 대비 동일하거나 개선됨
- [ ] 모든 API 엔드포인트가 200ms 이내 응답
- [ ] 에러 처리가 명확하고 사용자 친화적임
- [ ] 롤백 계획이 준비되어 있고 테스트됨

### 문서화
- [ ] API 문서가 완전히 작성됨 (Swagger/OpenAPI)
- [ ] 아키텍처 문서가 작성됨 (다이어그램 포함)
- [ ] 새 Role 추가 가이드가 작성됨
- [ ] 트러블슈팅 가이드가 작성됨

### 배포
- [ ] 프로덕션 배포가 성공적으로 완료됨
- [ ] Smoke test가 통과함
- [ ] 모니터링 및 알림이 설정됨
- [ ] 롤백 계획이 검증됨

## Implementation Guidelines

### Code Style
- TypeScript strict 모드 준수
- NestJS 모범 사례 따름
- class-validator를 사용한 DTO 검증
- JSDoc으로 public 메서드 문서화
- 명확한 변수/함수명 사용

### Testing Strategy
- 단위 테스트: Jest, 모든 서비스 메서드 테스트
- 통합 테스트: E2E 플로우 테스트
- 엣지 케이스: 누락된 템플릿, 잘못된 변수, null/undefined 처리
- Mock 사용: Repository, 외부 서비스

### Performance Considerations
- 캐싱: 렌더링된 프롬프트를 메모리 캐시에 저장
- 지연 로딩: 템플릿은 필요할 때 로드
- 벤치마크: 기존 시스템과 성능 비교

### Security Considerations
- 입력 검증: 모든 사용자 입력에 대해 검증
- XSS 방지: 프롬프트 렌더링 시 sanitization
- 권한 검증: API 엔드포인트에 적절한 Guard 적용

---
*Generated by: PlanningSpecialist*  
*Date: 2026-01-08T16:14:00.099Z*  
*Status: PENDING_REVIEW*
