# Plan: Backend Engineering: 시스템 프롬프트 코드 관리 시스템 구축

## Task Information
- **Task ID**: 88d26681-c235-42ac-a718-af3cdfe29e46
- **Type**: team_epic
- **Created**: 2026-01-08T16:23:00.078Z

## Objective

구축 목표: 현재 시드 데이터에 하드코딩된 시스템 프롬프트를 코드 기반 템플릿 시스템으로 전환하여 유지보수성, 버전 관리, 재사용성을 향상시킵니다.

**핵심 문제점:**
- 현재 시드 데이터(`apps/server/src/database/seed.ts`)에 모든 Role의 systemPrompt가 하드코딩되어 있음
- 프롬프트 변경 시 시드 파일 수정 및 전체 재실행 필요
- 프롬프트 버전 관리 및 히스토리 추적 불가
- Role별 공통 패턴 재사용 어려움

**목표 시스템:**
- 코드 기반 프롬프트 템플릿 시스템 구축
- DB 커스텀 프롬프트와 코드 템플릿 병합 기능
- 버전 관리 및 변경 이력 추적
- 변수 치환 및 동적 프롬프트 생성

## Analysis

### Current State Assessment

#### 1. 현재 시드 데이터 구조
- **위치**: `apps/server/src/database/seed.ts`
- **Role 수**: 11개 (TechnicalLead, BackendEngineer, JuniorBackendEngineer, MLEngineer, DataEngineer, FrontendEngineer, QAEngineer, PlanningSpecialist, ImplementationSpecialist, TestingSpecialist, IntegrationSpecialist)
- **Hollon 수**: 10개 (CTO-Zeus, TechLead-Alpha, AILead-Echo, InfraLead-Hotel, Developer-Bravo, Developer-Charlie, Developer-Delta, DataEngineer-Foxtrot, MLEngineer-Golf, DevOps-India)

#### 2. systemPrompt 패턴 분석

**공통 패턴:**
- Role 소개 및 책임사항
- 전문 분야 나열
- 코딩 스타일/철학
- 테스트 책임
- 프로젝트 컨텍스트

**Role별 특화 내용:**
- **TechnicalLead**: Planning 워크플로우, Task 분해 원칙, 분배 원칙
- **BackendEngineer**: TypeScript/NestJS 전문, RESTful API, Event-driven 아키텍처
- **MLEngineer**: LLM 통합, Prompt 엔지니어링, Embedding
- **DataEngineer**: Knowledge Graph, pgvector, 데이터 파이프라인
- **PlanningSpecialist**: 구현 계획 수립, 코드베이스 탐색
- **ImplementationSpecialist**: 실제 코드 구현, 점진적 커밋
- **TestingSpecialist**: 단위/통합 테스트 작성
- **IntegrationSpecialist**: Git 통합, PR 생성, 품질 검증

**변수 가능성:**
- `{hollonName}`: Hollon 이름
- `{teamName}`: 팀 이름
- `{projectName}`: 프로젝트 이름
- `{organizationName}`: 조직 이름
- `{capabilities}`: Role 능력 목록
- `{managerName}`: 매니저 이름

#### 3. 현재 엔티티 구조

**Role Entity** (`apps/server/src/modules/role/entities/role.entity.ts`):
- `systemPrompt: string` (nullable)
- DB에 저장되는 필드

**Hollon Entity** (`apps/server/src/modules/hollon/entities/hollon.entity.ts`):
- `systemPrompt: string` (nullable)
- Role의 systemPrompt를 오버라이드 가능

#### 4. 현재 서비스 구조

**RoleService** (`apps/server/src/modules/role/role.service.ts`):
- CRUD 작업만 수행
- systemPrompt 처리 로직 없음

**HollonService** (`apps/server/src/modules/hollon/hollon.service.ts`):
- Hollon 생성 시 systemPrompt 그대로 저장
- 병합 로직 없음

### Codebase Impact

#### Files to Create

**Core Module Structure:**
```
apps/server/src/modules/prompt-templates/
├── prompt-template.module.ts
├── interfaces/
│   └── prompt-template.interface.ts
├── templates/
│   └── roles/
│       ├── cto.template.ts
│       ├── tech-lead.template.ts
│       ├── backend-engineer.template.ts
│       ├── junior-backend-engineer.template.ts
│       ├── ml-engineer.template.ts
│       ├── data-engineer.template.ts
│       ├── frontend-engineer.template.ts
│       ├── qa-engineer.template.ts
│       ├── planning-specialist.template.ts
│       ├── implementation-specialist.template.ts
│       ├── testing-specialist.template.ts
│       └── integration-specialist.template.ts
├── services/
│   ├── prompt-template-registry.service.ts
│   ├── prompt-merge.service.ts
│   ├── prompt-validation.service.ts (P3)
│   └── prompt-version.service.ts (P3)
├── dtos/
│   ├── create-prompt-template.dto.ts
│   ├── update-prompt-template.dto.ts
│   └── prompt-template-response.dto.ts
└── controllers/
    └── prompt-template.controller.ts
```

**Test Files:**
```
apps/server/src/modules/prompt-templates/
├── services/
│   ├── prompt-template-registry.service.spec.ts
│   ├── prompt-merge.service.spec.ts
│   └── prompt-validation.service.spec.ts
└── controllers/
    └── prompt-template.controller.spec.ts
```

**Integration Test:**
```
apps/server/test/
└── prompt-template-integration.e2e-spec.ts
```

**Documentation:**
```
docs/
└── prompt-template-system.md
```

#### Files to Modify

1. **apps/server/src/app.module.ts**
   - PromptTemplateModule import 추가

2. **apps/server/src/modules/role/role.service.ts**
   - PromptMergeService 주입
   - systemPrompt 조회 시 병합 로직 적용

3. **apps/server/src/modules/hollon/hollon.service.ts**
   - PromptMergeService 주입
   - Hollon 생성/업데이트 시 병합 로직 적용

4. **apps/server/src/database/seed.ts**
   - systemPrompt 필드 제거 또는 null로 설정

#### Dependencies Affected

**No New External Dependencies Required**
- 모든 기능은 기존 NestJS, TypeScript, TypeORM으로 구현 가능
- class-validator: 이미 프로젝트에 있음 (DTO 검증용)

**Internal Module Dependencies:**
- PromptTemplateModule → 독립 모듈
- RoleModule → PromptTemplateModule 의존성 추가
- HollonModule → PromptTemplateModule 의존성 추가

### Technical Approach

#### Phase 1: Foundation (P1 - Critical)

**1.1 디렉토리 구조 및 인터페이스 (Work Items 1, 2)**

```typescript
// interfaces/prompt-template.interface.ts
export enum RoleType {
  CTO = 'CTO',
  TECH_LEAD = 'TechnicalLead',
  BACKEND_ENGINEER = 'BackendEngineer',
  JUNIOR_BACKEND = 'JuniorBackendEngineer',
  ML_ENGINEER = 'MLEngineer',
  DATA_ENGINEER = 'DataEngineer',
  FRONTEND_ENGINEER = 'FrontendEngineer',
  QA_ENGINEER = 'QAEngineer',
  PLANNING_SPECIALIST = 'PlanningSpecialist',
  IMPLEMENTATION_SPECIALIST = 'ImplementationSpecialist',
  TESTING_SPECIALIST = 'TestingSpecialist',
  INTEGRATION_SPECIALIST = 'IntegrationSpecialist',
}

export interface IPromptVariable {
  key: string;
  description: string;
  required: boolean;
  defaultValue?: string;
}

export interface IPromptTemplate {
  roleType: RoleType;
  version: string;
  template: string;
  variables: IPromptVariable[];
  description?: string;
  
  // 변수 치환 메서드
  render(variables: Record<string, string>): string;
}

export interface IRoleTemplate extends IPromptTemplate {
  capabilities?: string[];
  basePrompt?: string; // 공통 베이스 프롬프트
}
```

**1.2 프롬프트 레지스트리 서비스 (Work Item 9)**

```typescript
// services/prompt-template-registry.service.ts
@Injectable()
export class PromptTemplateRegistry {
  private templates: Map<RoleType, IRoleTemplate> = new Map();
  private logger = new Logger(PromptTemplateRegistry.name);

  constructor() {
    this.registerTemplates();
  }

  private registerTemplates(): void {
    // 모든 Role 템플릿 등록
    this.register(new CTOTemplate());
    this.register(new TechLeadTemplate());
    // ... 나머지 Role 템플릿
  }

  register(template: IRoleTemplate): void {
    this.templates.set(template.roleType, template);
    this.logger.log(`Registered template: ${template.roleType} v${template.version}`);
  }

  getTemplate(roleType: RoleType): IRoleTemplate | undefined {
    return this.templates.get(roleType);
  }

  getAllTemplates(): IRoleTemplate[] {
    return Array.from(this.templates.values());
  }
}
```

**1.3 프롬프트 병합 서비스 (Work Item 10)**

```typescript
// services/prompt-merge.service.ts
@Injectable()
export class PromptMergeService {
  private logger = new Logger(PromptMergeService.name);

  constructor(
    private readonly registry: PromptTemplateRegistry,
  ) {}

  /**
   * Role의 최종 systemPrompt 생성
   * 우선순위: DB 커스텀 프롬프트 > 코드 템플릿
   */
  async mergeRolePrompt(
    roleName: string,
    dbPrompt: string | null,
    variables: Record<string, string> = {},
  ): Promise<string> {
    // DB에 커스텀 프롬프트가 있으면 우선 사용
    if (dbPrompt) {
      this.logger.log(`Using DB custom prompt for role: ${roleName}`);
      return this.substituteVariables(dbPrompt, variables);
    }

    // 코드 템플릿 사용
    const roleType = this.mapRoleNameToType(roleName);
    const template = this.registry.getTemplate(roleType);
    
    if (!template) {
      throw new Error(`No template found for role: ${roleName}`);
    }

    this.logger.log(`Using code template for role: ${roleName} v${template.version}`);
    return template.render(variables);
  }

  /**
   * Hollon의 최종 systemPrompt 생성
   * 우선순위: Hollon 커스텀 > Role 템플릿/커스텀
   */
  async mergeHollonPrompt(
    hollonPrompt: string | null,
    rolePrompt: string | null,
    roleName: string,
    variables: Record<string, string> = {},
  ): Promise<string> {
    // Hollon에 커스텀 프롬프트가 있으면 최우선
    if (hollonPrompt) {
      this.logger.log(`Using Hollon custom prompt`);
      return this.substituteVariables(hollonPrompt, variables);
    }

    // Role 프롬프트 사용 (DB 또는 템플릿)
    return this.mergeRolePrompt(roleName, rolePrompt, variables);
  }

  private substituteVariables(
    template: string,
    variables: Record<string, string>,
  ): string {
    let result = template;
    for (const [key, value] of Object.entries(variables)) {
      const regex = new RegExp(`\\{${key}\\}`, 'g');
      result = result.replace(regex, value);
    }
    return result;
  }

  private mapRoleNameToType(roleName: string): RoleType {
    // Role name -> RoleType enum 매핑
    const mapping: Record<string, RoleType> = {
      'TechnicalLead': RoleType.TECH_LEAD,
      'BackendEngineer': RoleType.BACKEND_ENGINEER,
      'JuniorBackendEngineer': RoleType.JUNIOR_BACKEND,
      // ... 나머지 매핑
    };
    return mapping[roleName] || RoleType.BACKEND_ENGINEER;
  }
}
```

**1.4 모듈 통합 (Work Item 13)**

```typescript
// prompt-template.module.ts
@Module({
  providers: [
    PromptTemplateRegistry,
    PromptMergeService,
  ],
  controllers: [PromptTemplateController],
  exports: [PromptMergeService], // 다른 모듈에서 사용 가능
})
export class PromptTemplateModule {}
```

#### Phase 2: Role Templates (P2 - High Priority)

**2.1 템플릿 베이스 클래스**

```typescript
// templates/base-role.template.ts
export abstract class BaseRoleTemplate implements IRoleTemplate {
  abstract roleType: RoleType;
  abstract version: string;
  abstract template: string;
  abstract variables: IPromptVariable[];
  
  render(variables: Record<string, string>): string {
    let result = this.template;
    
    // 필수 변수 검증
    for (const varDef of this.variables) {
      if (varDef.required && !variables[varDef.key]) {
        if (varDef.defaultValue) {
          variables[varDef.key] = varDef.defaultValue;
        } else {
          throw new Error(`Required variable missing: ${varDef.key}`);
        }
      }
    }
    
    // 변수 치환
    for (const [key, value] of Object.entries(variables)) {
      const regex = new RegExp(`\\{${key}\\}`, 'g');
      result = result.replace(regex, value);
    }
    
    return result;
  }
}
```

**2.2 CTO 템플릿 예시 (Work Item 4)**

```typescript
// templates/roles/cto.template.ts
export class CTOTemplate extends BaseRoleTemplate {
  roleType = RoleType.CTO;
  version = '1.0.0';
  
  variables: IPromptVariable[] = [
    { key: 'hollonName', description: 'CTO Hollon 이름', required: true },
    { key: 'organizationName', description: '조직 이름', required: true },
    { key: 'teamCount', description: '팀 수', required: false, defaultValue: '3' },
  ];
  
  template = `당신은 {hollonName}입니다. {organizationName} 조직의 최고 기술 책임자입니다.

**Planning 워크플로우 (Phase 4.2):**
- Goal을 Team Epic으로 분해하면 각 Team Epic은 Planning 단계를 거침
- Planning에서 계획 문서가 자동 생성되고 PR로 제출되어 사람이 리뷰함
- 사람이 PR을 승인해야만 Team Epic이 Implementation Tasks로 분해됨
- 이 과정은 자동화되어 있으므로 당신은 Team Epic 분해에만 집중하면 됨

**지침:**
- Goal을 받으면 팀별 Team Epic으로 분해
- 각 팀의 매니저에게 Team Epic 할당
- 전체 아키텍처 방향성 결정
- 팀 간 조정 및 협업 촉진

**관리 범위:**
- 팀 수: {teamCount}개
- 전체 시스템 아키텍처 책임`;

  description = 'CTO Role - 조직 레벨 매니저, 전체 아키텍처 책임';
}
```

**2.3 Other Role Templates (Work Items 5-8)**
- TechLead, AILead, InfraLead 템플릿 구현
- BackendEngineer, MLEngineer, DataEngineer 템플릿 구현
- Specialized roles (Planning, Implementation, Testing, Integration) 템플릿 구현

#### Phase 3: Service Integration (P1 - Critical)

**3.1 RoleService 통합 (Work Item 14)**

```typescript
// role.service.ts
@Injectable()
export class RoleService {
  constructor(
    @InjectRepository(Role) private roleRepo: Repository<Role>,
    private readonly promptMergeService: PromptMergeService, // 추가
  ) {}

  async findOne(id: string): Promise<Role> {
    const role = await this.roleRepo.findOne({ where: { id } });
    if (!role) {
      throw new NotFoundException(`Role with ID ${id} not found`);
    }
    return role;
  }

  /**
   * Role의 최종 systemPrompt 조회 (새 메서드)
   */
  async getEffectiveSystemPrompt(
    roleId: string,
    variables: Record<string, string> = {},
  ): Promise<string> {
    const role = await this.findOne(roleId);
    return this.promptMergeService.mergeRolePrompt(
      role.name,
      role.systemPrompt,
      variables,
    );
  }
}
```

**3.2 HollonService 통합 (Work Item 15)**

```typescript
// hollon.service.ts
@Injectable()
export class HollonService {
  constructor(
    @InjectRepository(Hollon) private hollonRepo: Repository<Hollon>,
    private readonly roleService: RoleService,
    private readonly promptMergeService: PromptMergeService, // 추가
  ) {}

  /**
   * Hollon 생성 시 systemPrompt 처리
   */
  async create(createHollonDto: CreateHollonDto): Promise<Hollon> {
    const { roleId, systemPrompt, ...rest } = createHollonDto;
    
    // Role 조회
    const role = await this.roleService.findOne(roleId);
    
    // systemPrompt가 명시적으로 제공되지 않은 경우 null로 저장
    // (병합 서비스가 런타임에 템플릿을 사용)
    const hollon = this.hollonRepo.create({
      ...rest,
      roleId,
      systemPrompt: systemPrompt || null,
    });
    
    return this.hollonRepo.save(hollon);
  }

  /**
   * Hollon의 최종 systemPrompt 조회 (새 메서드)
   */
  async getEffectiveSystemPrompt(hollonId: string): Promise<string> {
    const hollon = await this.findOne(hollonId);
    const role = await this.roleService.findOne(hollon.roleId);
    
    // Hollon 컨텍스트 변수 생성
    const variables = {
      hollonName: hollon.name,
      teamName: hollon.team?.name || 'N/A',
      roleName: role.name,
      organizationName: hollon.organization?.name || 'N/A',
    };
    
    return this.promptMergeService.mergeHollonPrompt(
      hollon.systemPrompt,
      role.systemPrompt,
      role.name,
      variables,
    );
  }
}
```

**3.3 시드 데이터 업데이트 (Work Item 16)**

```typescript
// database/seed.ts 수정
const backendRole = roleRepo.create({
  organizationId: org.id,
  name: 'BackendEngineer',
  description: 'Senior Backend Developer - TypeScript/NestJS 전문가',
  systemPrompt: null, // 제거 - 코드 템플릿 사용
  capabilities: ['typescript', 'nestjs', 'postgresql', ...],
});

// Hollon도 동일
const ctoZeus = hollonRepo.create({
  name: 'CTO-Zeus',
  organizationId: org.id,
  roleId: managerRole.id,
  systemPrompt: null, // 제거 - Role 템플릿 사용
  // ... 나머지 필드
});
```

#### Phase 4: API & Testing (P2 - High Priority)

**4.1 DTO 정의 (Work Item 11)**

```typescript
// dtos/prompt-template-response.dto.ts
export class PromptTemplateResponseDto {
  @IsString()
  roleType: string;

  @IsString()
  version: string;

  @IsString()
  template: string;

  @IsArray()
  variables: IPromptVariable[];

  @IsOptional()
  @IsString()
  renderedPrompt?: string;
}
```

**4.2 Controller (Work Item 12)**

```typescript
// controllers/prompt-template.controller.ts
@Controller('prompt-templates')
export class PromptTemplateController {
  constructor(
    private readonly registry: PromptTemplateRegistry,
    private readonly mergeService: PromptMergeService,
  ) {}

  @Get(':roleType')
  async getTemplate(
    @Param('roleType') roleType: RoleType,
  ): Promise<PromptTemplateResponseDto> {
    const template = this.registry.getTemplate(roleType);
    if (!template) {
      throw new NotFoundException(`Template not found: ${roleType}`);
    }
    return template;
  }

  @Post('preview')
  async previewPrompt(
    @Body() dto: PreviewPromptDto,
  ): Promise<{ renderedPrompt: string }> {
    const template = this.registry.getTemplate(dto.roleType);
    if (!template) {
      throw new NotFoundException(`Template not found: ${dto.roleType}`);
    }
    
    const renderedPrompt = template.render(dto.variables);
    return { renderedPrompt };
  }
}
```

**4.3 Testing (Work Items 20-22)**
- Unit tests: PromptTemplateRegistry, PromptMergeService
- Unit tests: PromptTemplateController
- E2E tests: Role/Hollon integration

#### Phase 5: Advanced Features (P3/P4 - Optional)

**5.1 버전 관리 (Work Item 17)**
- PromptVersionService 구현
- 버전 히스토리 DB 테이블 추가
- 롤백 기능

**5.2 검증 로직 (Work Item 19)**
- PromptValidationService 구현
- 필수 변수 누락 감지
- 잘못된 변수 참조 감지

**5.3 성능 최적화 (Work Item 24)**
- 템플릿 캐싱 (메모리)
- 캐시 무효화 전략

**5.4 감사 로깅 (Work Item 25)**
- 변경 이력 추적
- 감사 로그 테이블

### Risks and Mitigations

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| 기존 시드 데이터의 systemPrompt 제거 시 기존 기능 손상 | High | Medium | 1. 병합 서비스 먼저 구현 및 테스트<br>2. Feature flag로 점진적 전환<br>3. 철저한 E2E 테스트 |
| 변수 치환 로직 오류로 프롬프트 손상 | High | Low | 1. 단위 테스트로 모든 변수 조합 테스트<br>2. 검증 로직 구현 (필수 변수 체크)<br>3. 미리보기 API로 사전 확인 |
| Role 이름 변경 시 템플릿 매핑 실패 | Medium | Low | 1. RoleType enum으로 명시적 타입 정의<br>2. 매핑 로직에 fallback 처리<br>3. 경고 로그 추가 |
| 템플릿 코드 변경 시 하위 호환성 문제 | Medium | Medium | 1. 버전 관리 시스템 구축 (v1.0.0)<br>2. Breaking change는 major 버전 업<br>3. 변경 로그 문서화 |
| 성능 저하 (프롬프트 생성 시 오버헤드) | Low | Low | 1. 템플릿 캐싱 구현<br>2. 변수 치환 최적화 (정규식 효율화)<br>3. 성능 벤치마크 테스트 |
| DB 마이그레이션 없이 systemPrompt 필드 유지 | Low | Low | 1. nullable 필드로 유지<br>2. 점진적 마이그레이션 가능<br>3. 코드 레벨에서만 변경 |

## Implementation Strategy

### Development Approach

**Incremental Implementation (점진적 구현)**
- Phase 1 완료 후 Phase 2 시작
- 각 Phase마다 테스트 및 검증
- Feature flag 없이 직접 통합 (Breaking change 아님)

**Backwards Compatibility (하위 호환성)**
- DB의 systemPrompt 필드는 유지 (nullable)
- DB에 값이 있으면 우선 사용 (기존 동작 유지)
- DB가 null이면 템플릿 사용 (새 기능)

**Testing Strategy**
- TDD 접근: 서비스 구현 전 테스트 작성
- 단위 테스트: 각 서비스 독립 테스트
- 통합 테스트: Role/Hollon 서비스와의 통합
- E2E 테스트: 전체 플로우 검증

### Rollout Plan

**Stage 1: Foundation (Week 1)**
- 디렉토리 구조 생성
- 인터페이스 및 타입 정의
- 레지스트리 및 병합 서비스 구현
- 모듈 통합

**Stage 2: Templates (Week 1-2)**
- CTO, TechLead 템플릿 구현 (Priority roles)
- Backend, AI, Data Engineer 템플릿
- Specialized roles 템플릿

**Stage 3: Integration (Week 2)**
- RoleService 통합
- HollonService 통합
- 시드 데이터 업데이트
- E2E 테스트

**Stage 4: Polish (Week 2-3)**
- API 엔드포인트 추가
- 단위 테스트 완성
- 문서화

**Stage 5: Advanced Features (Week 3+, Optional)**
- 버전 관리
- 검증 로직
- 성능 최적화
- 감사 로깅

## Decomposition

이 Team Epic은 Planning 단계 완료 후 Implementation Tasks로 분해됩니다.

### Implementation Task Groups

#### Group 1: Foundation & Core Services (P1)
**Dependencies**: None (시작 가능)

1. **프롬프트 템플릿 모듈 기초 구조 구축**
   - Priority: P1
   - Assignee: Senior Backend Developer
   - Scope:
     - `apps/server/src/modules/prompt-templates/` 디렉토리 생성
     - 인터페이스 정의 (IPromptTemplate, IRoleTemplate, IPromptVariable)
     - RoleType enum 정의
     - BaseRoleTemplate 추상 클래스 구현
   - Acceptance Criteria:
     - 디렉토리 구조 생성됨
     - interfaces/prompt-template.interface.ts 파일 존재
     - RoleType enum에 11개 Role 정의됨
     - BaseRoleTemplate 추상 클래스 구현됨

2. **프롬프트 레지스트리 및 병합 서비스 구현**
   - Priority: P1
   - Assignee: Senior Backend Developer
   - Dependencies: Task 1 완료
   - Scope:
     - PromptTemplateRegistry 서비스 구현
     - PromptMergeService 서비스 구현
     - 템플릿 등록 메커니즘
     - 변수 치환 로직
   - Acceptance Criteria:
     - services/prompt-template-registry.service.ts 구현됨
     - services/prompt-merge.service.ts 구현됨
     - 템플릿 등록/조회 메서드 작동함
     - 변수 치환 로직이 정확히 작동함

3. **프롬프트 템플릿 모듈 등록 및 통합**
   - Priority: P1
   - Assignee: Senior Backend Developer
   - Dependencies: Task 2 완료
   - Scope:
     - PromptTemplateModule 생성
     - AppModule에 import
     - DTO 정의 (Create, Update, Response)
     - Controller 기본 구조
   - Acceptance Criteria:
     - prompt-template.module.ts 존재
     - AppModule에 import됨
     - 애플리케이션 정상 실행됨
     - DTO 파일들이 존재하고 class-validator 적용됨

#### Group 2: Role Templates - Manager Roles (P2)
**Dependencies**: Task 3 완료

4. **CTO 및 TechLead 프롬프트 템플릿 구현**
   - Priority: P2
   - Assignee: Senior Backend Developer
   - Dependencies: Task 3 완료
   - Scope:
     - templates/roles/cto.template.ts 구현
     - templates/roles/tech-lead.template.ts 구현
     - templates/roles/ai-lead.template.ts 구현
     - templates/roles/infra-lead.template.ts 구현
     - 각 템플릿 레지스트리에 등록
   - Acceptance Criteria:
     - 4개 Manager Role 템플릿 파일 존재
     - 시드 데이터의 프롬프트 내용과 일치함
     - 변수 치환 정상 작동함
     - 레지스트리에서 조회 가능함

#### Group 3: Role Templates - Engineer Roles (P2)
**Dependencies**: Task 3 완료 (Task 4와 병렬 가능)

5. **Engineer Role 프롬프트 템플릿 구현**
   - Priority: P2
   - Assignee: Backend Developer
   - Dependencies: Task 3 완료
   - Scope:
     - templates/roles/backend-engineer.template.ts
     - templates/roles/junior-backend-engineer.template.ts
     - templates/roles/ml-engineer.template.ts
     - templates/roles/data-engineer.template.ts
     - templates/roles/frontend-engineer.template.ts
     - templates/roles/qa-engineer.template.ts
     - 각 템플릿 레지스트리에 등록
   - Acceptance Criteria:
     - 6개 Engineer Role 템플릿 파일 존재
     - 시드 데이터 프롬프트와 내용 일치
     - 변수 치환 정상 작동
     - 레지스트리에서 조회 가능

#### Group 4: Role Templates - Specialized Roles (P2)
**Dependencies**: Task 3 완료 (Task 4, 5와 병렬 가능)

6. **Specialized Role 프롬프트 템플릿 구현**
   - Priority: P2
   - Assignee: Backend Developer
   - Dependencies: Task 3 완료
   - Scope:
     - templates/roles/planning-specialist.template.ts
     - templates/roles/implementation-specialist.template.ts
     - templates/roles/testing-specialist.template.ts
     - templates/roles/integration-specialist.template.ts
     - 각 템플릿 레지스트리에 등록
   - Acceptance Criteria:
     - 4개 Specialized Role 템플릿 파일 존재
     - 시드 데이터 프롬프트와 내용 일치
     - 변수 치환 정상 작동
     - 레지스트리에서 조회 가능

#### Group 5: Service Integration (P1)
**Dependencies**: Tasks 4, 5, 6 완료

7. **RoleService 프롬프트 시스템 통합**
   - Priority: P1
   - Assignee: Senior Backend Developer
   - Dependencies: Tasks 4, 5, 6 완료
   - Scope:
     - RoleService에 PromptMergeService 주입
     - getEffectiveSystemPrompt() 메서드 추가
     - 기존 메서드 수정 (필요 시)
     - RoleModule에 PromptTemplateModule import
   - Acceptance Criteria:
     - RoleService가 PromptMergeService를 사용함
     - getEffectiveSystemPrompt() 메서드 구현됨
     - 기존 기능이 정상 작동함
     - 단위 테스트 통과함

8. **HollonService 프롬프트 시스템 통합**
   - Priority: P1
   - Assignee: Senior Backend Developer
   - Dependencies: Task 7 완료
   - Scope:
     - HollonService에 PromptMergeService 주입
     - getEffectiveSystemPrompt() 메서드 추가
     - create() 메서드 수정 (systemPrompt 처리)
     - HollonModule에 PromptTemplateModule import
   - Acceptance Criteria:
     - HollonService가 PromptMergeService를 사용함
     - getEffectiveSystemPrompt() 메서드 구현됨
     - Hollon 생성 시 올바른 프롬프트 사용됨
     - 단위 테스트 통과함

9. **시드 데이터 systemPrompt 제거 및 마이그레이션**
   - Priority: P1
   - Assignee: Backend Developer
   - Dependencies: Task 8 완료
   - Scope:
     - seed.ts에서 모든 Role의 systemPrompt를 null로 변경
     - seed.ts에서 모든 Hollon의 systemPrompt를 null로 변경
     - 시드 실행 테스트
     - 생성된 Role/Hollon이 템플릿 프롬프트를 사용하는지 검증
   - Acceptance Criteria:
     - seed.ts에서 systemPrompt 필드가 모두 null임
     - 시드 실행이 정상 작동함
     - 생성된 Role이 코드 템플릿을 사용함
     - 생성된 Hollon이 올바른 프롬프트를 가져옴

#### Group 6: Testing (P2)
**Dependencies**: Tasks 7, 8, 9 완료

10. **프롬프트 템플릿 시스템 단위 테스트**
    - Priority: P2
    - Assignee: QA Engineer / Backend Developer
    - Dependencies: Tasks 2, 4, 5, 6 완료
    - Scope:
      - prompt-template-registry.service.spec.ts
      - prompt-merge.service.spec.ts
      - 모든 템플릿 클래스 테스트
      - 변수 치환 엣지 케이스 테스트
    - Acceptance Criteria:
      - 테스트 커버리지 80% 이상
      - 모든 핵심 로직 테스트됨
      - 엣지 케이스 커버됨
      - 테스트 통과함

11. **프롬프트 템플릿 Controller 단위 테스트**
    - Priority: P2
    - Assignee: QA Engineer / Backend Developer
    - Dependencies: Task 3 완료
    - Scope:
      - prompt-template.controller.spec.ts
      - API 엔드포인트 테스트
      - DTO 검증 테스트
      - 에러 핸들링 테스트
    - Acceptance Criteria:
      - 모든 엔드포인트 테스트됨
      - DTO 검증 로직 테스트됨
      - 에러 케이스 테스트됨
      - 테스트 통과함

12. **Role/Hollon 통합 E2E 테스트**
    - Priority: P2
    - Assignee: QA Engineer
    - Dependencies: Tasks 7, 8, 9 완료
    - Scope:
      - prompt-template-integration.e2e-spec.ts
      - Role 생성 및 프롬프트 조회 플로우
      - Hollon 생성 및 프롬프트 조회 플로우
      - 프롬프트 병합 시나리오 테스트
      - 변수 치환 통합 테스트
    - Acceptance Criteria:
      - E2E 테스트 파일 존재
      - Role 플로우 테스트 통과
      - Hollon 플로우 테스트 통과
      - 병합 로직 정상 작동
      - 모든 테스트 통과

#### Group 7: API & Documentation (P3)
**Dependencies**: Tasks 10, 11, 12 완료

13. **프롬프트 템플릿 API 엔드포인트 구현**
    - Priority: P3
    - Assignee: Backend Developer
    - Dependencies: Task 3 완료
    - Scope:
      - GET /prompt-templates/:roleType (템플릿 조회)
      - POST /prompt-templates/preview (미리보기)
      - Controller 메서드 구현
      - Swagger 문서 추가
    - Acceptance Criteria:
      - 엔드포인트 구현됨
      - DTO 검증 작동함
      - Swagger 문서 생성됨
      - API 테스트 통과함

14. **프롬프트 템플릿 시스템 문서 작성**
    - Priority: P3
    - Assignee: Technical Writer / Backend Developer
    - Dependencies: 모든 구현 완료
    - Scope:
      - docs/prompt-template-system.md 생성
      - 아키텍처 다이어그램
      - API 문서
      - 사용 가이드 (새 Role 추가 방법)
      - 변수 사용 예시
    - Acceptance Criteria:
      - 문서 파일 존재
      - 아키텍처 설명 포함
      - API 문서화됨
      - 사용 예시 포함됨

#### Group 8: Advanced Features (P3/P4 - Optional)
**Dependencies**: 모든 Core 기능 완료

15. **프롬프트 검증 서비스 구현**
    - Priority: P3
    - Assignee: Backend Developer
    - Dependencies: Task 2 완료
    - Scope:
      - PromptValidationService 구현
      - 필수 변수 누락 감지
      - 잘못된 변수 참조 감지
      - 검증 에러 메시지
    - Acceptance Criteria:
      - PromptValidationService 구현됨
      - 필수 변수 검증 작동함
      - 잘못된 참조 감지됨
      - 명확한 에러 메시지 제공됨

16. **프롬프트 버전 관리 시스템 구현**
    - Priority: P3
    - Assignee: Senior Backend Developer
    - Dependencies: Task 2 완료
    - Scope:
      - PromptVersionService 구현
      - 버전 히스토리 DB 테이블 (선택적)
      - 버전별 조회 기능
      - 롤백 기능
    - Acceptance Criteria:
      - PromptVersionService 구현됨
      - 버전 히스토리 추적 가능
      - 특정 버전 조회 가능
      - 롤백 기능 작동함

17. **프롬프트 캐싱 및 성능 최적화**
    - Priority: P4
    - Assignee: Backend Developer
    - Dependencies: 모든 Core 기능 완료
    - Scope:
      - 템플릿 캐싱 구현 (메모리)
      - 캐시 무효화 전략
      - 성능 벤치마크 테스트
      - 조회 성능 측정
    - Acceptance Criteria:
      - 캐싱 로직 구현됨
      - 캐시 무효화 작동함
      - 조회 성능 개선됨
      - 벤치마크 결과 문서화됨

18. **프롬프트 변경 감사 로깅**
    - Priority: P4
    - Assignee: Backend Developer
    - Dependencies: Task 2 완료
    - Scope:
      - 변경 이력 로깅 시스템
      - 감사 로그 DB 테이블 (선택적)
      - 변경 전후 내용 저장
      - 감사 로그 조회 API
    - Acceptance Criteria:
      - 변경 이력 기록됨
      - 사용자 정보 포함됨
      - 변경 전후 내용 저장됨
      - 조회 API 작동함

### Task Dependency Graph

```
Foundation:
[1] → [2] → [3]

Templates (병렬):
[3] → [4] (Manager Roles)
[3] → [5] (Engineer Roles)
[3] → [6] (Specialized Roles)

Integration:
[4,5,6] → [7] (RoleService) → [8] (HollonService) → [9] (Seed Update)

Testing:
[2,4,5,6] → [10] (Unit Tests - Services)
[3] → [11] (Unit Tests - Controller)
[7,8,9] → [12] (E2E Tests)

API & Docs:
[10,11,12] → [13] (API Endpoints)
[All Core] → [14] (Documentation)

Advanced (Optional):
[2] → [15] (Validation)
[2] → [16] (Versioning)
[All Core] → [17] (Caching)
[2] → [18] (Audit Logging)
```

### Recommended Team Assignment

**Senior Backend Developer (Lead):**
- Tasks 1, 2, 3, 4, 7, 8 (Core architecture and integration)

**Backend Developer:**
- Tasks 5, 6, 9, 13 (Template implementation and API)

**QA Engineer / Backend Developer:**
- Tasks 10, 11, 12 (Testing)

**Junior Backend Developer / Technical Writer:**
- Task 14 (Documentation)

**Optional Advanced Features:**
- Tasks 15-18 (Can be assigned based on priority and availability)

## Success Criteria

### Functional Requirements

- [ ] 모든 11개 Role의 프롬프트 템플릿이 코드로 구현됨
- [ ] PromptTemplateRegistry가 모든 템플릿을 조회 가능
- [ ] PromptMergeService가 DB 커스텀과 코드 템플릿을 병합 가능
- [ ] 변수 치환 기능이 정상 작동함
- [ ] RoleService가 새 프롬프트 시스템을 사용함
- [ ] HollonService가 새 프롬프트 시스템을 사용함
- [ ] 시드 데이터에서 systemPrompt 제거됨
- [ ] 기존 기능이 모두 정상 작동함 (Breaking change 없음)

### Quality Requirements

- [ ] 단위 테스트 커버리지 80% 이상
- [ ] 모든 E2E 테스트 통과
- [ ] 린트 오류 없음
- [ ] 빌드 성공
- [ ] 타입 안전성 확보 (TypeScript strict 모드)

### Non-Functional Requirements

- [ ] 프롬프트 조회 성능 저하 없음 (< 10ms 추가)
- [ ] 메모리 사용량 증가 < 50MB
- [ ] 코드 가독성 및 유지보수성 향상
- [ ] 새 Role 추가 시간 < 30분 (템플릿 작성)

### Documentation Requirements

- [ ] API 문서 완성 (Swagger)
- [ ] 아키텍처 문서 작성
- [ ] 사용 가이드 작성 (새 Role 추가 방법)
- [ ] 변수 사용 예시 문서화
- [ ] Migration 가이드 작성 (기존 시스템 → 새 시스템)

### Deployment Requirements

- [ ] 프로덕션 배포 계획 수립
- [ ] 롤백 계획 준비
- [ ] 모니터링 설정 (에러 로그, 성능 메트릭)
- [ ] 알림 설정 (Critical 에러 발생 시)

## Verification Plan

### Pre-Deployment Checklist

1. **코드 품질**
   - [ ] 모든 린트 오류 해결
   - [ ] TypeScript strict 모드 통과
   - [ ] 코드 리뷰 완료

2. **테스트**
   - [ ] 단위 테스트 커버리지 >= 80%
   - [ ] 통합 테스트 통과
   - [ ] E2E 테스트 통과
   - [ ] 성능 벤치마크 테스트 완료

3. **기능 검증**
   - [ ] Role 프롬프트 조회 정상 작동
   - [ ] Hollon 프롬프트 조회 정상 작동
   - [ ] 변수 치환 정상 작동
   - [ ] DB 커스텀 프롬프트 우선순위 작동
   - [ ] 시드 데이터 실행 성공

4. **문서**
   - [ ] API 문서 완성
   - [ ] 사용 가이드 작성
   - [ ] README 업데이트

### Post-Deployment Validation

1. **기능 검증**
   - [ ] 프로덕션 환경에서 Role 생성 테스트
   - [ ] 프로덕션 환경에서 Hollon 생성 테스트
   - [ ] 프롬프트 조회 API 테스트
   - [ ] 변수 치환 정상 작동 확인

2. **성능 모니터링**
   - [ ] 응답 시간 모니터링 (< 100ms 목표)
   - [ ] 메모리 사용량 모니터링
   - [ ] 에러 로그 모니터링

3. **롤백 준비**
   - [ ] 롤백 스크립트 준비
   - [ ] 긴급 연락처 설정
   - [ ] 에러 알림 확인

## Timeline Estimate

**Total Effort**: ~3-4 weeks (1 Senior Developer, 1 Developer, 1 QA Engineer)

### Week 1: Foundation & Templates
- Days 1-2: Tasks 1, 2, 3 (Foundation)
- Days 3-5: Tasks 4, 5, 6 (Templates)

### Week 2: Integration & Testing
- Days 1-2: Tasks 7, 8 (Service Integration)
- Day 3: Task 9 (Seed Update)
- Days 4-5: Tasks 10, 11, 12 (Testing)

### Week 3: Polish & Documentation
- Days 1-2: Task 13 (API Endpoints)
- Days 3-5: Task 14 (Documentation)

### Week 4: Advanced Features (Optional)
- Tasks 15-18 (Optional features based on priority)

## Notes

### Key Decisions

1. **No DB Schema Changes**
   - systemPrompt 필드는 그대로 유지 (nullable)
   - 마이그레이션 불필요
   - 하위 호환성 유지

2. **Priority Order**
   - DB 커스텀 프롬프트 > 코드 템플릿
   - 기존 DB 값이 있으면 그대로 사용
   - DB가 null이면 템플릿 사용

3. **Template Versioning**
   - 초기 버전은 1.0.0
   - Breaking change 시 major 버전 업
   - 버전 관리는 Phase 5 (Optional)

4. **Variable Substitution**
   - 간단한 `{key}` 형식 사용
   - Mustache/Handlebars 같은 템플릿 엔진은 오버킬
   - 필요시 나중에 확장 가능

### Future Enhancements

1. **프롬프트 A/B 테스트**
   - 여러 버전 동시 실행
   - 효과 측정 및 비교

2. **프롬프트 조합**
   - 베이스 프롬프트 + 역할별 프롬프트
   - 재사용 가능한 프롬프트 조각

3. **외부 프롬프트 저장소**
   - Git 기반 프롬프트 관리
   - 버전 관리 및 협업

4. **프롬프트 효과 측정**
   - 태스크 성공률과 프롬프트 상관관계
   - 데이터 기반 프롬프트 최적화

---
*Generated by: PlanningSpecialist*
*Date: 2026-01-08T16:23:00.078Z*
*Status: PENDING_REVIEW*
