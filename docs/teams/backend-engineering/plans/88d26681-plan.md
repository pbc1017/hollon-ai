# Plan: Backend Engineering: 시스템 프롬프트 코드 관리 시스템 구축

## Task Information
- **Task ID**: 88d26681-c235-42ac-a718-af3cdfe29e46
- **Type**: team_epic
- **Created**: 2026-01-08T16:06:00.094Z

## Objective

Refactor the system prompt management from hardcoded strings in seed.ts to a structured, code-based template system. This will improve maintainability, enable versioning, support variable substitution, and separate default prompts (code templates) from custom overrides (database).

## Analysis

### Codebase Impact

**Files to create:**
- `apps/server/src/modules/prompt-templates/` - New module directory
  - `interfaces/prompt-template.interface.ts` - Core interfaces and types
  - `templates/roles/cto.template.ts` - CTO role template
  - `templates/roles/tech-lead.template.ts` - TechLead role template
  - `templates/roles/ai-lead.template.ts` - AILead role template
  - `templates/roles/infra-lead.template.ts` - InfraLead role template
  - `templates/roles/backend-engineer.template.ts` - BackendEngineer template
  - `templates/roles/ml-engineer.template.ts` - MLEngineer template
  - `templates/roles/data-engineer.template.ts` - DataEngineer template
  - `templates/roles/junior-backend-engineer.template.ts` - Junior template
  - `templates/roles/planning-specialist.template.ts` - Planning role template
  - `templates/roles/implementation-specialist.template.ts` - Implementation role template
  - `templates/roles/testing-specialist.template.ts` - Testing role template
  - `templates/roles/integration-specialist.template.ts` - Integration role template
  - `templates/roles/qa-engineer.template.ts` - QA role template
  - `templates/roles/frontend-engineer.template.ts` - Frontend role template
  - `templates/index.ts` - Template registry export
  - `services/prompt-template-registry.service.ts` - Central template registry
  - `services/prompt-merge.service.ts` - Merge code templates with DB overrides
  - `services/prompt-validation.service.ts` - Prompt validation logic
  - `services/prompt-version.service.ts` - Version management (optional)
  - `dtos/create-prompt-template.dto.ts` - DTO for creating templates
  - `dtos/update-prompt-template.dto.ts` - DTO for updating templates
  - `dtos/prompt-template-response.dto.ts` - DTO for API responses
  - `dtos/preview-prompt.dto.ts` - DTO for preview requests
  - `controllers/prompt-template.controller.ts` - REST API endpoints
  - `prompt-template.module.ts` - Module definition
  - `README.md` - Module documentation

**Files to modify:**
- `apps/server/src/modules/role/role.service.ts` - Integrate PromptMergeService
- `apps/server/src/modules/hollon/hollon.service.ts` - Integrate PromptMergeService
- `apps/server/src/database/seed.ts` - Remove hardcoded systemPrompt values
- `apps/server/src/app.module.ts` - Import PromptTemplateModule

**Files for testing:**
- `apps/server/src/modules/prompt-templates/services/prompt-template-registry.service.spec.ts`
- `apps/server/src/modules/prompt-templates/services/prompt-merge.service.spec.ts`
- `apps/server/src/modules/prompt-templates/services/prompt-validation.service.spec.ts`
- `apps/server/src/modules/prompt-templates/controllers/prompt-template.controller.spec.ts`
- `apps/server/src/modules/role/role.service.spec.ts` - Update existing tests
- `apps/server/src/modules/hollon/hollon.service.spec.ts` - Update existing tests
- E2E test files for integration validation

**Documentation:**
- `docs/prompt-template-system.md` - System architecture and usage guide
- `docs/teams/backend-engineering/plans/88d26681-analysis.md` - Prompt pattern analysis

### Dependencies affected
- No new external dependencies required
- Uses existing NestJS, TypeORM, class-validator
- Potential future addition: Redis for caching (optional optimization)

### Technical Approach

#### Phase 1: Foundation (P1 - Critical Path)
**Infrastructure Setup:**
1. Create module directory structure
2. Define core interfaces (IPromptTemplate, IRoleTemplate, IPromptVariable)
3. Define Role enum matching existing roles in seed.ts
4. Create type system for variable substitution

**Key Design Decisions:**
- **Template Storage**: Code-based templates (TypeScript files) for version control
- **Variable Syntax**: `{{variableName}}` format for consistency with existing patterns
- **Merge Priority**: Database overrides take precedence over code templates
- **Versioning**: Each template has a version field (semantic versioning)

#### Phase 2: Template Extraction & Implementation (P1-P2)
**Analysis:**
1. Extract all 11 role systemPrompts from seed.ts:
   - CTO/TechLead/AILead/InfraLead (Manager roles)
   - BackendEngineer, MLEngineer, DataEngineer, JuniorBackendEngineer
   - PlanningSpecialist, ImplementationSpecialist, TestingSpecialist, IntegrationSpecialist
   - QAEngineer, FrontendEngineer

2. Identify common patterns:
   - Role description and responsibilities
   - Technical stack and capabilities
   - Coding style guidelines
   - Testing responsibilities
   - Phase-specific instructions (e.g., Planning workflow)

3. Identify variables:
   - `{{organizationName}}` - Organization context
   - `{{teamName}}` - Team context
   - `{{hollonName}}` - Individual hollon name
   - `{{capabilities}}` - Role capabilities list
   - Role-specific variables (e.g., `{{maxTemporaryHollonDepth}}`)

**Implementation:**
- Create one template file per role
- Each template implements `IPromptTemplate` interface
- Include version, role, variables, and template content
- Support variable substitution in template rendering

#### Phase 3: Core Services (P1)
**PromptTemplateRegistry:**
- Singleton service managing all role templates
- Method: `getTemplateByRole(role: RoleType): IPromptTemplate`
- Method: `getAllTemplates(): IPromptTemplate[]`
- Method: `getTemplateByVersion(role: RoleType, version: string): IPromptTemplate`
- In-memory cache for performance

**PromptMergeService:**
- Method: `mergePrompts(role: RoleType, dbPrompt?: string, variables?: Record<string, any>): string`
- Logic:
  1. Fetch code template from registry
  2. If dbPrompt exists, use it (override); otherwise use code template
  3. Substitute variables in the final prompt
  4. Return merged result
- Priority: DB > Code Template

**PromptValidationService:**
- Method: `validate(template: string, expectedVariables: string[]): ValidationResult`
- Checks:
  - Required variables present
  - No undefined variable references
  - Minimum/maximum length constraints
  - Structural integrity

#### Phase 4: API Layer (P2)
**Controller Endpoints:**
- `GET /prompt-templates` - List all available templates
- `GET /prompt-templates/:role` - Get template for specific role
- `GET /prompt-templates/preview` - Preview with variable substitution
- `POST /prompt-templates/validate` - Validate a custom prompt

**DTOs:**
- Request validation using class-validator
- Response formatting for consistent API contracts

#### Phase 5: Integration (P1)
**RoleService Integration:**
```typescript
// Before:
const role = roleRepo.create(dto); // systemPrompt from DTO

// After:
const role = roleRepo.create({
  ...dto,
  systemPrompt: dto.systemPrompt || null, // Allow custom override
});

// When fetching:
async getRolePrompt(roleId: string): Promise<string> {
  const role = await this.findOne(roleId);
  return this.promptMergeService.mergePrompts(
    role.name as RoleType,
    role.systemPrompt,
    { /* context variables */ }
  );
}
```

**HollonService Integration:**
```typescript
// When creating Hollon:
async create(dto: CreateHollonDto): Promise<Hollon> {
  const role = await this.roleService.findOne(dto.roleId);
  const systemPrompt = await this.promptMergeService.mergePrompts(
    role.name as RoleType,
    dto.systemPrompt || role.systemPrompt,
    {
      organizationName: '...',
      teamName: '...',
      hollonName: dto.name,
    }
  );
  
  const hollon = this.hollonRepo.create({
    ...dto,
    systemPrompt, // Merged and substituted prompt
  });
  return this.hollonRepo.save(hollon);
}
```

**Seed.ts Changes:**
- Remove all hardcoded systemPrompt strings
- Set `systemPrompt: null` for all roles
- Templates will be loaded from code
- Custom prompts can still be added via DB

#### Phase 6: Testing (P2)
**Unit Tests:**
- Template registry: Role lookup, version management, caching
- Merge service: Template priority, variable substitution, error handling
- Validation service: Variable checking, structure validation
- Controller: API endpoints, DTO validation

**Integration Tests:**
- End-to-end: Role creation → Hollon creation → Prompt retrieval
- Verify merged prompts match expected output
- Test custom overrides work correctly
- Test variable substitution in real scenarios

#### Phase 7: Documentation & Optimization (P3-P4)
**Documentation:**
- Architecture overview with diagrams
- API endpoint documentation
- Adding new roles guide
- Variable usage reference
- Migration guide for existing data

**Optimization (P4):**
- Template caching strategy (in-memory initially)
- Redis caching for distributed environments
- Prompt version history tracking
- Change logging and audit trail

### Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Breaking existing Hollon systemPrompts | HIGH | Keep DB systemPrompt field; treat as override. Existing data remains unchanged. |
| Variable substitution errors | MEDIUM | Comprehensive validation service with clear error messages. Unit tests for all variable scenarios. |
| Performance degradation from prompt merging | MEDIUM | In-memory template caching. Merge only when needed (creation time, not every query). |
| Template version conflicts | LOW | Semantic versioning. Default to latest version. Support version pinning. |
| Incomplete pattern analysis | MEDIUM | Document all patterns. Review with team. Iterative refinement. |
| Integration complexity with existing services | MEDIUM | Incremental integration. Backward compatibility maintained. Feature flags if needed. |

## Decomposition

### Phase 1: Foundation & Infrastructure (Priority: P1)

#### Task 1.1: Create Module Structure and Interfaces
**Recommended Assignee:** Senior Backend Engineer (Developer-Bravo or Developer-Charlie)
**Description:**
- Create `apps/server/src/modules/prompt-templates/` directory structure
- Define core TypeScript interfaces and types
- Set up module exports and barrel files

**Acceptance Criteria:**
- [ ] Directory structure exists with all subdirectories (interfaces/, templates/, services/, dtos/, controllers/)
- [ ] `IPromptTemplate` interface defined with fields: id, role, version, template, variables, metadata
- [ ] `IRoleTemplate` and `IPromptVariable` interfaces defined
- [ ] `RoleType` enum includes all 15 roles from seed.ts
- [ ] Version type system implemented (e.g., `PromptVersion` type)
- [ ] Variable substitution types defined (e.g., `VariableMap = Record<string, string | number | boolean>`)
- [ ] README.md created with module overview

**Files:**
- `interfaces/prompt-template.interface.ts`
- `interfaces/index.ts`
- `README.md`

---

#### Task 1.2: Analyze and Document Existing Prompts
**Recommended Assignee:** Junior Backend Engineer (Developer-Delta) or Technical Writer
**Description:**
- Extract all systemPrompts from seed.ts
- Analyze patterns: structure, common sections, role-specific content
- Identify all variables currently hardcoded (org name, team name, etc.)
- Document findings in structured markdown

**Acceptance Criteria:**
- [ ] All 15 role systemPrompts extracted and documented
- [ ] Common patterns identified and categorized (role description, responsibilities, tech stack, guidelines)
- [ ] Variables identified and listed with usage context
- [ ] Role-specific differences documented
- [ ] Analysis document created: `docs/teams/backend-engineering/plans/88d26681-analysis.md`

**Files:**
- `docs/teams/backend-engineering/plans/88d26681-analysis.md`

---

### Phase 2: Template Implementation (Priority: P1-P2)

#### Task 2.1: Implement Core Role Templates (CTO, TechLead, AILead, InfraLead)
**Recommended Assignee:** Senior Backend Engineer (Developer-Charlie)
**Description:**
- Implement template files for 4 manager roles
- Each template must implement `IPromptTemplate` interface
- Include variable placeholders using `{{variableName}}` syntax
- Ensure content matches existing seed.ts prompts

**Acceptance Criteria:**
- [ ] `templates/roles/cto.template.ts` created and implements interface
- [ ] `templates/roles/tech-lead.template.ts` created
- [ ] `templates/roles/ai-lead.template.ts` created
- [ ] `templates/roles/infra-lead.template.ts` created
- [ ] All templates include version field (e.g., "1.0.0")
- [ ] Variable placeholders properly formatted
- [ ] Content matches existing seed.ts prompts

**Files:**
- `templates/roles/cto.template.ts`
- `templates/roles/tech-lead.template.ts`
- `templates/roles/ai-lead.template.ts`
- `templates/roles/infra-lead.template.ts`

---

#### Task 2.2: Implement Engineering Role Templates (Backend, ML, Data, Junior)
**Recommended Assignee:** Senior Backend Engineer (Developer-Bravo)
**Description:**
- Implement template files for 4 engineering roles
- Follow same structure as Task 2.1
- Include capability-specific guidance in templates

**Acceptance Criteria:**
- [ ] `templates/roles/backend-engineer.template.ts` created
- [ ] `templates/roles/ml-engineer.template.ts` created
- [ ] `templates/roles/data-engineer.template.ts` created
- [ ] `templates/roles/junior-backend-engineer.template.ts` created
- [ ] All templates implement interface and include version
- [ ] Content matches existing seed.ts prompts

**Files:**
- `templates/roles/backend-engineer.template.ts`
- `templates/roles/ml-engineer.template.ts`
- `templates/roles/data-engineer.template.ts`
- `templates/roles/junior-backend-engineer.template.ts`

---

#### Task 2.3: Implement Specialist Role Templates (Planning, Implementation, Testing, Integration)
**Recommended Assignee:** Senior Backend Engineer (Developer-Bravo or Developer-Charlie)
**Description:**
- Implement template files for 4 specialist roles used in temporary hollons
- These templates are critical for the planning workflow (Phase 4.2)
- Include detailed workflow instructions

**Acceptance Criteria:**
- [ ] `templates/roles/planning-specialist.template.ts` created
- [ ] `templates/roles/implementation-specialist.template.ts` created
- [ ] `templates/roles/testing-specialist.template.ts` created
- [ ] `templates/roles/integration-specialist.template.ts` created
- [ ] All templates implement interface
- [ ] Workflow instructions preserved from seed.ts

**Files:**
- `templates/roles/planning-specialist.template.ts`
- `templates/roles/implementation-specialist.template.ts`
- `templates/roles/testing-specialist.template.ts`
- `templates/roles/integration-specialist.template.ts`

---

#### Task 2.4: Implement Remaining Role Templates (QA, Frontend, etc.)
**Recommended Assignee:** Junior Backend Engineer (Developer-Delta)
**Description:**
- Implement remaining role templates
- Ensure consistency with existing templates
- Document any special considerations

**Acceptance Criteria:**
- [ ] `templates/roles/qa-engineer.template.ts` created
- [ ] `templates/roles/frontend-engineer.template.ts` created
- [ ] Any additional roles templated
- [ ] `templates/index.ts` exports all templates
- [ ] All templates follow same structure and patterns

**Files:**
- `templates/roles/qa-engineer.template.ts`
- `templates/roles/frontend-engineer.template.ts`
- `templates/index.ts`

---

### Phase 3: Core Services (Priority: P1)

#### Task 3.1: Implement PromptTemplateRegistry Service
**Recommended Assignee:** Senior Backend Engineer (Developer-Bravo)
**Description:**
- Create central registry service for managing all templates
- Implement template lookup by role
- Add caching layer for performance
- Support versioning

**Acceptance Criteria:**
- [ ] `services/prompt-template-registry.service.ts` created
- [ ] `@Injectable()` decorator applied
- [ ] Method: `getTemplateByRole(role: RoleType): IPromptTemplate` implemented
- [ ] Method: `getAllTemplates(): IPromptTemplate[]` implemented
- [ ] Method: `getTemplateByVersion(role: RoleType, version: string): IPromptTemplate` implemented
- [ ] In-memory caching implemented (Map or similar)
- [ ] All templates from templates/ directory loaded on initialization
- [ ] Error handling for missing templates

**Files:**
- `services/prompt-template-registry.service.ts`

---

#### Task 3.2: Implement PromptMergeService
**Recommended Assignee:** Senior Backend Engineer (Developer-Charlie)
**Description:**
- Create service to merge code templates with DB overrides
- Implement variable substitution logic
- Define priority rules (DB first, then code template)
- Handle missing variables gracefully

**Acceptance Criteria:**
- [ ] `services/prompt-merge.service.ts` created
- [ ] Constructor injects PromptTemplateRegistry
- [ ] Method: `mergePrompts(role: RoleType, dbPrompt?: string, variables?: VariableMap): Promise<string>` implemented
- [ ] Priority logic: DB override > code template
- [ ] Variable substitution using `{{variable}}` pattern
- [ ] Handles missing variables (warning logged, placeholder retained)
- [ ] Returns final merged and substituted prompt

**Files:**
- `services/prompt-merge.service.ts`

---

#### Task 3.3: Implement PromptValidationService
**Recommended Assignee:** Junior Backend Engineer (Developer-Delta)
**Description:**
- Create validation service for prompt templates
- Check for required variables
- Validate structure and format
- Detect undefined variable references

**Acceptance Criteria:**
- [ ] `services/prompt-validation.service.ts` created
- [ ] Method: `validate(template: string, requiredVariables: string[]): ValidationResult` implemented
- [ ] ValidationResult type includes: `{ valid: boolean; errors: string[]; warnings: string[] }`
- [ ] Detects missing required variables
- [ ] Detects undefined variable references (e.g., `{{unknownVar}}`)
- [ ] Validates minimum/maximum length if configured
- [ ] Clear error messages for each validation failure

**Files:**
- `services/prompt-validation.service.ts`

---

### Phase 4: API Layer (Priority: P2)

#### Task 4.1: Implement DTOs for Prompt Templates
**Recommended Assignee:** Junior Backend Engineer (Developer-Delta)
**Description:**
- Create all necessary DTOs for the API
- Add class-validator decorators for validation
- Ensure type safety and proper documentation

**Acceptance Criteria:**
- [ ] `dtos/create-prompt-template.dto.ts` created with validation
- [ ] `dtos/update-prompt-template.dto.ts` created with validation
- [ ] `dtos/prompt-template-response.dto.ts` created
- [ ] `dtos/preview-prompt.dto.ts` created (role, variables)
- [ ] All DTOs use appropriate decorators: @IsString(), @IsEnum(), @IsOptional(), @IsObject()
- [ ] DTOs match interface definitions
- [ ] JSDoc comments added for documentation

**Files:**
- `dtos/create-prompt-template.dto.ts`
- `dtos/update-prompt-template.dto.ts`
- `dtos/prompt-template-response.dto.ts`
- `dtos/preview-prompt.dto.ts`

---

#### Task 4.2: Implement PromptTemplateController
**Recommended Assignee:** Senior Backend Engineer (Developer-Bravo)
**Description:**
- Create REST API controller for prompt templates
- Implement endpoints for template retrieval and preview
- Add proper error handling and validation

**Acceptance Criteria:**
- [ ] `controllers/prompt-template.controller.ts` created
- [ ] `@Controller('prompt-templates')` decorator applied
- [ ] `GET /prompt-templates` - List all templates
- [ ] `GET /prompt-templates/:role` - Get specific role template
- [ ] `POST /prompt-templates/preview` - Preview with variables
- [ ] All endpoints use appropriate DTOs
- [ ] Swagger decorators added (@ApiTags, @ApiResponse)
- [ ] Error responses use standard HTTP codes

**Files:**
- `controllers/prompt-template.controller.ts`

---

### Phase 5: Integration (Priority: P1)

#### Task 5.1: Integrate PromptMergeService into RoleService
**Recommended Assignee:** Senior Backend Engineer (Developer-Charlie)
**Description:**
- Modify RoleService to use PromptMergeService
- Add method to retrieve merged system prompt
- Maintain backward compatibility with existing systemPrompt field

**Acceptance Criteria:**
- [ ] RoleService constructor injects PromptMergeService
- [ ] New method: `getSystemPrompt(roleId: string, variables?: VariableMap): Promise<string>`
- [ ] Method fetches role, merges template with DB override, returns result
- [ ] Existing create/update methods unchanged (still accept systemPrompt)
- [ ] No breaking changes to existing API
- [ ] Unit tests updated

**Files:**
- `apps/server/src/modules/role/role.service.ts`

---

#### Task 5.2: Integrate PromptMergeService into HollonService
**Recommended Assignee:** Senior Backend Engineer (Developer-Bravo)
**Description:**
- Modify HollonService to use PromptMergeService
- Update Hollon creation to merge prompts
- Pass context variables (org, team, hollon name) to merge service

**Acceptance Criteria:**
- [ ] HollonService constructor injects PromptMergeService and RoleService
- [ ] Hollon creation (create, createTemporary, createPermanent) uses merge service
- [ ] Context variables passed: organizationName, teamName, hollonName, capabilities
- [ ] DB systemPrompt field treated as override
- [ ] If no override, code template used
- [ ] Existing functionality preserved
- [ ] Unit tests updated

**Files:**
- `apps/server/src/modules/hollon/hollon.service.ts`

---

#### Task 5.3: Create PromptTemplateModule and Register in AppModule
**Recommended Assignee:** Senior Backend Engineer (Developer-Bravo or Developer-Charlie)
**Description:**
- Create NestJS module for prompt-templates
- Register all services and controllers
- Import module in AppModule

**Acceptance Criteria:**
- [ ] `prompt-template.module.ts` created
- [ ] `@Module()` decorator includes all providers: PromptTemplateRegistry, PromptMergeService, PromptValidationService
- [ ] Controllers array includes PromptTemplateController
- [ ] Exports array includes services that will be used by other modules
- [ ] AppModule imports PromptTemplateModule
- [ ] Application starts without errors

**Files:**
- `apps/server/src/modules/prompt-templates/prompt-template.module.ts`
- `apps/server/src/app.module.ts`

---

#### Task 5.4: Update Seed Data to Remove Hardcoded Prompts
**Recommended Assignee:** Senior Backend Engineer (Developer-Charlie)
**Description:**
- Modify seed.ts to set systemPrompt to null for all roles
- Add comments indicating prompts come from code templates
- Verify seed execution works correctly
- Test that newly seeded roles/hollons get prompts from templates

**Acceptance Criteria:**
- [ ] All `systemPrompt` fields in seed.ts set to `null` or removed
- [ ] Comments added: "// systemPrompt loaded from code templates (prompt-templates module)"
- [ ] Seed script runs without errors
- [ ] Created roles have systemPrompt = null in DB
- [ ] Created hollons retrieve prompts correctly from templates via merge service
- [ ] No data migration required (existing data preserved)

**Files:**
- `apps/server/src/database/seed.ts`

---

### Phase 6: Testing (Priority: P2)

#### Task 6.1: Unit Tests for PromptTemplateRegistry Service
**Recommended Assignee:** Junior Backend Engineer (Developer-Delta)
**Description:**
- Write comprehensive unit tests for registry service
- Test template lookup, caching, versioning
- Mock template files

**Acceptance Criteria:**
- [ ] `services/prompt-template-registry.service.spec.ts` created
- [ ] Test: Template lookup by role returns correct template
- [ ] Test: getAllTemplates returns all registered templates
- [ ] Test: getTemplateByVersion returns specific version
- [ ] Test: Caching works (second call doesn't reload)
- [ ] Test: Error thrown for unknown role
- [ ] Test coverage ≥80%
- [ ] All tests pass

**Files:**
- `services/prompt-template-registry.service.spec.ts`

---

#### Task 6.2: Unit Tests for PromptMergeService
**Recommended Assignee:** Senior Backend Engineer (Developer-Bravo)
**Description:**
- Write unit tests for merge service
- Test merge priority (DB override vs template)
- Test variable substitution

**Acceptance Criteria:**
- [ ] `services/prompt-merge.service.spec.ts` created
- [ ] Test: DB override takes precedence over template
- [ ] Test: Template used when no DB override
- [ ] Test: Variable substitution replaces `{{var}}` correctly
- [ ] Test: Multiple variables substituted
- [ ] Test: Missing variables handled gracefully (warning logged)
- [ ] Test coverage ≥80%
- [ ] All tests pass

**Files:**
- `services/prompt-merge.service.spec.ts`

---

#### Task 6.3: Unit Tests for PromptValidationService
**Recommended Assignee:** Junior Backend Engineer (Developer-Delta)
**Description:**
- Write unit tests for validation service
- Test variable detection and validation

**Acceptance Criteria:**
- [ ] `services/prompt-validation.service.spec.ts` created
- [ ] Test: Detects missing required variables
- [ ] Test: Detects undefined variable references
- [ ] Test: Valid template passes validation
- [ ] Test: Multiple errors reported correctly
- [ ] Test coverage ≥80%
- [ ] All tests pass

**Files:**
- `services/prompt-validation.service.spec.ts`

---

#### Task 6.4: Unit Tests for PromptTemplateController
**Recommended Assignee:** Junior Backend Engineer (Developer-Delta)
**Description:**
- Write unit tests for controller endpoints
- Mock service dependencies
- Test API responses and error handling

**Acceptance Criteria:**
- [ ] `controllers/prompt-template.controller.spec.ts` created
- [ ] Test: GET /prompt-templates returns list of templates
- [ ] Test: GET /prompt-templates/:role returns specific template
- [ ] Test: POST /prompt-templates/preview returns merged prompt
- [ ] Test: Invalid role returns 404
- [ ] Test: DTO validation errors return 400
- [ ] Test coverage ≥80%
- [ ] All tests pass

**Files:**
- `controllers/prompt-template.controller.spec.ts`

---

#### Task 6.5: Integration Tests for Role and Hollon Prompt Integration
**Recommended Assignee:** Senior Backend Engineer (Developer-Charlie)
**Description:**
- Write E2E integration tests
- Test full flow: Role creation → Hollon creation → Prompt retrieval
- Verify merged prompts are correct

**Acceptance Criteria:**
- [ ] E2E test file created (e.g., `test/prompt-integration.e2e-spec.ts`)
- [ ] Test: Create role with no systemPrompt → retrieve prompt → matches template
- [ ] Test: Create role with custom systemPrompt → retrieve prompt → matches override
- [ ] Test: Create hollon → systemPrompt includes merged template with variables
- [ ] Test: Variable substitution works in full flow
- [ ] Test: All 15 roles can be created and prompts retrieved
- [ ] All tests pass

**Files:**
- `test/prompt-integration.e2e-spec.ts`

---

#### Task 6.6: Update Existing Service Tests
**Recommended Assignee:** Junior Backend Engineer (Developer-Delta)
**Description:**
- Update existing RoleService and HollonService tests
- Mock new PromptMergeService dependency
- Ensure all existing tests still pass

**Acceptance Criteria:**
- [ ] `role.service.spec.ts` updated with PromptMergeService mocks
- [ ] `hollon.service.spec.ts` updated with PromptMergeService mocks
- [ ] All existing tests still pass
- [ ] New methods tested
- [ ] No test coverage regression

**Files:**
- `apps/server/src/modules/role/role.service.spec.ts`
- `apps/server/src/modules/hollon/hollon.service.spec.ts`

---

### Phase 7: Documentation & Advanced Features (Priority: P3-P4)

#### Task 7.1: Write Comprehensive Documentation
**Recommended Assignee:** Technical Writer or Senior Backend Engineer
**Description:**
- Create detailed documentation for the prompt template system
- Include architecture diagrams, API docs, and usage guides

**Acceptance Criteria:**
- [ ] `docs/prompt-template-system.md` created
- [ ] Architecture overview section with diagrams
- [ ] API endpoint documentation with examples
- [ ] Guide: How to add a new role template
- [ ] Guide: How to use variables in templates
- [ ] Guide: How to customize prompts via DB
- [ ] Migration guide for existing data
- [ ] Troubleshooting section

**Files:**
- `docs/prompt-template-system.md`

---

#### Task 7.2: Implement Prompt Versioning System (Optional)
**Recommended Assignee:** Senior Backend Engineer (Developer-Bravo)
**Description:**
- Implement version history tracking
- Support rollback to previous versions
- Create PromptVersionService

**Acceptance Criteria:**
- [ ] `services/prompt-version.service.ts` created
- [ ] Version history stored (DB table or JSON)
- [ ] Method: `getVersionHistory(role: RoleType): PromptVersion[]`
- [ ] Method: `rollbackToVersion(role: RoleType, version: string): void`
- [ ] API endpoints for version management
- [ ] Tests for version service

**Files:**
- `services/prompt-version.service.ts`
- `entities/prompt-version.entity.ts` (if DB-backed)

---

#### Task 7.3: Implement Advanced Validation Features (Optional)
**Recommended Assignee:** Junior Backend Engineer (Developer-Delta)
**Description:**
- Add advanced validation rules
- Structural integrity checks
- Coherence analysis (if feasible)

**Acceptance Criteria:**
- [ ] Enhanced validation rules in PromptValidationService
- [ ] Check for required sections (e.g., "당신의 임무:", "코딩 스타일:")
- [ ] Minimum/maximum length validation
- [ ] Validation for prompt formatting (markdown, structure)
- [ ] Tests for new validation rules

**Files:**
- `services/prompt-validation.service.ts` (enhanced)

---

#### Task 7.4: Implement Caching Optimization (Optional - P4)
**Recommended Assignee:** Senior Backend Engineer (Developer-Charlie)
**Description:**
- Implement Redis-based caching for distributed environments
- Add cache invalidation strategy
- Monitor cache hit rates

**Acceptance Criteria:**
- [ ] Redis integration added (CacheModule)
- [ ] PromptTemplateRegistry uses Redis cache
- [ ] Cache TTL configured (e.g., 1 hour)
- [ ] Cache invalidation on template updates
- [ ] Metrics: cache hit rate logged
- [ ] Fallback to in-memory if Redis unavailable

**Files:**
- `services/prompt-template-registry.service.ts` (enhanced)

---

#### Task 7.5: Implement Audit Logging for Prompt Changes (Optional - P4)
**Recommended Assignee:** Senior Backend Engineer (Developer-Bravo)
**Description:**
- Track all prompt changes (who, when, what)
- Store change history in database
- Create audit log query API

**Acceptance Criteria:**
- [ ] `entities/prompt-change-log.entity.ts` created
- [ ] Logs captured on: template updates, DB override changes
- [ ] Fields: timestamp, userId, roleId, changeType, before, after
- [ ] API endpoint: GET /prompt-templates/audit-logs
- [ ] Tests for audit logging

**Files:**
- `entities/prompt-change-log.entity.ts`
- `services/prompt-audit.service.ts`

---

#### Task 7.6: Implement Preview Feature in API
**Recommended Assignee:** Junior Backend Engineer (Developer-Delta)
**Description:**
- Add preview endpoint to see final merged prompt
- Support variable input for testing
- Already planned but needs detailed implementation

**Acceptance Criteria:**
- [ ] `POST /prompt-templates/preview` endpoint fully implemented
- [ ] Request body: `{ role: string, variables: Record<string, any>, dbOverride?: string }`
- [ ] Response: final merged and substituted prompt
- [ ] Validation of input variables
- [ ] Example requests in documentation

**Files:**
- `controllers/prompt-template.controller.ts` (enhanced)

---

### Phase 8: Deployment & Monitoring (Priority: P1 for final deployment)

#### Task 8.1: Production Deployment Preparation
**Recommended Assignee:** DevOps Engineer (DevOps-India) or Tech Lead
**Description:**
- Prepare deployment plan
- Verify all tests pass
- Check for breaking changes
- Create rollback plan

**Acceptance Criteria:**
- [ ] All unit and integration tests pass (npm test)
- [ ] Linter passes (npm run lint)
- [ ] Build succeeds (npm run build)
- [ ] Migration scripts reviewed (if any)
- [ ] Environment variables documented (if any new)
- [ ] Rollback plan documented
- [ ] Deployment checklist created

**Files:**
- `docs/teams/backend-engineering/plans/88d26681-deployment.md`

---

#### Task 8.2: Deploy to Production
**Recommended Assignee:** DevOps Engineer (DevOps-India) or Tech Lead
**Description:**
- Execute production deployment
- Monitor for errors
- Verify functionality post-deployment

**Acceptance Criteria:**
- [ ] Code deployed to production environment
- [ ] Health check endpoint returns 200
- [ ] Prompt template endpoints accessible
- [ ] No 500 errors in logs
- [ ] Existing hollons continue to function
- [ ] New hollons receive prompts from templates
- [ ] Database systemPrompt field still functional (backward compatibility)

**Files:**
- N/A (deployment action)

---

#### Task 8.3: Set Up Monitoring and Alerts
**Recommended Assignee:** DevOps Engineer (DevOps-India)
**Description:**
- Configure monitoring for new module
- Set up error alerts
- Track performance metrics

**Acceptance Criteria:**
- [ ] Log monitoring configured (e.g., CloudWatch, Datadog)
- [ ] Error alerts set up (e.g., for PromptMergeService failures)
- [ ] Performance metrics tracked (e.g., template load time, cache hit rate)
- [ ] Dashboard created showing prompt system health
- [ ] Alert thresholds defined (e.g., >5% error rate)

**Files:**
- N/A (infrastructure configuration)

---

### Dependencies

**Task Dependencies:**
- Task 1.1 (Interfaces) must complete before any template implementation (Tasks 2.x)
- Task 1.2 (Analysis) should complete before template implementation for reference
- All template tasks (2.x) must complete before Task 3.1 (Registry) implementation
- Task 3.1 (Registry) must complete before Task 3.2 (Merge Service)
- Task 3.2 (Merge Service) must complete before integration tasks (5.x)
- Task 4.1 (DTOs) must complete before Task 4.2 (Controller)
- Task 5.3 (Module creation) requires Tasks 3.x and 4.x to be complete
- Integration tasks (5.x) must complete before testing tasks (6.x)
- Testing tasks (6.x) must complete before deployment (8.1)

**Parallel Work Opportunities:**
- Tasks 2.1, 2.2, 2.3, 2.4 (Template implementation) can be done in parallel after Task 1.1
- Tasks 4.1 and 3.1 can be done in parallel
- Tasks 6.1, 6.2, 6.3, 6.4 (Unit tests) can be done in parallel
- Documentation (7.1) can be written in parallel with testing (6.x)

**Critical Path:**
1.1 → 3.1 → 3.2 → 5.x → 6.x → 8.x

## Success Criteria

- [ ] All 15 role templates implemented as TypeScript files
- [ ] PromptTemplateModule created and integrated into AppModule
- [ ] RoleService and HollonService successfully use PromptMergeService
- [ ] seed.ts no longer contains hardcoded systemPrompt strings
- [ ] All existing hollons continue to function (backward compatibility)
- [ ] New hollons receive prompts from code templates with variable substitution
- [ ] API endpoints for template retrieval and preview working
- [ ] Unit test coverage ≥80% for new code
- [ ] Integration tests verify end-to-end functionality
- [ ] All existing tests still pass (no regressions)
- [ ] Documentation complete and reviewed
- [ ] Production deployment successful with no critical errors
- [ ] Monitoring and alerts configured
- [ ] System performance maintained (no significant degradation)
- [ ] Zero breaking changes to existing API contracts

---
*Generated by: PlanningSpecialist*
*Date: 2026-01-08T16:06:00.094Z*
*Status: PENDING_REVIEW*
