# Plan: Backend Engineering: 시스템 프롬프트 코드 관리 시스템 구축

## Task Information
- **Task ID**: 88d26681-c235-42ac-a718-af3cdfe29e46
- **Type**: team_epic
- **Created**: 2026-01-08T15:49:00.102Z

## Objective

이 태스크는 Hollon-AI 시스템의 시스템 프롬프트를 코드로 관리하는 중앙화된 시스템을 구축하는 것을 목표로 합니다. 현재 seed.ts 파일에 하드코딩되어 있는 Role별, Hollon별 시스템 프롬프트를 코드 템플릿으로 추출하고, DB에 저장된 커스텀 프롬프트와 병합할 수 있는 유연한 관리 시스템을 만듭니다.

주요 목표:
- 시스템 프롬프트의 코드 기반 관리 및 버전 관리
- 변수 치환 및 템플릿 시스템 구축
- Role별 프롬프트 템플릿 구현
- DB 저장 커스텀 프롬프트와의 병합 로직
- 프롬프트 변경 이력 추적 및 감사

## Analysis

### Codebase Impact

#### 현재 상태 분석

**기존 구조:**
- `apps/server/src/database/seed.ts`: 모든 Role과 Hollon의 systemPrompt가 하드코딩됨
- `apps/server/src/modules/role/`: Role 엔티티 및 서비스 (systemPrompt는 단순 문자열)
- `apps/server/src/modules/hollon/`: Hollon 엔티티 및 서비스 (systemPrompt 필드 존재)
- `apps/server/src/modules/prompt-templates/`: 이미 디렉토리 구조 일부 존재 (types/, entities/, README.md)

**이미 존재하는 파일:**
- `apps/server/src/modules/prompt-templates/types/role-type.enum.ts`: RoleType enum 정의됨
- `apps/server/src/modules/prompt-templates/README.md`: 모듈 개요 문서
- `apps/server/src/modules/prompt-templates/EXTRACTED_PROMPTS.md`: 추출된 프롬프트 분석 문서

#### Files to Create

**Core Infrastructure (P1):**
1. `apps/server/src/modules/prompt-templates/interfaces/prompt-template.interface.ts`
2. `apps/server/src/modules/prompt-templates/services/prompt-template-registry.service.ts`
3. `apps/server/src/modules/prompt-templates/services/prompt-merge.service.ts`
4. `apps/server/src/modules/prompt-templates/prompt-template.module.ts`

**Role Templates (P1-P2):**
5. `apps/server/src/modules/prompt-templates/templates/roles/cto.template.ts`
6. `apps/server/src/modules/prompt-templates/templates/roles/tech-lead.template.ts`
7. `apps/server/src/modules/prompt-templates/templates/roles/ai-lead.template.ts`
8. `apps/server/src/modules/prompt-templates/templates/roles/infra-lead.template.ts`
9. `apps/server/src/modules/prompt-templates/templates/roles/backend-engineer.template.ts`
10. `apps/server/src/modules/prompt-templates/templates/roles/frontend-engineer.template.ts`
11. `apps/server/src/modules/prompt-templates/templates/roles/qa-engineer.template.ts`
12. `apps/server/src/modules/prompt-templates/templates/roles/ml-engineer.template.ts`
13. `apps/server/src/modules/prompt-templates/templates/roles/data-engineer.template.ts`
14. `apps/server/src/modules/prompt-templates/templates/roles/junior-backend-engineer.template.ts`
15. `apps/server/src/modules/prompt-templates/templates/roles/planning-specialist.template.ts`
16. `apps/server/src/modules/prompt-templates/templates/roles/implementation-specialist.template.ts`
17. `apps/server/src/modules/prompt-templates/templates/roles/testing-specialist.template.ts`
18. `apps/server/src/modules/prompt-templates/templates/roles/integration-specialist.template.ts`

**DTOs and Controllers (P2):**
19. `apps/server/src/modules/prompt-templates/dtos/create-prompt-template.dto.ts`
20. `apps/server/src/modules/prompt-templates/dtos/update-prompt-template.dto.ts`
21. `apps/server/src/modules/prompt-templates/dtos/prompt-template-response.dto.ts`
22. `apps/server/src/modules/prompt-templates/controllers/prompt-template.controller.ts`

**Advanced Features (P3-P4):**
23. `apps/server/src/modules/prompt-templates/services/prompt-version.service.ts`
24. `apps/server/src/modules/prompt-templates/services/prompt-validation.service.ts`
25. `apps/server/src/modules/prompt-templates/entities/prompt-version.entity.ts`
26. `apps/server/src/modules/prompt-templates/entities/prompt-change-log.entity.ts`

**Tests (P2):**
27. `apps/server/src/modules/prompt-templates/services/prompt-template-registry.service.spec.ts`
28. `apps/server/src/modules/prompt-templates/services/prompt-merge.service.spec.ts`
29. `apps/server/src/modules/prompt-templates/controllers/prompt-template.controller.spec.ts`
30. `apps/server/src/modules/prompt-templates/e2e/prompt-template-integration.spec.ts`

**Documentation:**
31. `docs/prompt-template-system.md`

#### Files to Modify

1. **`apps/server/src/app.module.ts`**
   - PromptTemplateModule을 imports에 추가

2. **`apps/server/src/modules/role/role.service.ts`**
   - PromptMergeService 주입
   - systemPrompt 조회 로직을 새 서비스 사용으로 변경

3. **`apps/server/src/modules/hollon/hollon.service.ts`**
   - PromptMergeService 주입
   - Hollon 생성/업데이트 시 프롬프트 처리 로직 변경

4. **`apps/server/src/database/seed.ts`**
   - systemPrompt 필드를 null 또는 제거
   - 코드 템플릿에서 가져오도록 변경

#### Dependencies Affected

- **TypeORM**: 새 엔티티 추가 (PromptVersion, PromptChangeLog)
- **class-validator**: DTO 유효성 검증
- **@nestjs/common**: 서비스 및 컨트롤러 데코레이터
- **PostgreSQL**: 버전 히스토리 및 변경 로그 저장

### Technical Approach

#### Architecture Overview

```
┌─────────────────────────────────────────────────────────────┐
│                    Prompt Template System                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
        ┌────────────────────────────────────────┐
        │   PromptTemplateRegistry (Singleton)    │
        │   - 모든 Role 템플릿 등록               │
        │   - 템플릿 조회 및 캐싱                 │
        └────────────────────────────────────────┘
                              │
                              ▼
        ┌────────────────────────────────────────┐
        │        PromptMergeService              │
        │   - 코드 템플릿 + DB 커스텀 병합       │
        │   - 변수 치환                          │
        │   - 우선순위 규칙 적용                 │
        └────────────────────────────────────────┘
                              │
                 ┌────────────┴────────────┐
                 ▼                         ▼
        ┌─────────────────┐      ┌─────────────────┐
        │   RoleService   │      │  HollonService  │
        │   프롬프트 조회  │      │  프롬프트 조회   │
        └─────────────────┘      └─────────────────┘
```

#### Core Components

**1. Interface & Type System**
```typescript
interface IPromptTemplate {
  role: RoleType;
  version: string;
  content: string;
  variables: IPromptVariable[];
  metadata: {
    description: string;
    category: string;
    createdAt: Date;
    updatedAt: Date;
  };
}

interface IPromptVariable {
  name: string;
  type: 'string' | 'number' | 'boolean';
  required: boolean;
  defaultValue?: any;
  description?: string;
}
```

**2. Template Registry Pattern**
- Singleton 패턴으로 모든 Role 템플릿을 메모리에 캐싱
- Application 시작 시 모든 템플릿 로드
- Role별 빠른 조회 지원

**3. Merge Strategy**
```typescript
// 우선순위 규칙
// 1. DB에 custom systemPrompt 있으면 → DB 값 사용
// 2. DB에 없으면 → 코드 템플릿 사용
// 3. 변수 치환 적용
```

**4. Variable Substitution**
```typescript
// 템플릿: "당신은 {{roleName}}입니다. {{teamName}} 팀의 리드입니다."
// 변수: { roleName: "TechLead-Alpha", teamName: "Backend Engineering" }
// 결과: "당신은 TechLead-Alpha입니다. Backend Engineering 팀의 리드입니다."
```

#### Implementation Phases

**Phase 1: Core Infrastructure (Work Items 1-3, 9-10, 13)**
- 디렉토리 구조 및 인터페이스 정의
- Registry 및 Merge 서비스 구현
- Module 통합

**Phase 2: Role Templates (Work Items 4-8)**
- 주요 Role 템플릿 구현 (CTO, TechLead, AILead, InfraLead, Backend)
- seed.ts에서 프롬프트 추출 및 코드로 변환

**Phase 3: Integration (Work Items 14-16)**
- RoleService와 HollonService 통합
- seed.ts 수정
- 기존 기능 정상 작동 검증

**Phase 4: Advanced Features & Testing (Work Items 17-25)**
- 버전 관리 시스템
- 유효성 검증
- 테스트 작성
- 성능 최적화 (캐싱)

**Phase 5: Production Ready (Work Item 26)**
- 문서화
- 배포 및 모니터링

#### Data Flow

```
1. Application 시작
   └─> PromptTemplateRegistry 초기화
       └─> 모든 Role 템플릿 로드 및 캐싱

2. Role/Hollon 생성
   └─> PromptMergeService.getPromptForRole(roleType, customPrompt?, variables?)
       └─> Registry에서 템플릿 조회
       └─> customPrompt 있으면 DB 우선, 없으면 템플릿 사용
       └─> 변수 치환 적용
       └─> 최종 프롬프트 반환

3. 프롬프트 변경
   └─> DB에 customPrompt 저장 (Role 또는 Hollon 엔티티)
   └─> PromptVersionService로 변경 이력 기록
```

### Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|-----------|
| **seed.ts 변경으로 인한 기존 데이터 손실** | High | - seed.ts 변경 전 DB 백업<br>- 점진적 마이그레이션 (기존 프롬프트 유지하면서 새 시스템 추가)<br>- systemPrompt 필드는 유지하되 null 허용으로 변경 |
| **템플릿과 DB 프롬프트 불일치** | Medium | - 명확한 병합 우선순위 규칙 정의<br>- 검증 로직으로 충돌 감지<br>- 로그로 병합 과정 추적 |
| **변수 치환 오류** | Medium | - 필수 변수 누락 감지<br>- 기본값 제공<br>- 유효성 검증 서비스 구현 |
| **성능 저하 (템플릿 조회)** | Low | - Registry 패턴으로 메모리 캐싱<br>- 템플릿은 불변이므로 캐시 무효화 불필요 |
| **Role 추가 시 템플릿 누락** | Medium | - RoleType enum과 템플릿 동기화 검증<br>- 누락 시 기본 템플릿 제공<br>- 애플리케이션 시작 시 검증 |
| **버전 관리 복잡도** | Low | - 초기에는 단순 버전 문자열 사용<br>- 필요시 고도화 (Semantic Versioning) |
| **테스트 커버리지 부족** | Medium | - 핵심 로직부터 우선 테스트<br>- E2E 테스트로 통합 검증<br>- 80% 커버리지 목표 |

## Decomposition

### Work Items Organization

이 Team Epic은 26개의 Work Items로 구성되며, 다음과 같이 그룹화됩니다:

#### Group A: Foundation & Infrastructure (P1)
**Critical Path - 순차 실행 필요**

**WI-1: 프롬프트 템플릿 인터페이스 및 타입 정의**
- Assignee: Senior Backend Engineer (Developer-Bravo 추천)
- Description: IPromptTemplate, IRoleTemplate, IPromptVariable 등의 인터페이스 정의. Role 타입, 프롬프트 버전 관리, 변수 치환을 위한 타입 시스템 구축.
- Files: `interfaces/prompt-template.interface.ts`
- Dependencies: None
- Estimated Effort: 2-3 hours
- Acceptance Criteria:
  - interfaces/prompt-template.interface.ts 파일이 존재하고 모든 필요한 인터페이스가 정의됨
  - Role 타입이 enum 또는 union type으로 정의됨
  - 버전 관리를 위한 version 필드가 인터페이스에 포함됨
  - 변수 치환을 위한 타입 시스템이 구현됨

**WI-2: 프롬프트 템플릿 레지스트리 서비스 구현**
- Assignee: Senior Backend Engineer (Developer-Bravo 또는 Developer-Charlie)
- Description: PromptTemplateRegistry 서비스 구현. 모든 Role 템플릿을 등록하고 조회할 수 있는 중앙 관리 시스템. Role별 템플릿 조회, 버전 관리, 캐싱 기능 포함.
- Files: `services/prompt-template-registry.service.ts`
- Dependencies: WI-1
- Estimated Effort: 4-5 hours
- Acceptance Criteria:
  - services/prompt-template-registry.service.ts 파일이 존재함
  - @Injectable() 데코레이터가 적용됨
  - getTemplateByRole() 메서드가 구현됨
  - 템플릿 캐싱이 구현됨
  - 버전 관리 로직이 포함됨

**WI-3: 프롬프트 병합 서비스 구현**
- Assignee: Senior Backend Engineer (Developer-Charlie 추천)
- Description: PromptMergeService 구현. 코드 템플릿과 DB에 저장된 커스텀 프롬프트를 병합하는 로직. 우선순위 규칙(DB 우선)과 변수 치환 기능 포함.
- Files: `services/prompt-merge.service.ts`
- Dependencies: WI-1, WI-2
- Estimated Effort: 4-5 hours
- Acceptance Criteria:
  - services/prompt-merge.service.ts 파일이 존재함
  - mergePrompts() 메서드가 구현됨
  - DB 값과 코드 템플릿 병합이 정상 작동함
  - 변수 치환 로직이 구현됨
  - 우선순위 규칙이 적용됨

**WI-4: 프롬프트 템플릿 모듈 통합 및 등록**
- Assignee: Senior Backend Engineer (Developer-Bravo)
- Description: PromptTemplateModule 생성 및 모든 서비스, 컨트롤러 등록. AppModule에 import하여 전체 애플리케이션에서 사용 가능하도록 설정.
- Files: `prompt-template.module.ts`, `apps/server/src/app.module.ts`
- Dependencies: WI-2, WI-3
- Estimated Effort: 2 hours
- Acceptance Criteria:
  - prompt-template.module.ts 파일이 존재함
  - @Module 데코레이터에 모든 providers와 controllers가 등록됨
  - AppModule에 PromptTemplateModule이 import됨
  - 애플리케이션이 정상 실행됨

#### Group B: Role Template Implementation (P1-P2)
**병렬 실행 가능 (WI-4 완료 후)**

**WI-5: CTO & TechLead Role 프롬프트 템플릿 구현**
- Assignee: Senior Backend Engineer (Developer-Bravo)
- Description: CTO와 TechLead Role의 기본 시스템 프롬프트를 코드로 작성. templates/roles/cto.template.ts, tech-lead.template.ts 파일 생성. 변수 치환 로직 포함.
- Files:
  - `templates/roles/cto.template.ts`
  - `templates/roles/tech-lead.template.ts`
- Dependencies: WI-4
- Estimated Effort: 3-4 hours
- Acceptance Criteria:
  - 두 템플릿 파일이 존재함
  - IPromptTemplate 인터페이스를 구현함
  - 변수 치환이 정상 작동함
  - 기존 시드 데이터의 프롬프트와 내용이 일치함

**WI-6: Lead Role 프롬프트 템플릿 구현 (AI, Infra)**
- Assignee: Senior Backend Engineer (Developer-Charlie)
- Description: AILead, InfraLead Role의 기본 시스템 프롬프트를 코드로 작성. AI/ML 및 인프라 특화 지침 포함.
- Files:
  - `templates/roles/ai-lead.template.ts`
  - `templates/roles/infra-lead.template.ts`
- Dependencies: WI-4
- Estimated Effort: 3-4 hours
- Acceptance Criteria:
  - 두 템플릿 파일이 존재함
  - IPromptTemplate 인터페이스를 구현함
  - 변수 치환이 정상 작동함
  - 기존 시드 데이터의 프롬프트와 내용이 일치함

**WI-7: Engineer Role 프롬프트 템플릿 구현 (Backend, ML, Data)**
- Assignee: Senior Backend Engineer (Developer-Bravo)
- Description: BackendEngineer, MLEngineer, DataEngineer Role의 프롬프트 템플릿 구현.
- Files:
  - `templates/roles/backend-engineer.template.ts`
  - `templates/roles/ml-engineer.template.ts`
  - `templates/roles/data-engineer.template.ts`
- Dependencies: WI-4
- Estimated Effort: 4-5 hours
- Acceptance Criteria:
  - 세 템플릿 파일이 존재함
  - IPromptTemplate 인터페이스를 구현함
  - 기존 시드 데이터의 프롬프트와 내용이 일치함

**WI-8: 기타 Role 프롬프트 템플릿 구현**
- Assignee: Junior Backend Engineer (Developer-Delta)
- Description: FrontendEngineer, QAEngineer, JuniorBackendEngineer 등 나머지 Role들의 프롬프트 템플릿 구현.
- Files:
  - `templates/roles/frontend-engineer.template.ts`
  - `templates/roles/qa-engineer.template.ts`
  - `templates/roles/junior-backend-engineer.template.ts`
- Dependencies: WI-4
- Estimated Effort: 3-4 hours
- Acceptance Criteria:
  - 모든 템플릿 파일이 존재함
  - IPromptTemplate 인터페이스를 구현함
  - 기존 시드 데이터의 프롬프트와 내용이 일치함

**WI-9: Specialized Role 프롬프트 템플릿 구현**
- Assignee: Junior Backend Engineer (Developer-Delta)
- Description: PlanningSpecialist, ImplementationSpecialist, TestingSpecialist, IntegrationSpecialist의 프롬프트 템플릿 구현.
- Files:
  - `templates/roles/planning-specialist.template.ts`
  - `templates/roles/implementation-specialist.template.ts`
  - `templates/roles/testing-specialist.template.ts`
  - `templates/roles/integration-specialist.template.ts`
- Dependencies: WI-4
- Estimated Effort: 4-5 hours
- Acceptance Criteria:
  - 네 템플릿 파일이 존재함
  - IPromptTemplate 인터페이스를 구현함
  - 기존 시드 데이터의 프롬프트와 내용이 일치함

#### Group C: Service Integration (P1)
**순차 실행 (Group B 완료 후)**

**WI-10: Role 서비스에서 프롬프트 템플릿 서비스 통합**
- Assignee: Senior Backend Engineer (Developer-Charlie)
- Description: RoleService를 수정하여 PromptMergeService를 사용하도록 변경. 하드코딩된 프롬프트 제거 및 새 시스템 통합.
- Files: `apps/server/src/modules/role/role.service.ts`
- Dependencies: WI-5, WI-6, WI-7, WI-8, WI-9
- Estimated Effort: 3-4 hours
- Acceptance Criteria:
  - RoleService가 PromptMergeService를 주입받음
  - 시스템 프롬프트 조회 시 새 서비스를 사용함
  - 하드코딩된 프롬프트가 제거됨
  - 기존 기능이 정상 작동함

**WI-11: Hollon 서비스에서 프롬프트 템플릿 서비스 통합**
- Assignee: Senior Backend Engineer (Developer-Bravo)
- Description: HollonService를 수정하여 Hollon의 systemPrompt를 가져올 때 PromptMergeService 사용. Hollon 생성 및 업데이트 로직 리팩토링.
- Files: `apps/server/src/modules/hollon/hollon.service.ts`
- Dependencies: WI-5, WI-6, WI-7, WI-8, WI-9
- Estimated Effort: 3-4 hours
- Acceptance Criteria:
  - HollonService가 PromptMergeService를 주입받음
  - Hollon 생성 시 새 서비스를 통해 프롬프트를 가져옴
  - 기존 기능이 정상 작동함
  - Hollon 업데이트 시에도 새 시스템이 적용됨

**WI-12: 시드 데이터에서 systemPrompt 필드 제거**
- Assignee: Junior Backend Engineer (Developer-Delta)
- Description: seed.ts 파일에서 systemPrompt 필드를 null로 설정하거나 제거. 기본 프롬프트는 코드 템플릿에서 가져오고, 커스텀 프롬프트만 DB에 저장하도록 변경.
- Files: `apps/server/src/database/seed.ts`
- Dependencies: WI-10, WI-11
- Estimated Effort: 2-3 hours
- Acceptance Criteria:
  - seed.ts에서 systemPrompt 필드가 제거되거나 null로 설정됨
  - 시드 실행이 정상 작동함
  - 생성된 Role/Hollon이 코드 템플릿에서 프롬프트를 가져옴
  - DB 마이그레이션 없이 변경사항이 적용됨

#### Group D: API & DTOs (P2)
**병렬 실행 가능 (WI-4 완료 후)**

**WI-13: 프롬프트 템플릿 DTO 정의**
- Assignee: Junior Backend Engineer (Developer-Delta)
- Description: CreatePromptTemplateDto, UpdatePromptTemplateDto, PromptTemplateResponseDto 등의 DTO 정의. class-validator로 유효성 검증 규칙 추가.
- Files:
  - `dtos/create-prompt-template.dto.ts`
  - `dtos/update-prompt-template.dto.ts`
  - `dtos/prompt-template-response.dto.ts`
- Dependencies: WI-4
- Estimated Effort: 2-3 hours
- Acceptance Criteria:
  - dtos/ 디렉토리에 모든 필요한 DTO가 정의됨
  - class-validator 데코레이터가 적용됨
  - IsString, IsEnum, IsOptional 등의 검증 규칙이 구현됨
  - 각 DTO가 해당 인터페이스를 구현하거나 확장함

**WI-14: 프롬프트 템플릿 컨트롤러 구현**
- Assignee: Senior Backend Engineer (Developer-Bravo)
- Description: PromptTemplateController 구현. GET /prompt-templates/:role, GET /prompt-templates/preview 등의 엔드포인트 구현.
- Files: `controllers/prompt-template.controller.ts`
- Dependencies: WI-13
- Estimated Effort: 3-4 hours
- Acceptance Criteria:
  - controllers/prompt-template.controller.ts 파일이 존재함
  - @Controller('prompt-templates') 데코레이터가 적용됨
  - GET 엔드포인트들이 구현됨
  - DTO 유효성 검증이 작동함
  - 응답이 PromptTemplateResponseDto 형식을 따름

**WI-15: 프롬프트 템플릿 미리보기 기능 구현**
- Assignee: Junior Backend Engineer (Developer-Delta)
- Description: 변수가 치환된 최종 프롬프트를 미리 볼 수 있는 기능 구현. API 엔드포인트와 서비스 로직 작성.
- Files: Controller 및 Service 메서드 추가
- Dependencies: WI-14
- Estimated Effort: 2-3 hours
- Acceptance Criteria:
  - GET /prompt-templates/preview 엔드포인트가 구현됨
  - 변수 치환이 정확하게 작동함
  - Role과 변수를 파라미터로 받음
  - 최종 프롬프트가 응답으로 반환됨

#### Group E: Advanced Features (P3-P4)
**병렬 실행 가능 (Group C 완료 후)**

**WI-16: 프롬프트 버전 관리 시스템 구현**
- Assignee: Senior Backend Engineer (Developer-Charlie)
- Description: 프롬프트 템플릿의 버전을 관리하는 시스템 구축. 버전 히스토리, 버전별 조회, 롤백 기능 구현.
- Files:
  - `services/prompt-version.service.ts`
  - `entities/prompt-version.entity.ts`
- Dependencies: WI-12
- Estimated Effort: 5-6 hours
- Acceptance Criteria:
  - PromptVersionService가 구현됨
  - 버전 히스토리가 기록됨
  - 특정 버전으로 롤백 가능함
  - 버전별 조회 API가 작동함

**WI-17: 프롬프트 템플릿 유효성 검증 로직 구현**
- Assignee: Junior Backend Engineer (Developer-Delta)
- Description: 프롬프트 템플릿의 구조, 변수, 포맷을 검증하는 로직 구현. 필수 변수 누락, 잘못된 변수 참조 등을 감지.
- Files: `services/prompt-validation.service.ts`
- Dependencies: WI-12
- Estimated Effort: 3-4 hours
- Acceptance Criteria:
  - PromptValidationService가 구현됨
  - 필수 변수 누락 감지가 작동함
  - 잘못된 변수 참조가 감지됨
  - 검증 에러 메시지가 명확함

**WI-18: 성능 최적화 - 프롬프트 캐싱**
- Assignee: Senior Backend Engineer (Developer-Bravo)
- Description: 프롬프트 템플릿 조회 성능을 최적화하기 위해 캐싱 전략 구현. 메모리 캐시 기반 캐싱 적용.
- Files: Registry Service 업데이트
- Dependencies: WI-12
- Estimated Effort: 3-4 hours
- Acceptance Criteria:
  - 캐싱 로직이 구현됨
  - 캐시 무효화 전략이 정의됨
  - 조회 성능이 개선됨
  - 캐시 히트율이 모니터링됨

**WI-19: 프롬프트 템플릿 변경 로깅 및 감사**
- Assignee: Senior Backend Engineer (Developer-Charlie)
- Description: 프롬프트 템플릿 변경 이력을 로깅하고 감사하는 시스템 구현. 누가, 언제, 무엇을 변경했는지 추적.
- Files: `entities/prompt-change-log.entity.ts`
- Dependencies: WI-16
- Estimated Effort: 4-5 hours
- Acceptance Criteria:
  - 변경 이력이 DB에 저장됨
  - 사용자 정보가 기록됨
  - 변경 전후 내용이 저장됨
  - 감사 로그 조회 API가 구현됨

#### Group F: Testing (P2)
**병렬 실행 가능 (각 대상 완료 후)**

**WI-20: 단위 테스트 - 프롬프트 템플릿 서비스**
- Assignee: Junior Backend Engineer (Developer-Delta) 또는 QA
- Description: PromptTemplateRegistry, PromptMergeService의 단위 테스트 작성. 템플릿 조회, 병합, 변수 치환 등의 핵심 로직 테스트.
- Files:
  - `services/prompt-template-registry.service.spec.ts`
  - `services/prompt-merge.service.spec.ts`
- Dependencies: WI-12
- Estimated Effort: 4-5 hours
- Acceptance Criteria:
  - *.spec.ts 파일이 존재함
  - 테스트 커버리지가 80% 이상임
  - 모든 핵심 로직이 테스트됨
  - 테스트가 통과함

**WI-21: 단위 테스트 - 프롬프트 템플릿 컨트롤러**
- Assignee: Junior Backend Engineer (Developer-Delta) 또는 QA
- Description: PromptTemplateController의 단위 테스트 작성. API 엔드포인트, DTO 유효성 검증, 응답 포맷 테스트.
- Files: `controllers/prompt-template.controller.spec.ts`
- Dependencies: WI-14
- Estimated Effort: 3-4 hours
- Acceptance Criteria:
  - prompt-template.controller.spec.ts 파일이 존재함
  - 모든 엔드포인트가 테스트됨
  - DTO 검증 로직이 테스트됨
  - 테스트가 통과함

**WI-22: 통합 테스트 - Role과 Hollon 프롬프트 통합**
- Assignee: Senior Backend Engineer (Developer-Charlie) 또는 QA
- Description: Role과 Hollon 서비스가 새 프롬프트 시스템과 정상적으로 통합되었는지 E2E 테스트 작성. 전체 플로우 테스트.
- Files: `e2e/prompt-template-integration.spec.ts`
- Dependencies: WI-12
- Estimated Effort: 5-6 hours
- Acceptance Criteria:
  - E2E 테스트 파일이 존재함
  - Role 생성 플로우가 테스트됨
  - Hollon 생성 플로우가 테스트됨
  - 프롬프트 병합이 정상 작동함
  - 테스트가 통과함

#### Group G: Documentation & Deployment (P3-P1)
**최종 단계**

**WI-23: 프롬프트 템플릿 관리 문서 작성**
- Assignee: Junior Backend Engineer (Developer-Delta)
- Description: 프롬프트 템플릿 시스템의 사용 방법, 아키텍처, API 문서 작성. 새 Role 추가 방법, 변수 사용법, 커스터마이징 가이드 포함.
- Files: `docs/prompt-template-system.md`
- Dependencies: WI-12
- Estimated Effort: 4-5 hours
- Acceptance Criteria:
  - docs/prompt-template-system.md 파일이 존재함
  - 아키텍처 다이어그램이 포함됨
  - API 엔드포인트가 문서화됨
  - 새 Role 추가 가이드가 작성됨
  - 변수 사용 예시가 포함됨

**WI-24: 프로덕션 배포 및 모니터링 설정**
- Assignee: DevOps 또는 Senior Engineer
- Description: 새 프롬프트 시스템을 프로덕션에 배포하고 모니터링 설정. 배포 후 검증, 로그 모니터링, 알림 설정 포함.
- Files: 배포 스크립트, 모니터링 설정
- Dependencies: WI-22
- Estimated Effort: 3-4 hours
- Acceptance Criteria:
  - 프로덕션 배포가 완료됨
  - 배포 후 검증이 수행됨
  - 로그 모니터링이 설정됨
  - 에러 알림이 작동함
  - 롤백 계획이 준비됨

### Dependencies Graph

```
Phase 1: Foundation
WI-1 (Interface)
  └─> WI-2 (Registry)
       └─> WI-3 (Merge)
            └─> WI-4 (Module)

Phase 2: Templates (병렬)
WI-4 ─┬─> WI-5 (CTO/TechLead)
      ├─> WI-6 (AI/Infra Lead)
      ├─> WI-7 (Engineers)
      ├─> WI-8 (Other Roles)
      └─> WI-9 (Specialized)

Phase 3: Integration (순차)
[WI-5,6,7,8,9] ─┬─> WI-10 (Role Service)
                └─> WI-11 (Hollon Service)
                     └─> WI-12 (Seed Data)

Phase 4: API (병렬)
WI-4 ─> WI-13 (DTOs)
         └─> WI-14 (Controller)
              └─> WI-15 (Preview)

Phase 5: Advanced (병렬)
WI-12 ─┬─> WI-16 (Versioning)
       ├─> WI-17 (Validation)
       ├─> WI-18 (Caching)
       └─> WI-19 (Audit Log)

Phase 6: Testing (병렬)
WI-12 ─┬─> WI-20 (Service Tests)
WI-14 ─┼─> WI-21 (Controller Tests)
WI-12 ─└─> WI-22 (E2E Tests)

Phase 7: Final
WI-12 ─> WI-23 (Documentation)
WI-22 ─> WI-24 (Deployment)
```

### Execution Strategy

**Sprint 1 (Week 1): Foundation & Core Templates**
- WI-1, WI-2, WI-3, WI-4 (순차)
- WI-5, WI-6 (병렬)
- Goal: 기본 인프라와 주요 Role 템플릿 완성

**Sprint 2 (Week 2): Templates & Integration**
- WI-7, WI-8, WI-9 (병렬)
- WI-10, WI-11, WI-12 (순차)
- Goal: 모든 템플릿 완성 및 기존 서비스 통합

**Sprint 3 (Week 3): API & Testing**
- WI-13, WI-14, WI-15 (순차)
- WI-20, WI-21, WI-22 (병렬)
- Goal: API 완성 및 테스트 커버리지 확보

**Sprint 4 (Week 4): Advanced & Production**
- WI-16, WI-17, WI-18, WI-19 (병렬)
- WI-23 (문서화)
- WI-24 (배포)
- Goal: 고급 기능 완성 및 프로덕션 배포

## Success Criteria

### Functional Criteria
- [ ] 모든 Role에 대한 프롬프트 템플릿이 코드로 구현됨
- [ ] PromptTemplateRegistry가 모든 템플릿을 등록하고 조회 가능함
- [ ] PromptMergeService가 DB 커스텀 프롬프트와 코드 템플릿을 정확히 병합함
- [ ] 변수 치환 기능이 정상 작동함 ({{변수명}} 형식)
- [ ] RoleService와 HollonService가 새 프롬프트 시스템을 사용함
- [ ] seed.ts에서 systemPrompt 하드코딩이 제거됨
- [ ] 기존 Role/Hollon 생성 기능이 정상 작동함

### Non-Functional Criteria
- [ ] 템플릿 조회 성능이 최적화됨 (캐싱 적용)
- [ ] 테스트 커버리지 80% 이상
- [ ] 모든 단위 테스트 및 통합 테스트 통과
- [ ] API 엔드포인트가 문서화됨
- [ ] 프롬프트 변경 이력이 추적됨
- [ ] 에러 처리 및 로깅이 적절히 구현됨

### Technical Criteria
- [ ] TypeScript strict 모드 준수
- [ ] NestJS 모듈 패턴 준수
- [ ] class-validator를 사용한 DTO 검증
- [ ] 적절한 에러 핸들링 (NotFoundException 등)
- [ ] Repository 패턴 유지
- [ ] 코드 스타일 일관성 (린트 통과)

### Business Criteria
- [ ] 새 Role 추가 시 템플릿만 추가하면 됨 (확장성)
- [ ] DB 마이그레이션 없이 프롬프트 변경 가능
- [ ] 프롬프트 버전 관리 및 롤백 가능
- [ ] 감사 로그로 변경 추적 가능
- [ ] 프로덕션 배포 완료 및 정상 운영

### Integration Criteria
- [ ] AppModule에 PromptTemplateModule이 통합됨
- [ ] 기존 모듈(Role, Hollon)과의 통합이 완료됨
- [ ] 데이터베이스 스키마 변경 없이 작동함 (기존 systemPrompt 필드 활용)
- [ ] 기존 API 엔드포인트가 영향받지 않음
- [ ] 새 API 엔드포인트가 추가됨

---

## Implementation Notes

### Code Style Guidelines
- 모든 서비스는 @Injectable() 데코레이터 사용
- 인터페이스 이름은 I로 시작 (IPromptTemplate)
- 파일명은 kebab-case (prompt-template.service.ts)
- 클래스명은 PascalCase (PromptTemplateService)
- 상수는 UPPER_SNAKE_CASE
- 비공개 속성은 private readonly로 선언

### Testing Guidelines
- 각 서비스는 .spec.ts 파일에 단위 테스트
- 컨트롤러는 요청/응답 포맷 테스트
- E2E 테스트는 전체 플로우 검증
- Mock은 createMock() 사용
- 테스트는 AAA 패턴 (Arrange, Act, Assert)

### Git Commit Convention
```
feat: Add PromptTemplateRegistry service
test: Add unit tests for PromptMergeService
refactor: Extract variable substitution logic
docs: Add prompt template system documentation
fix: Resolve template caching issue
```

### PR Guidelines
- 각 Work Item은 별도 PR로 제출
- PR 제목: [WI-번호] Work Item 제목
- PR 본문에 Acceptance Criteria 체크리스트 포함
- 테스트 통과 확인 후 제출
- 최소 1명 이상의 리뷰어 승인 필요

---

*Generated by: PlanningSpecialist*
*Date: 2026-01-08T15:49:00.102Z*
*Status: PENDING_REVIEW*
