# Implementation Plan: Backend Engineering: ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì½”ë“œ ê´€ë¦¬ ì‹œìŠ¤í…œ êµ¬ì¶•

> Auto-generated by Hollon Planning Orchestrator (Phase 4.3)
> Generated at: 2026-01-09T03:09:43.601Z

## Executive Summary

This plan was created through multi-perspective analysis by 2 specialists.

### Analysis Status

âš ï¸ 1 analysis(es) failed: QualityAnalyst

---

## ðŸ—ï¸ Architecture Analysis

Perfect! I have collected sufficient information for the architectural analysis. Let me now provide a comprehensive analysis report.

## Summary

This project aims to build a **System Prompt Code Management System** to extract hardcoded system prompts from database seed files and Role/Hollon entities into a maintainable, templated, version-controlled codebase structure. The system will support variable substitution, fallback mechanisms (DB overrides code templates), versioning, caching, and API endpoints for runtime retrieval and management.

The architecture involves creating a new NestJS module (`prompt-templates`) that centralizes prompt management, integrates with existing Role and Hollon entities, and provides a service layer with template composition, variable substitution, and DB/code merging capabilities.

## Key Findings

### 1. **Current System Architecture**
- **NestJS Monorepo**: Uses pnpm workspaces with Turbo for build orchestration
- **Database**: PostgreSQL with TypeORM, strict TypeScript mode
- **Module Pattern**: Well-established NestJS conventions (module/service/controller/entity/dto structure)
- **Existing Entities**:
  - `Role.systemPrompt` (text field, nullable) - stores role-level prompts
  - `Hollon.systemPrompt` (text field, nullable) - stores instance-level prompt overrides
- **Current Prompt Usage**:
  - Seed file (`seed.ts`) contains extensive hardcoded system prompts (10+ roles with Korean + English mixed content)
  - `PromptComposerService` already exists for 6-layer prompt composition (organization â†’ team â†’ role â†’ hollon â†’ memory â†’ task)
  - Prompts are retrieved via `role.systemPrompt` and `hollon.systemPrompt` fields
  - Used throughout orchestration layer for AI agent execution

### 2. **Design Pattern Opportunities**
- **Template Method Pattern**: For variable substitution engine
- **Strategy Pattern**: For fallback mechanisms (DB-first vs code-first)
- **Repository Pattern**: Already in use with TypeORM, can extend for template storage
- **Factory Pattern**: For creating prompt instances from templates + variables
- **Decorator Pattern**: For enriching base templates with context layers
- **Builder Pattern**: For composing complex prompts from multiple template fragments

### 3. **Modularity & Coupling Analysis**
**Current Coupling Points:**
- `Role` entity is tightly coupled with `Hollon`, `Organization`
- `PromptComposerService` depends on multiple repositories (Hollon, Task, Document)
- Orchestration services directly access `role.systemPrompt` and `hollon.systemPrompt`

**Recommended Decoupling Strategy:**
- Introduce `PromptTemplateService` as a **single source of truth** for all system prompts
- Existing services should call `PromptTemplateService.getPromptForRole(roleId)` instead of direct field access
- Keep DB fields (`systemPrompt`) for backward compatibility but deprecate direct usage
- Use Dependency Injection to inject template service into existing services

### 4. **Scalability Considerations**
**Current Bottlenecks:**
- Hardcoded prompts in seed.ts make updates require database migrations
- No versioning â†’ risk of regression when prompts change
- No caching â†’ repeated DB queries for same prompts
- No auditability â†’ cannot track who changed what prompt when

**Scalability Improvements:**
- **Caching Layer**: Use NestJS Cache Manager (Redis-backed) for frequently accessed templates
- **Read-Heavy Optimization**: Templates change rarely but are read constantly â†’ aggressive caching (TTL: 1 hour+)
- **Version Control**: Git-based versioning for code templates + DB table for version history
- **Horizontal Scaling**: Stateless template service can scale across multiple instances with shared cache

### 5. **Technical Debt Assessment**
**New Technical Debt Introduced:**
- **Migration Complexity**: Dual-system maintenance during transition (DB + code templates)
- **Data Consistency**: Risk of drift between code templates and DB overrides
- **Testing Overhead**: Need comprehensive test coverage for template substitution edge cases
- **Documentation Burden**: Must document template syntax, variable conventions, versioning rules

**Technical Debt Reduced:**
- **Eliminates hardcoded prompts**: Centralized management in code instead of scattered in seed files
- **Improves maintainability**: Prompts become reviewable, version-controlled code
- **Reduces coupling**: Services depend on abstraction (TemplateService) instead of concrete DB fields
- **Enables automation**: Template changes can trigger CI/CD pipelines for validation

## Recommendations

### 1. **Architecture Patterns**
```
Recommended Layer Structure:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Controllers (REST API for CRUD operations)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PromptTemplateService (Orchestration Layer)    â”‚
â”‚  - getPromptForRole(roleId, variables?)         â”‚
â”‚  - getPromptForHollon(hollonId, variables?)     â”‚
â”‚  - mergeTemplateWithDB(template, dbOverride)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Template       â”‚   â”‚ Variable Substitution     â”‚
â”‚ Repository     â”‚   â”‚ Engine                    â”‚
â”‚ (Code Files)   â”‚   â”‚ - Mustache/Handlebars     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cache Layer (Redis/In-Memory)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. **Phased Implementation Strategy**

**Phase 1: Foundation (P1 Items 1-7)**
- Work Items: 1, 2, 3, 4, 5, 6, 7
- Create module structure, type definitions, basic service
- Extract seed.ts prompts into template files
- Implement variable substitution engine
- **Risk Mitigation**: Start with read-only operations, no DB writes yet

**Phase 2: Integration (P1 Items 8, 13, 14)**
- Work Items: 8, 13, 14
- Implement DB/code merge logic
- Refactor Role and Hollon entities to use TemplateService
- Add backward compatibility layer
- **Risk Mitigation**: Feature flag to toggle new system on/off

**Phase 3: API & Migration (P1-P2 Items 9, 10, 16, 17, 18)**
- Work Items: 9, 10, 16, 17, 18
- Build REST API endpoints
- Write comprehensive tests
- Create migration scripts from seed.ts
- **Risk Mitigation**: Run in shadow mode (both systems in parallel) before cutover

**Phase 4: Advanced Features (P2-P3 Items 11, 12, 15, 19-23)**
- Work Items: 11, 12, 15, 19, 20, 21, 22, 23
- Add versioning, history tracking, caching
- Build CLI tools, monitoring, documentation
- Final QA and performance optimization

### 3. **Specific Technical Recommendations**

**Template Engine Choice:**
- **Option A**: Handlebars.js (rich features, logic-less, well-tested)
- **Option B**: Mustache (simpler, more portable, less features)
- **Option C**: Custom regex-based ({{variable}} pattern) - RECOMMENDED for simplicity and control
  - Pros: No external dependency, full control over syntax, easy to debug
  - Cons: Must implement nested object access manually

**Caching Strategy:**
```typescript
// Recommended TTL values
- Role templates: 1 hour (rarely change)
- Hollon-specific overrides: 5 minutes (may change during development)
- Composed prompts: No cache (always fresh with latest context)
```

**Database Schema for Versioning:**
```sql
CREATE TABLE prompt_template_versions (
  id UUID PRIMARY KEY,
  role_id UUID REFERENCES roles(id),
  version VARCHAR(20), -- Semantic versioning (1.2.3)
  content TEXT,
  variables JSONB, -- Available variables for this version
  created_by UUID, -- Audit trail
  created_at TIMESTAMP,
  is_active BOOLEAN DEFAULT false
);
```

**API Design:**
```
GET    /prompt-templates/roles/:roleId          â†’ Get active template for role
GET    /prompt-templates/hollons/:hollonId      â†’ Get composed prompt for hollon
POST   /prompt-templates/roles/:roleId/versions â†’ Create new version
GET    /prompt-templates/roles/:roleId/history  â†’ Get version history
PUT    /prompt-templates/roles/:roleId/rollback â†’ Rollback to previous version
```

### 4. **Integration with Existing Systems**

**PromptComposerService Integration:**
```typescript
// BEFORE (direct field access):
const rolePrompt = hollon.role.systemPrompt;

// AFTER (via TemplateService):
const rolePrompt = await this.promptTemplateService.getPromptForRole(
  hollon.roleId, 
  { organizationName: hollon.organization.name }
);
```

**Backward Compatibility Layer:**
- Keep `Role.systemPrompt` and `Hollon.systemPrompt` fields
- Add virtual getter that calls TemplateService internally
- Deprecate direct writes to these fields
- Plan DB field removal in next major version

### 5. **Testing Strategy**

**Unit Tests (Work Item 16):**
- Variable substitution with various input types
- Missing variable handling (error vs default value)
- Nested object access (`{{user.profile.name}}`)
- Template parsing edge cases (malformed syntax)
- DB/code merge logic (all combination scenarios)

**Integration Tests (Work Item 17):**
- End-to-end API flows (create â†’ read â†’ update â†’ delete)
- Cache invalidation on template updates
- Version rollback scenarios
- Migration script validation (seed.ts â†’ templates)
- Concurrent access patterns (race conditions)

**Performance Tests:**
- Load test: 1000 concurrent prompt retrievals
- Cache hit rate measurement (target: >95%)
- Template rendering latency (target: <10ms)
- DB query optimization (N+1 prevention)

## Risks & Concerns

### High Risk
1. **Data Migration Failure**
   - Risk: Loss or corruption of existing prompts during seed.ts migration
   - Mitigation: Backup DB before migration, validate each prompt after import, run in shadow mode first
   
2. **Breaking Changes to Existing Services**
   - Risk: Refactoring `role.systemPrompt` access breaks 50+ service files
   - Mitigation: Introduce abstraction layer first, deprecate old pattern gradually, comprehensive integration tests

3. **Performance Regression**
   - Risk: Template substitution adds latency to critical execution path
   - Mitigation: Aggressive caching, benchmark before/after, profile hot paths

### Medium Risk
4. **Version Control Complexity**
   - Risk: Semantic versioning rules confuse developers, version conflicts
   - Mitigation: Clear documentation, automated version bumping in CI/CD, linting rules

5. **DB/Code Drift**
   - Risk: DB overrides diverge from code templates, causing confusion
   - Mitigation: Regular audits, monitoring dashboard showing drift metrics, reconciliation scripts

6. **Variable Naming Collisions**
   - Risk: Template variables conflict with system-reserved keywords
   - Mitigation: Namespacing convention (e.g., `{{ctx.roleName}}`), validation at template creation

### Low Risk
7. **CLI Tool Adoption**
   - Risk: Developers don't use CLI, continue manual DB edits
   - Mitigation: Integrate into existing workflows, provide VS Code extension, good UX

8. **Internationalization (i18n) Complexity**
   - Risk: Current prompts mix Korean + English, template system may not handle well
   - Mitigation: Keep language-agnostic template structure, consider i18n library later (out of scope for v1)

## Estimated Effort

### Complexity: **HIGH**
- **Justification**: Touches core system (prompt composition), requires careful refactoring of 10+ modules, complex migration from seed.ts, versioning adds significant complexity, performance-critical code path

### Suggested Subtasks (by Phase)

**Phase 1: Foundation (2-3 weeks)**
1. âœ… Analyze seed.ts prompts and document patterns (3-5 days) - **Work Item 1**
2. âœ… Design directory structure and file naming conventions (1-2 days) - **Work Item 2**
3. âœ… Define TypeScript interfaces for templates (2-3 days) - **Work Item 3**
4. âœ… Extract Role prompts from seed.ts into template files (3-5 days) - **Work Item 4**
5. âœ… Build common prompt component library (2-3 days) - **Work Item 5**
6. âœ… Implement PromptTemplateService skeleton (2-3 days) - **Work Item 6**
7. âœ… Build variable substitution engine with tests (3-5 days) - **Work Item 7**

**Phase 2: Core Integration (2-3 weeks)**
8. âœ… Implement template/DB merge logic (5-7 days) - **Work Item 8**
9. âœ… Create API endpoints (GET operations) (3-5 days) - **Work Item 9**
10. âœ… Build DTOs with validation (2-3 days) - **Work Item 10**
11. âœ… Refactor Role entity integration (3-5 days) - **Work Item 13**
12. âœ… Refactor Hollon entity integration (3-5 days) - **Work Item 14**
13. âœ… Write unit tests (80%+ coverage) (5-7 days) - **Work Item 16**

**Phase 3: Migration & Testing (2 weeks)**
14. âœ… Write seed.ts migration script (3-5 days) - **Work Item 18**
15. âœ… Execute migration in staging environment (2-3 days)
16. âœ… Write integration tests (5-7 days) - **Work Item 17**
17. âœ… Implement caching strategy (3-5 days) - **Work Item 15**

**Phase 4: Advanced Features (2-3 weeks)**
18. âœ… Design versioning system (2-3 days) - **Work Item 11**
19. âœ… Implement history tracking (3-5 days) - **Work Item 12**
20. âœ… Build CLI tools (3-5 days) - **Work Item 19**
21. âœ… Write comprehensive documentation (3-5 days) - **Work Item 20**
22. âœ… Add monitoring/metrics (2-3 days) - **Work Item 21**
23. âœ… Enhance error handling & logging (2-3 days) - **Work Item 22**
24. âœ… Final QA and validation (3-5 days) - **Work Item 23**

**Total Estimated Duration**: 8-12 weeks (2-3 months)
**Team Size Recommendation**: 2-3 engineers (1 senior backend, 1 mid-level backend, 1 QA)
**Critical Path**: Items 1 â†’ 3 â†’ 7 â†’ 8 â†’ 13/14 â†’ 18 (must complete sequentially)
**Parallelizable**: Items 4/5, 9/10, 16/17, 19/20/21/22 (can work concurrently)

---

**Overall Assessment**: This is a **high-value, high-complexity** architectural improvement that will significantly enhance maintainability and scalability of the prompt management system. The phased approach with feature flags and shadow mode deployment minimizes risk. Strong test coverage and comprehensive documentation are essential for success.

---

## ðŸ’» Implementation Analysis

Perfect! I now have enough context to provide a comprehensive implementation analysis. Let me compile the findings:

## Implementation Analysis: System Prompt Code Management System

### Summary
This is a well-structured task to build a prompt template management system for the Hollon-AI platform. The system will extract hard-coded system prompts from the database seed file into a code-managed template system with TypeScript interfaces, version control, and integration with existing Role/Hollon entities. The project follows NestJS patterns and requires building a complete module with services, DTOs, APIs, caching, testing, and migration scripts.

### Key Findings

1. **Existing Infrastructure Assessment**
   - **NestJS Architecture**: Well-established patterns in `apps/server/src/modules/*` with consistent module structure (entity, service, controller, DTO, module.ts)
   - **Database**: PostgreSQL with TypeORM; BaseEntity pattern with UUID, createdAt, updatedAt
   - **Current Prompt Storage**: systemPrompt stored as TEXT column in both `Role` and `Hollon` entities (apps/server/src/modules/role/entities/role.entity.ts:27, apps/server/src/modules/hollon/entities/hollon.entity.ts:77)
   - **Seed Data**: Comprehensive role definitions with systemPrompts in apps/server/src/database/seed.ts (lines 93-481)
   - **Similar Module**: prompt-composer module exists but only has basic templating utility (templatePrompt method) - not a full template management system

2. **Code Organization Patterns**
   - Standard NestJS module structure: `entities/`, `dto/`, `services/`, `controllers/`, `module.ts`
   - DTOs use class-validator decorators (@IsString, @IsUUID, @MaxLength, etc.)
   - Services use @Injectable() with InjectRepository pattern
   - Exports via module.exports for dependency injection

3. **Dependencies Available**
   - NestJS core packages (@nestjs/common, @nestjs/core, @nestjs/typeorm)
   - TypeORM for ORM
   - class-validator, class-transformer for validation
   - Jest for testing
   - PostgreSQL driver (pg)
   - **NO caching library installed** - would need to add @nestjs/cache-manager

4. **Migration & Testing Patterns**
   - Migrations in `apps/server/src/migrations/` using TypeORM MigrationInterface
   - Unit tests follow `*.spec.ts` naming with mock repositories
   - Integration tests follow `*.integration-spec.ts` with full database setup
   - Test coverage expected at 80%+ (from jest.config collectCoverageFrom)

### Recommendations

1. **Implementation Approach**
   - **Phase 1 (P1 tasks)**: Core infrastructure - interfaces, basic templates, service structure, DB integration
   - **Phase 2 (P2 tasks)**: APIs, versioning, caching, documentation
   - **Phase 3 (P3 tasks)**: Advanced features - CLI, monitoring, performance optimization
   - Use incremental commits per file as seen in the Planning/Implementation workflow patterns

2. **Code Organization**
   ```
   apps/server/src/modules/prompt-templates/
   â”œâ”€â”€ interfaces/
   â”‚   â””â”€â”€ prompt-template.interface.ts
   â”œâ”€â”€ templates/
   â”‚   â”œâ”€â”€ common/
   â”‚   â”‚   â””â”€â”€ shared-components.ts
   â”‚   â””â”€â”€ roles/
   â”‚       â”œâ”€â”€ cto.template.ts
   â”‚       â”œâ”€â”€ tech-lead.template.ts
   â”‚       â””â”€â”€ backend-engineer.template.ts
   â”œâ”€â”€ dto/
   â”‚   â”œâ”€â”€ get-prompt-template.dto.ts
   â”‚   â””â”€â”€ update-prompt-template.dto.ts
   â”œâ”€â”€ entities/
   â”‚   â”œâ”€â”€ prompt-template.entity.ts (optional - for versioning)
   â”‚   â””â”€â”€ prompt-template-history.entity.ts
   â”œâ”€â”€ services/
   â”‚   â”œâ”€â”€ prompt-template.service.ts
   â”‚   â””â”€â”€ template-variable.service.ts
   â”œâ”€â”€ prompt-template.controller.ts
   â””â”€â”€ prompt-template.module.ts
   ```

3. **Dependencies to Add**
   - `@nestjs/cache-manager` and `cache-manager` for caching (if implementing task #15)
   - Optional: `handlebars` or `mustache` for advanced template engine (though basic `{{var}}` replacement is sufficient)

4. **Migration Path**
   - **Strategy**: Keep DB columns, overlay with code templates
   - Priority order: Code templates â†’ DB custom prompts (if present) â†’ Fallback to code
   - This allows gradual migration without breaking existing functionality
   - Migration script (task #18) should be idempotent and include rollback

5. **Effort Estimation**

**Complexity: MEDIUM-HIGH**

**Suggested Subtasks Breakdown:**

**P1 - Foundation (Critical Path):**
- Subtask 1.1: Analyze seed.ts and document current prompt structure (2-3 hours)
- Subtask 1.2: Define TypeScript interfaces for template system (1-2 hours)
- Subtask 1.3: Create directory structure and module boilerplate (1 hour)
- Subtask 1.4: Extract 3-5 Role templates as TypeScript constants (3-4 hours)
- Subtask 1.5: Build PromptTemplateService with basic CRUD (3-4 hours)
- Subtask 1.6: Implement template variable substitution engine (4-5 hours)
- Subtask 1.7: Build DB merge logic (code templates + DB values) (3-4 hours)
- Subtask 1.8: Integrate with Role entity (2-3 hours)
- Subtask 1.9: Integrate with Hollon entity (2-3 hours)
- Subtask 1.10: Write unit tests for core service (4-5 hours)
- Subtask 1.11: Create migration script for data preservation (3-4 hours)

**P2 - Enhancement:**
- Subtask 2.1: Design version control schema (2-3 hours)
- Subtask 2.2: Extract common prompt components library (3-4 hours)
- Subtask 2.3: Build REST API endpoints (2-3 hours)
- Subtask 2.4: Create DTOs with validation (2 hours)
- Subtask 2.5: Implement caching strategy (install dependencies + implementation, 4-5 hours)
- Subtask 2.6: Write integration tests (4-5 hours)
- Subtask 2.7: Write documentation (README, API docs, examples) (3-4 hours)

**P3 - Polish:**
- Subtask 3.1: Implement version history tracking (4-5 hours)
- Subtask 3.2: Build CLI tool for template management (4-6 hours)
- Subtask 3.3: Add performance monitoring/metrics (3-4 hours)
- Subtask 3.4: Enhance error handling and logging (2-3 hours)
- Subtask 3.5: Final QA and end-to-end testing (3-4 hours)

**Total Estimate: 60-80 developer hours**

### Risks & Concerns

**HIGH PRIORITY RISKS:**
1. **Template Variable Design Complexity**: Need to support nested objects, default values, and safe error handling for missing variables. The {{variable}} syntax is simple but may need escaping for edge cases.

2. **Backward Compatibility**: Existing code depends on Role.systemPrompt and Hollon.systemPrompt. ANY changes to how these are accessed could break the orchestration, task execution, and brain provider integration.
   - **Mitigation**: Use getter methods or computed properties; ensure transparent fallback to DB values

3. **Seed Data Migration**: 11 roles Ã— ~50-200 lines of prompt each = significant manual extraction work. Risk of copy-paste errors or losing context.
   - **Mitigation**: Automated extraction script; validation tests comparing old vs new prompts

4. **Caching Invalidation**: If caching is implemented (task #15), must ensure cache is invalidated when:
   - DB systemPrompt is updated
   - Code templates change (requires app restart or cache clear)

**MEDIUM PRIORITY RISKS:**
5. **Version Control Complexity**: Semantic versioning for prompts is subjective. What constitutes a major vs minor change?
   - **Mitigation**: Start simple with incrementing integers; defer semantic versioning to Phase 2

6. **Testing Coverage**: 80% coverage target is ambitious for a system with both code templates AND DB integration
   - **Mitigation**: Focus unit tests on service logic; integration tests on E2E flows

**LOW PRIORITY RISKS:**
7. **Performance Impact**: Template substitution on every Hollon task execution could add latency
   - **Mitigation**: Caching (task #15) mitigates this; benchmark before optimizing

8. **CLI Tool Scope Creep**: nest-commander can be complex; may not provide ROI vs manual file editing
   - **Mitigation**: Make CLI optional P3; can be deferred

### Architecture Recommendations

1. **Template Variable Engine**: Use simple regex replacement with error collection:
   ```typescript
   function substituteVariables(template: string, vars: Record<string, any>): { result: string, errors: string[] } {
     const errors: string[] = [];
     const result = template.replace(/\{\{(\w+(?:\.\w+)*)\}\}/g, (match, path) => {
       const value = getNestedValue(vars, path);
       if (value === undefined) {
         errors.push(`Missing variable: ${path}`);
         return match; // Keep placeholder
       }
       return String(value);
     });
     return { result, errors };
   }
   ```

2. **Merge Strategy**: 
   ```
   Priority: 
   1. Hollon.systemPrompt (if not null) - highest priority for individual customization
   2. Role.systemPrompt (if not null) - role-level customization
   3. Code template for Role - default template
   ```

3. **No New Entity Needed (Initially)**: For MVP (P1), keep templates as TypeScript constants. Only add PromptTemplate entity if version history (task #11-12) is implemented in P2.

4. **API Design**:
   ```
   GET /prompt-templates/roles/:roleId - Get compiled prompt for role
   GET /prompt-templates/hollons/:hollonId - Get compiled prompt for hollon
   GET /prompt-templates/roles/:roleId/raw - Get template without variable substitution
   ```

---

This analysis provides a clear roadmap for implementation. The project is well-scoped with manageable risks if tackled incrementally following the P1â†’P2â†’P3 priority structure outlined in the work items.

---

## Failed Analyses

### QualityAnalyst
Error: Brain execution timeout: 180000ms exceeded (actual: 180279ms)

---

## Metadata

- Task ID: a59c2fcf-1eaa-46cc-8818-2e2f0ccff399
- Task Type: team_epic
- Priority: P2
- Specialists Consulted: 3
- Successful Analyses: 2