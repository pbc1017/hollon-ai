# Implementation Plan: Backend Engineering: ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì½”ë“œ ê´€ë¦¬ ì‹œìŠ¤í…œ êµ¬ì¶•

> Auto-generated by Hollon Planning Orchestrator (Phase 4.3)
> Generated at: 2026-01-09T03:22:54.465Z

## Executive Summary

This plan was created through multi-perspective analysis by 1 specialists.

### Analysis Status

âš ï¸ 2 analysis(es) failed: ArchitectAnalyst, QualityAnalyst

---

## ðŸ’» Implementation Analysis

Perfect! Now I have a comprehensive understanding of the codebase. Let me provide my analysis:

---

### Summary

This task involves building a comprehensive system prompt template management system for the Hollon-AI platform. Currently, system prompts are hardcoded in `seed.ts` and stored as plain text in the `Role` and `Hollon` entities. The goal is to extract these prompts into a reusable template system with versioning, caching, and proper TypeScript typing while maintaining backward compatibility with the existing orchestration system that heavily relies on prompt composition.

### Key Findings

1. **Current System Prompt Architecture**:
   - System prompts are stored as `text` columns in both `Role` and `Hollon` entities (role.entity.ts:27-28, hollon.entity.ts:77-78)
   - ~11 roles are seeded with extensive Korean/English prompts in seed.ts (lines 89-584)
   - The orchestration system composes layered prompts (Organization â†’ Team â†’ Role â†’ Hollon â†’ Task) via `PromptComposerService`
   - Currently no template system - prompts are static strings

2. **Existing Infrastructure**:
   - âœ… `class-validator` and `class-transformer` already installed (package.json:49-50)
   - âŒ No caching library (`@nestjs/cache-manager` not found)
   - âœ… Standard NestJS module pattern well-established
   - âœ… TypeORM migrations in place
   - âœ… Jest testing infrastructure configured
   - âœ… Basic `prompt-composer` module exists but with stub implementations

3. **Integration Points**:
   - `PromptComposerService` in orchestration module reads `role.systemPrompt` and `hollon.systemPrompt` directly
   - No abstraction layer - direct database field access
   - Migration needed to avoid breaking existing prompt composition flow

4. **Code Organization Patterns**:
   - Modules follow structure: `entities/`, `dto/`, `services/`, `controllers/`
   - Services use `@Injectable()` and repository injection via `@InjectRepository()`
   - DTOs use class-validator decorators (`@IsString()`, `@IsOptional()`, etc.)
   - Base entity provides `id`, `createdAt`, `updatedAt` (base.entity.ts)

### Recommendations

1. **Implementation Approach**:
   - **Phase 1 (Foundation)**: Create new `prompt-templates` module with template storage, TypeScript interfaces, and basic CRUD
   - **Phase 2 (Migration)**: Build template engine with variable substitution (`{{variable}}` syntax)
   - **Phase 3 (Integration)**: Integrate with Role/Hollon entities via service layer (not direct DB changes initially)
   - **Phase 4 (Enhancement)**: Add versioning, caching, CLI tools

2. **Code Organization**:
   ```
   apps/server/src/modules/prompt-templates/
   â”œâ”€â”€ entities/
   â”‚   â”œâ”€â”€ prompt-template.entity.ts
   â”‚   â”œâ”€â”€ prompt-template-version.entity.ts
   â”‚   â””â”€â”€ prompt-template-history.entity.ts
   â”œâ”€â”€ templates/
   â”‚   â”œâ”€â”€ base/               # Common prompt components
   â”‚   â”œâ”€â”€ roles/              # Role-specific templates
   â”‚   â””â”€â”€ index.ts            # Export all templates
   â”œâ”€â”€ dto/
   â”‚   â”œâ”€â”€ create-template.dto.ts
   â”‚   â”œâ”€â”€ update-template.dto.ts
   â”‚   â”œâ”€â”€ get-template.dto.ts
   â”‚   â””â”€â”€ template-variable.dto.ts
   â”œâ”€â”€ interfaces/
   â”‚   â”œâ”€â”€ prompt-template.interface.ts
   â”‚   â””â”€â”€ template-context.interface.ts
   â”œâ”€â”€ services/
   â”‚   â”œâ”€â”€ prompt-template.service.ts
   â”‚   â”œâ”€â”€ template-engine.service.ts
   â”‚   â”œâ”€â”€ template-version.service.ts
   â”‚   â””â”€â”€ template-cache.service.ts
   â”œâ”€â”€ controllers/
   â”‚   â””â”€â”€ prompt-template.controller.ts
   â””â”€â”€ prompt-templates.module.ts
   ```

3. **Dependencies**:
   - **Add**: `cache-manager` (~5.x) and `@nestjs/cache-manager` for caching
   - **Add**: `handlebars` or stick with simple regex-based substitution (lighter)
   - **Already Available**: `class-validator`, `class-transformer`, `typeorm`, `@nestjs/*` core packages

4. **Migration Path**:
   - **Non-Breaking Strategy**: 
     - Keep existing `systemPrompt` columns in Role/Hollon tables
     - Add new service layer that checks template system first, falls back to DB
     - Gradually migrate seed.ts prompts to template files
   - **Database Migration**:
     - Add `prompt_templates` table with `role_id`, `template_content`, `version`, `variables` columns
     - Add `prompt_template_history` table for audit trail
     - Optional: Add `template_id` FK to Role/Hollon (nullable initially)

### Risks & Concerns

- **Breaking Changes**: Direct modification of Role/Hollon entities could break existing orchestration flow (high risk)
  - *Mitigation*: Use adapter pattern - service layer abstracts template vs DB prompt
  
- **Template Variable Complexity**: Complex nested objects and conditional logic can make templates hard to maintain
  - *Mitigation*: Start with simple `{{variable}}` syntax, add complexity incrementally
  
- **Caching Invalidation**: Stale cached templates could cause incorrect prompts
  - *Mitigation*: Cache invalidation on template updates, short TTL (5-10 min), cache versioning
  
- **Version Management Overhead**: Semantic versioning + rollback can be complex
  - *Mitigation*: Start with simple incremental versioning, add semantic versioning later
  
- **Data Migration Risk**: Moving ~11 role prompts from seed.ts to templates could introduce errors
  - *Mitigation*: Automated migration script with validation, side-by-side comparison testing
  
- **Performance**: Template rendering on every prompt composition could add latency
  - *Mitigation*: Pre-compile templates, aggressive caching, async rendering where possible

- **No Native Cache Manager**: Need to add dependency
  - *Mitigation*: Use in-memory cache-manager with Redis adapter option for production

### Estimated Effort

**Complexity**: **Medium-High**

This is a substantial refactoring that touches core system functionality (prompt generation) while requiring careful migration to avoid breaking existing behavior.

**Suggested Subtasks** (in priority order):

**Foundation (P1 - ~8-10 tasks)**:
1. Design and document TypeScript interfaces for template system (PromptTemplate, TemplateVariable, TemplateContext)
2. Create `prompt-templates` module with NestJS structure
3. Implement PromptTemplateService with basic CRUD operations
4. Build template variable substitution engine (regex-based, support `{{var}}`, `{{obj.prop}}`, `{{var:default}}`)
5. Extract common prompt components from seed.ts into TypeScript constants
6. Create Role template files (BackendEngineer, FrontendEngineer, etc.) as TypeScript/JSON
7. Database migration: Create `prompt_templates` and `prompt_template_history` tables
8. Write unit tests for template engine (variable substitution, missing vars, nested objects)

**Integration (P1 - ~6 tasks)**:
9. Implement template-DB merge logic in PromptTemplateService (DB override > template fallback)
10. Create adapter layer for Role/Hollon to use template system (backward compatible)
11. Update PromptComposerService to use new template service
12. Write integration tests for end-to-end prompt composition with templates
13. Create data migration script to move seed.ts prompts to template system
14. Update seed.ts to reference template system instead of hardcoded strings

**Enhancement (P2 - ~5 tasks)**:
15. Install and configure `@nestjs/cache-manager` with in-memory cache
16. Implement template caching in PromptTemplateService (cache key: roleId+version)
17. Add cache invalidation hooks on template updates
18. Create DTOs with class-validator (GetTemplateDto, UpdateTemplateDto, CreateTemplateDto)
19. Build REST API endpoints (GET/PUT /prompt-templates/:roleId)

**Versioning (P2-P3 - ~4 tasks)**:
20. Design version management schema (version number, changelog, created_at)
21. Implement TemplateVersionService with history tracking
22. Add version comparison and diff functionality
23. Build rollback mechanism (restore previous version)

**Tooling & Documentation (P3 - ~4 tasks)**:
24. Create CLI tool using nest-commander (list, get, add, update templates)
25. Write comprehensive documentation (README, API docs, architecture diagrams)
26. Add performance monitoring (track template render time, cache hit rate)
27. Final QA and validation (all tests pass, performance benchmarks met, prod-ready)

**Total**: ~23 tasks (matches work items provided)
**Estimated Time**: 3-4 weeks for full implementation with testing and documentation
**High Risk Areas**: Tasks 10, 11, 13 (integration/migration) - require careful testing

---

## Failed Analyses

### ArchitectAnalyst
Error: Brain execution timeout: 180000ms exceeded (actual: 180271ms)

### QualityAnalyst
Error: Brain execution timeout: 180000ms exceeded (actual: 180270ms)

---

## Metadata

- Task ID: a59c2fcf-1eaa-46cc-8818-2e2f0ccff399
- Task Type: team_epic
- Priority: P2
- Specialists Consulted: 3
- Successful Analyses: 1