# Implementation Plan: Backend Engineering: ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì½”ë“œ ê´€ë¦¬ ì‹œìŠ¤í…œ êµ¬ì¶•

> Auto-generated by Hollon Planning Orchestrator (Phase 4.3)
> Generated at: 2026-01-25T08:48:34.398Z

## Executive Summary

This plan was created through multi-perspective analysis by 2 specialists.

### Analysis Status

âš ï¸ 1 analysis(es) failed: QualityAnalyst

---

## ğŸ—ï¸ Architecture Analysis

Now let me synthesize my analysis based on the information gathered:

## Summary

This is an **architectural transformation** to externalize system prompts from the database into a code-managed template system. Currently, system prompts for Roles and Hollons are stored in the database and hardcoded in seed.ts, creating maintenance and versioning challenges. The proposed solution introduces a **Template Engine Pattern** with a 6-layer prompt composition system, variable substitution, and intelligent fallback mechanisms (code templates â†’ DB overrides).

## Key Findings

### 1. **Current Architecture Analysis**
- **Prompt Storage**: System prompts are currently stored in two places:
  - `Role.systemPrompt` (text field in `roles` table) - apps/server/src/modules/role/entities/role.entity.ts:25
  - `Hollon.systemPrompt` (text field in `hollons` table) - apps/server/src/modules/hollon/entities/hollon.entity.ts:69
  - Hardcoded values in `seed.ts` (200+ lines of prompt text)
  
- **Existing Prompt Infrastructure**: There are **TWO** prompt-related modules:
  - `apps/server/src/modules/prompt-composer/` - Appears to be a stub/skeleton service
  - `apps/server/src/modules/orchestration/services/prompt-composer.service.ts` - **Active implementation** with 6-layer composition system already in production
  
- **Current Composition System** (PromptComposerService in orchestration):
  - Implements 6-layer architecture: Organization â†’ Team â†’ Role â†’ Hollon â†’ Memory â†’ Task
  - `extractRoleContext()` reads `role.systemPrompt` from DB
  - `extractHollonContext()` reads `hollon.systemPrompt` from DB
  - Has memory caching logic (`MAX_MEMORY_CHARS = 8000`)
  - Supports review mode detection and special prompts

### 2. **Technology Stack Validation**
- âœ… NestJS 10.4.15 with TypeScript strict mode
- âœ… TypeORM 0.3.20 with PostgreSQL
- âœ… class-validator 0.14.1 for DTO validation
- âœ… Jest 29.7.0 for testing
- âœ… Existing caching pattern in `PRDiffCacheService` (Map-based LRU cache)
- âŒ **No NestJS Cache Manager** installed (cache-manager package not in dependencies)
- âœ… Migration infrastructure in place (`typeorm.config.ts`, 35+ migrations)

### 3. **Module Structure Assessment**
- 40 existing modules in `apps/server/src/modules/`
- `prompt-composer` module exists but is minimal/unused
- Naming conflict: Two services named `PromptComposerService`
- Opportunity to either:
  - Build in existing `prompt-composer` module (cleaner)
  - Create new `prompt-templates` module (task specification)

### 4. **Design Pattern Considerations**

**Positive Patterns:**
- **Repository Pattern**: Consistently used (RoleService, HollonService)
- **Service Layer**: Clean separation of concerns
- **DTO Validation**: class-validator decorators throughout
- **Dependency Injection**: Proper @Injectable() usage

**Anti-Patterns to Avoid:**
- **Duplication**: Two PromptComposerService classes
- **Tight Coupling**: Direct DB field access in prompt composition
- **Hardcoded Configuration**: Prompts in seed.ts

### 5. **Data Migration Complexity**
- 29 files use `systemPrompt` across the codebase
- seed.ts contains 8+ roles with extensive prompt text (300+ lines)
- Existing prompts have common patterns:
  - Role-based instructions ("ë‹¹ì‹ ì€ Senior Backend Engineerì…ë‹ˆë‹¤")
  - Responsibility lists ("ë‹¹ì‹ ì˜ ì„ë¬´:")
  - Code style guidelines
  - Testing requirements
- No existing versioning system for prompts

## Recommendations

### Architecture Design

1. **Use Existing `prompt-composer` Module**
   - Rename/deprecate the stub implementation
   - Build template system in this module (avoid new `prompt-templates/` module)
   - Maintains single responsibility and reduces module proliferation

2. **Template Storage Strategy: Code-First with DB Override**
   ```typescript
   // Recommended structure:
   apps/server/src/modules/prompt-composer/
   â”œâ”€â”€ templates/
   â”‚   â”œâ”€â”€ roles/
   â”‚   â”‚   â”œâ”€â”€ backend-engineer.template.ts
   â”‚   â”‚   â”œâ”€â”€ tech-lead.template.ts
   â”‚   â”‚   â””â”€â”€ index.ts
   â”‚   â”œâ”€â”€ common/
   â”‚   â”‚   â”œâ”€â”€ code-style.template.ts
   â”‚   â”‚   â””â”€â”€ testing-guidelines.template.ts
   â”‚   â””â”€â”€ index.ts
   â”œâ”€â”€ services/
   â”‚   â”œâ”€â”€ template-loader.service.ts
   â”‚   â”œâ”€â”€ template-variable.service.ts
   â”‚   â””â”€â”€ template-version.service.ts
   â”œâ”€â”€ entities/
   â”‚   â””â”€â”€ prompt-template-history.entity.ts
   â””â”€â”€ interfaces/
       â””â”€â”€ template.interface.ts
   ```

3. **Template Engine Pattern**
   ```typescript
   interface PromptTemplate {
     id: string;
     version: string;  // Semantic versioning
     content: string;
     variables: TemplateVariable[];
     metadata: {
       author: string;
       description: string;
       lastModified: Date;
     };
   }
   
   // Variable substitution: Support both simple {{var}} and nested {{obj.prop}}
   // Use TypeScript template literals for type safety
   ```

4. **Integration with Existing PromptComposerService**
   ```typescript
   // Current: extractRoleContext() reads role.systemPrompt directly
   // New: extractRoleContext() calls TemplateService
   
   private async extractRoleContext(role: Role): Promise<RoleContext> {
     const systemPrompt = await this.templateService.getPrompt(
       'role',
       role.name,
       role.systemPrompt // fallback to DB value
     );
     return { ...role, systemPrompt };
   }
   ```

5. **Caching Strategy: Two-Tier Cache**
   - **L1**: In-memory Map (like existing PRDiffCacheService)
   - **L2**: Database (template_history table)
   - Cache key: `{type}:{name}:{version}`
   - TTL: Long-lived (24h) since templates change infrequently
   - Invalidation: On template update via event emitter

6. **Version Management: Append-Only History**
   ```typescript
   // New entity: PromptTemplateHistory
   @Entity('prompt_template_history')
   class PromptTemplateHistory {
     @PrimaryGeneratedColumn('uuid')
     id: string;
     
     @Column()
     templateType: 'role' | 'hollon' | 'organization';
     
     @Column()
     templateName: string;
     
     @Column()
     version: string; // Semantic versioning
     
     @Column('text')
     content: string;
     
     @Column({ nullable: true })
     changedBy: string;
     
     @Column('jsonb', { nullable: true })
     changeReason: string;
     
     @CreateDateColumn()
     createdAt: Date;
   }
   ```

7. **Migration Strategy: Three-Phase Approach**
   - **Phase 1**: Create template system (shadow mode, DB still primary)
   - **Phase 2**: Migrate seed.ts â†’ templates, dual-write to both
   - **Phase 3**: Flip priority (templates primary, DB optional override)

8. **Template Variable Engine: Simple Regex with Type Safety**
   ```typescript
   // Use tagged template literals for compile-time validation
   const template = createTemplate<{ projectName: string; teamSize: number }>`
     You are working on {{projectName}} with a team of {{teamSize}} members.
   `;
   
   // Runtime: Simple regex replace with validation
   // Avoid complex template engines (Handlebars, Mustache) - YAGNI
   ```

### Modularity & Coupling

**High Cohesion Strategies:**
1. **Template Module Responsibilities** (Single Responsibility):
   - Template loading & parsing
   - Variable substitution
   - Version management
   - History tracking
   
2. **Orchestration Module Responsibilities** (Unchanged):
   - 6-layer prompt composition
   - Context extraction
   - Memory retrieval

3. **Loose Coupling via Interfaces**:
   ```typescript
   // Define port/adapter pattern
   export interface ITemplateProvider {
     getTemplate(type: string, name: string): Promise<PromptTemplate>;
     saveTemplate(template: PromptTemplate): Promise<void>;
   }
   
   // Code-based implementation
   class CodeTemplateProvider implements ITemplateProvider { ... }
   
   // Database implementation (for overrides)
   class DatabaseTemplateProvider implements ITemplateProvider { ... }
   
   // Composite (fallback chain)
   class CompositeTemplateProvider implements ITemplateProvider {
     constructor(
       private db: DatabaseTemplateProvider,
       private code: CodeTemplateProvider
     ) {}
     
     async getTemplate(type, name) {
       return await this.db.getTemplate(type, name) 
         ?? await this.code.getTemplate(type, name);
     }
   }
   ```

### Scalability Considerations

**Will Scale:**
- âœ… Templates as TypeScript constants (compiled, zero runtime cost)
- âœ… In-memory caching (100+ templates = ~1MB memory)
- âœ… Append-only history table (time-series, easy to partition)
- âœ… Role-based templates (8 roles currently, unlikely to exceed 50)

**Won't Scale (Future Concerns):**
- âš ï¸ No distributed cache (multi-instance NestJS) â†’ Add Redis in Phase 5
- âš ï¸ No template pre-compilation â†’ Consider build-time optimization later
- âš ï¸ Manual variable substitution â†’ Could optimize with template AST parsing

**Scalability Recommendations:**
1. Design for single-instance first (YAGNI)
2. Add cache metrics (hit rate, miss rate) for future optimization
3. Keep template size < 10KB each (current prompts ~2KB)
4. Use database indexes: `(template_type, template_name, version)`

### Technical Debt Implications

**Debt Reduction:**
- âœ… Removes hardcoded prompts from seed.ts
- âœ… Enables prompt versioning (currently impossible)
- âœ… Makes prompts testable (unit test templates)
- âœ… Reduces migration coupling (seed.ts changes require DB migration)

**New Debt Introduced:**
- âš ï¸ Two prompt systems during migration (Phases 1-3)
- âš ï¸ Potential naming conflicts (resolve existing duplicate PromptComposerService)
- âš ï¸ Template format lock-in (TypeScript constants â†’ harder to change)

**Debt Prevention:**
- Use feature flags for gradual rollout
- Write migration rollback scripts
- Document template format in TypeScript interfaces
- Add integration tests for DB â†’ Template migration

## Risks & Concerns

### High-Risk Items

1. **Naming Collision**: Two `PromptComposerService` classes will cause runtime errors
   - **Mitigation**: Rename stub service to `PromptTemplateService` or delete it
   
2. **Database Migration Data Loss**: Existing custom `systemPrompt` values in production could be lost
   - **Mitigation**: Add migration script to backup existing prompts to `prompt_template_history` table before cutover
   
3. **Performance Regression**: Template loading + variable substitution adds latency to prompt composition
   - **Mitigation**: Add caching (should reduce latency vs. DB queries), benchmark before/after
   
4. **Breaking Changes**: Existing code directly accesses `role.systemPrompt` field (29 files)
   - **Mitigation**: Keep DB field, populate it from templates (backward compatibility)

### Medium-Risk Items

5. **Template Variable Complexity**: Nested objects, conditionals, loops could lead to over-engineering
   - **Mitigation**: Start simple (flat {{variables}} only), add features only when needed

6. **Version Management Overhead**: Manual semantic versioning is error-prone
   - **Mitigation**: Use automated version bumping (minor for content, major for structure)

7. **Testing Complexity**: Need to test template engine, composition, and integration
   - **Mitigation**: Write unit tests for each layer independently

8. **CLI Tool Adoption**: Developers may not use the CLI, revert to direct DB edits
   - **Mitigation**: Make CLI optional, focus on code-first workflow

### Low-Risk Items

9. **Template Format Evolution**: May need to change template format later
   - **Mitigation**: Version the template schema itself

10. **Cache Invalidation Bugs**: Stale prompts after template updates
    - **Mitigation**: Use event-driven invalidation, add cache expiry

## Estimated Effort

### Complexity: **MEDIUM-HIGH**

**Factors Increasing Complexity:**
- 23 work items (large scope)
- Integration with existing 6-layer composition system
- Data migration from seed.ts (8+ roles, 300+ lines)
- Three-phase migration strategy required
- 29 files reference systemPrompt (potential refactoring)

**Factors Decreasing Complexity:**
- Well-defined existing architecture (NestJS patterns)
- Clear acceptance criteria for each work item
- No new external dependencies needed (except possibly cache-manager)
- TypeScript type safety reduces runtime errors

### Suggested Subtask Grouping

**Sprint 1: Foundation (P1, 5 days)**
1. âœ… Resolve naming conflict: Rename/remove stub PromptComposerService
2. âœ… Design template interfaces (PromptTemplate, TemplateVariable)
3. âœ… Extract existing prompts from seed.ts into documentation
4. âœ… Create directory structure in `prompt-composer/templates/`
5. âœ… Implement basic TemplateLoaderService (no variables yet)

**Sprint 2: Template Engine (P1, 5 days)**
6. âœ… Implement variable substitution engine ({{variable}} format)
7. âœ… Create common prompt components library (code style, testing guidelines)
8. âœ… Convert seed.ts roles to TypeScript template files
9. âœ… Write unit tests for template engine (80% coverage)
10. âœ… Implement template validation logic

**Sprint 3: Integration (P1, 5 days)**
11. âœ… Create CompositeTemplateProvider (code + DB fallback)
12. âœ… Integrate with existing PromptComposerService.extractRoleContext()
13. âœ… Integrate with existing PromptComposerService.extractHollonContext()
14. âœ… Add in-memory caching (Map-based LRU)
15. âœ… Create migration script: backup existing DB prompts

**Sprint 4: Versioning & History (P2, 4 days)**
16. âœ… Create PromptTemplateHistory entity
17. âœ… Implement version management service (semantic versioning)
18. âœ… Implement history tracking (append-only log)
19. âœ… Create REST API for template CRUD

**Sprint 5: Testing & Tooling (P2-P3, 5 days)**
20. âœ… Write integration tests (full prompt composition flow)
21. âœ… Implement CLI tool (list, get, add commands)
22. âœ… Add performance monitoring (cache hit rate, latency)
23. âœ… Create comprehensive documentation (README, API docs, architecture diagrams)

**Sprint 6: QA & Migration (P1, 3 days)**
24. âœ… Run full test suite (unit + integration + e2e)
25. âœ… Execute three-phase migration (shadow â†’ dual-write â†’ cutover)
26. âœ… Performance benchmarking (before/after comparison)
27. âœ… Final QA and production readiness check

**Total Estimated Duration: 27 days (5.4 weeks) for 1 engineer**

### Recommended Parallelization

- **Backend Engineer** (Work Items 1-15): Foundation, engine, integration
- **Junior Engineer** (Work Items 20-23): Testing, tooling, documentation
- **Data Engineer** (Work Items 16-19, 25): Versioning, migration scripts

**Parallel Execution: ~18 days (3.6 weeks) with 2-3 engineers**

---

## Final Recommendation

**Proceed with caution.** This is a well-scoped architectural improvement with clear benefits (maintainability, versioning, testability), but execution risk is medium-high due to:
1. Need to resolve existing naming conflicts
2. Complex three-phase migration required
3. 29 files potentially affected
4. Must maintain backward compatibility during transition

**Success Criteria:**
- Zero downtime migration
- No prompt data loss
- <100ms latency increase for prompt composition
- 80%+ unit test coverage
- All 23 work items acceptance criteria met

**Go/No-Go Decision Points:**
- After Sprint 1: Validate template design with stakeholders
- After Sprint 3: Performance benchmark (if >200ms regression, optimize)
- Before Sprint 6: Staging environment validation (compare old vs. new prompts)

---

## ğŸ’» Implementation Analysis

Now I have comprehensive information. Let me provide my analysis:

### Summary

This task involves building a comprehensive system prompt code management system to externalize the hard-coded `systemPrompt` values currently stored in `seed.ts` into a modular, code-based template system. The system needs to replace database-stored prompts with code templates while maintaining backward compatibility, versioning, and providing a merge mechanism for custom overrides.

### Key Findings

1. **Current State Analysis**
   - `systemPrompt` is stored as a TEXT column in both `Role` and `Hollon` entities (apps/server/src/modules/role/entities/role.entity.ts:26, apps/server/src/modules/hollon/entities/hollon.entity.ts:81)
   - seed.ts contains 11 roles with extensive hardcoded systemPrompt strings (400+ lines each for specialized roles)
   - No existing prompt template infrastructure exists - PromptComposerModule is a placeholder with TODO implementations
   - Current usage: systemPrompt is accessed directly from entity properties and passed to brain providers (apps/server/src/modules/orchestration/services/hollon-orchestrator.service.ts:725, apps/server/src/modules/orchestration/services/task-execution.service.ts:1817)

2. **Architecture Patterns in Codebase**
   - NestJS standard module pattern: `*.module.ts`, `*.service.ts`, `*.controller.ts`, `dto/*.dto.ts`, `entities/*.entity.ts`
   - Dependency injection using `@Injectable()` and constructor injection
   - TypeORM for database operations with Repository pattern
   - Strict TypeScript mode enabled
   - class-validator for DTO validation
   - No existing caching infrastructure (no @nestjs/cache-manager)

3. **Existing Infrastructure**
   - PromptComposerModule exists but is empty (apps/server/src/modules/prompt-composer/)
   - Already has basic DTO structure for prompt composition
   - Has `templatePrompt()` method with {{variable}} substitution
   - Module already exported in AppModule

4. **Dataflow Pattern**
   - Roles define base systemPrompt
   - Hollons can override with instance-specific systemPrompt
   - Orchestrator reads from `hollon.role?.systemPrompt || hollon.systemPrompt`
   - Need to maintain this override hierarchy

5. **Migration Complexity**
   - 11 roles Ã— large prompts in seed.ts need to be extracted
   - Database schema must remain compatible (systemPrompt column preserved for custom overrides)
   - No downtime requirement implies careful rollout strategy

### Recommendations

1. **Implementation Approach**
   - **Phase 1**: Build template infrastructure first (services, interfaces, template engine)
   - **Phase 2**: Extract prompts to code templates (TypeScript constants in organized files)
   - **Phase 3**: Implement merge logic (code template + DB override)
   - **Phase 4**: Migrate seed.ts and integrate with existing services
   - **Phase 5**: Add versioning, caching, and management APIs

2. **Code Organization**
   ```
   apps/server/src/modules/prompt-templates/
   â”œâ”€â”€ templates/
   â”‚   â”œâ”€â”€ roles/
   â”‚   â”‚   â”œâ”€â”€ technical-lead.template.ts
   â”‚   â”‚   â”œâ”€â”€ backend-engineer.template.ts
   â”‚   â”‚   â”œâ”€â”€ planning-specialist.template.ts
   â”‚   â”‚   â””â”€â”€ [role-name].template.ts (11 files)
   â”‚   â”œâ”€â”€ common/
   â”‚   â”‚   â”œâ”€â”€ code-style.template.ts
   â”‚   â”‚   â”œâ”€â”€ testing-guidelines.template.ts
   â”‚   â”‚   â””â”€â”€ communication.template.ts
   â”‚   â””â”€â”€ index.ts
   â”œâ”€â”€ services/
   â”‚   â”œâ”€â”€ prompt-template.service.ts (core logic)
   â”‚   â”œâ”€â”€ template-engine.service.ts (variable substitution)
   â”‚   â””â”€â”€ template-cache.service.ts (optional caching)
   â”œâ”€â”€ interfaces/
   â”‚   â”œâ”€â”€ prompt-template.interface.ts
   â”‚   â””â”€â”€ template-variable.interface.ts
   â”œâ”€â”€ dto/
   â”‚   â”œâ”€â”€ get-prompt-template.dto.ts
   â”‚   â””â”€â”€ update-prompt-template.dto.ts
   â”œâ”€â”€ controllers/
   â”‚   â””â”€â”€ prompt-template.controller.ts (REST API)
   â”œâ”€â”€ entities/
   â”‚   â””â”€â”€ prompt-template-history.entity.ts (versioning)
   â””â”€â”€ prompt-template.module.ts
   ```

3. **Dependencies**
   - **No new external dependencies needed** - use existing NestJS stack
   - Optional: `@nestjs/cache-manager` + `cache-manager` for caching (can defer to P2/P3)
   - All template logic can be pure TypeScript

4. **Migration Path**
   ```
   Step 1: Create module structure (tasks 2, 3, 6)
   Step 2: Implement core services (tasks 7, 8)
   Step 3: Extract prompts to templates (tasks 4, 5)
   Step 4: Update Role/Hollon services to use templates (tasks 13, 14)
   Step 5: Migrate seed.ts (task 18)
   Step 6: Add APIs, testing, documentation (tasks 9-12, 16-17, 20-23)
   ```

5. **Backward Compatibility Strategy**
   - Keep `systemPrompt` column in DB (used for custom overrides)
   - Merge logic: DB value (if present) takes precedence over template
   - Fallback chain: `hollon.systemPrompt || role.systemPrompt || codeTemplate`
   - Ensure no breaking changes to existing Brain Provider calls

### Risks & Concerns

- **Risk 1: Template Variable Complexity** - Need robust variable substitution with validation. Missing variables could break prompts at runtime. *Mitigation: Use TypeScript types to enforce variable contracts, add validation layer*

- **Risk 2: Large Prompts in Code** - 11 roles with 400+ line prompts will create large TypeScript files. *Mitigation: Split into common components (task 5), use multi-line template literals*

- **Risk 3: Migration Script Data Loss** - seed.ts migration could corrupt existing systemPrompt data. *Mitigation: Backup data, dry-run testing, rollback mechanism (task 18)*

- **Risk 4: Performance Impact** - Template rendering on every prompt composition could slow down Brain Provider calls. *Mitigation: Add caching layer (task 15), measure performance before/after*

- **Risk 5: Version Management Overhead** - Tracking prompt versions adds complexity. *Mitigation: Start with simple Git-based versioning, defer advanced features to P2/P3*

- **Risk 6: No Existing Caching Infrastructure** - Would need to add @nestjs/cache-manager if caching is critical. *Mitigation: Implement simple in-memory cache first, upgrade later*

### Estimated Effort

**Complexity: High**

**Rationale**: 
- Large scope (23 work items)
- Critical system component (affects all Hollon executions)
- Complex merge logic with multiple priority layers
- Extensive testing required (unit, integration, migration)
- Documentation and developer tooling needed

**Suggested Subtask Breakdown**:

**Foundation (P1 - 5-6 tasks):**
1. Directory structure and TypeScript interfaces (2-3 hours)
2. Template engine with variable substitution (4-5 hours)
3. PromptTemplateService core implementation (5-6 hours)
4. Merge logic (template + DB) (4-5 hours)
5. Extract first 2-3 role templates as proof-of-concept (3-4 hours)

**Core Implementation (P1 - 8-9 tasks):**
6. Extract remaining 8 role templates (6-8 hours)
7. Common component library (3-4 hours)
8. Integrate with Role service (3-4 hours)
9. Integrate with Hollon service (3-4 hours)
10. seed.ts migration script with rollback (5-6 hours)
11. Unit tests for template engine (4-5 hours)
12. Unit tests for merge logic (3-4 hours)
13. Integration tests (5-6 hours)

**Enhancement & Polish (P2-P3 - 9-10 tasks):**
14. REST API endpoints (3-4 hours)
15. DTOs and validation (2-3 hours)
16. Caching strategy (4-5 hours)
17. Version management system (6-8 hours)
18. History tracking (4-5 hours)
19. CLI management tool (5-6 hours)
20. Comprehensive documentation (5-6 hours)
21. Performance monitoring (3-4 hours)
22. Enhanced error handling (3-4 hours)
23. Final QA and validation (6-8 hours)

**Total Estimated Effort: 90-110 hours (11-14 working days for one developer)**

**Critical Path:**
Tasks 1-10 must be completed sequentially for MVP. Tasks 11-23 can be parallelized or deferred to later phases.

---

## Failed Analyses

### QualityAnalyst
Error: Brain execution timeout: 180000ms exceeded (actual: 180859ms)

---

## Metadata

- Task ID: a59c2fcf-1eaa-46cc-8818-2e2f0ccff399
- Task Type: team_epic
- Priority: P2
- Specialists Consulted: 3
- Successful Analyses: 2